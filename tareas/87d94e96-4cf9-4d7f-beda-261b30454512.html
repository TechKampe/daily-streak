<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Telegram URL / Params Debug</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b1220; color: #e8f0ff;
    }
    header {
      padding: 14px 16px; position: sticky; top: 0; z-index: 10;
      background: #0f1630; border-bottom: 1px solid #1e2a4a;
    }
    h1 { margin: 0; font-size: 18px; }
    .status { margin-top: 6px; font-size: 12px; opacity: .9 }
    main { padding: 16px; display: grid; gap: 14px; }
    section { background: #101a33; border: 1px solid #223157; border-radius: 12px; }
    section > h2 { margin: 0; padding: 10px 12px; font-size: 14px; border-bottom: 1px solid #223157; }
    pre, .box {
      margin: 0; padding: 12px; font-size: 12px; line-height: 1.35;
      overflow: auto; white-space: pre-wrap; word-break: break-word;
    }
    .hint { opacity: .85; font-size: 12px; padding: 0 12px 12px; }
    .ok { color: #18e3a6; }
    .bad { color: #ff758c; }
    .btn {
      display: inline-block; margin: 8px 12px 12px; padding: 8px 12px; font-size: 12px;
      background: #1a274a; border: 1px solid #2a3e79; border-radius: 8px; cursor: pointer;
    }
  </style>
  <!-- Important: load Telegram WebApp script so tg.* exists inside Telegram -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <h1>Telegram URL / Params Debug</h1>
    <div id="status" class="status">Loading…</div>
  </header>

  <main>
    <section>
      <h2>Environment</h2>
      <pre id="env"></pre>
      <div class="hint">User-Agent, referrer and time.</div>
    </section>

    <section>
      <h2>Location</h2>
      <pre id="loc"></pre>
      <div class="hint">Full <code>href</code>, <code>pathname</code>, <code>search</code>, and <code>hash</code>.</div>
    </section>

    <section>
      <h2>Query Params (?…)</h2>
      <pre id="qp"></pre>
    </section>

    <section>
      <h2>Hash Params (#…)</h2>
      <pre id="hp"></pre>
    </section>

    <section>
      <h2>Telegram WebApp</h2>
      <pre id="tg"></pre>
      <div class="hint">
        <span class="ok">initData length &gt; 0</span> means you’re inside a WebApp launch that provides it.
        For <b>Game buttons in channels</b>, this will often be 0 by design.
      </div>
    </section>

    <section>
      <h2>Token “t” (decoded)</h2>
      <pre id="token"></pre>
      <button class="btn" id="copyPayload">Copy payload JSON</button>
      <div class="hint">
        This decodes the first part of <code>t</code> (base64url JSON) so you can verify fields like
        <code>phone_number</code>, <code>uid</code>, <code>task_id</code>, <code>exp</code>.
        Signature is shown so you can spot truncation.
      </div>
    </section>

    <section>
      <h2>Target param (optional)</h2>
      <pre id="target"></pre>
      <div class="hint">
        If you’re still using a redirector flow with <code>?target=…</code>, this shows the decoded target and how a token would be appended.
      </div>
    </section>
  </main>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.ready();

    const qs = new URLSearchParams(location.search);
    const hs = new URLSearchParams(location.hash.replace(/^#/, ""));

    // Helpers
    const $ = (id) => document.getElementById(id);
    const show = (id, obj) => { $(id).textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2); };
    const paramsToObj = (sp) => {
      const o = {};
      for (const [k, v] of sp.entries()) {
        if (k in o) o[k] = Array.isArray(o[k]) ? o[k].concat(v) : [o[k], v];
        else o[k] = v;
      }
      return o;
    };
    const b64urlToUtf8 = (s) => {
      if (!s) return null;
      let b64 = s.replace(/-/g, "+").replace(/_/g, "/");
      while (b64.length % 4) b64 += "=";
      try { return decodeURIComponent(escape(atob(b64))); } catch { return null; }
    };

    // Environment
    show("env", {
      time_iso: new Date().toISOString(),
      user_agent: navigator.userAgent,
      referrer: document.referrer || null,
      platform: tg?.platform || null,
    });

    // Location
    show("loc", {
      href: location.href,
      origin: location.origin,
      pathname: location.pathname,
      search: location.search,
      hash: location.hash
    });

    // Params
    const qObj = paramsToObj(qs);
    const hObj = paramsToObj(hs);
    show("qp", Object.keys(qObj).length ? qObj : "(none)");
    show("hp", Object.keys(hObj).length ? hObj : "(none)");

    // Telegram WebApp info
    const initLen = tg?.initData ? tg.initData.length : 0;
    show("tg", {
      present: !!tg,
      version: tg?.version || null,
      initData_length: initLen,
      initDataUnsafe: tg?.initDataUnsafe || null
    });

    // Token “t” decode
    const t = qs.get("t") || hs.get("t") || null;
    let payloadObj = null;
    if (t) {
      const [body, sig] = t.split(".", 2);
      const bodyJson = b64urlToUtf8(body);
      try { payloadObj = JSON.parse(bodyJson || "{}"); } catch { payloadObj = { parse_error: true, raw: bodyJson }; }

      show("token", {
        raw: t,
        body_b64url: body || null,
        signature_hex: sig || null,
        signature_len: sig ? sig.length : 0,
        payload: payloadObj
      });
    } else {
      show("token", "No query/hash param named 't'.");
    }

    $("copyPayload").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(payloadObj, null, 2));
        $("copyPayload").textContent = "Copied ✓";
        setTimeout(() => ($("copyPayload").textContent = "Copy payload JSON"), 1200);
      } catch {}
    });

    // Optional: target param (if using redirector flow)
    const target = qs.get("target") || hs.get("target");
    if (target) {
      const decoded = decodeURIComponent(target);
      const sep = decoded.includes("?") ? "&" : "?";
      show("target", {
        target_param: target,
        decoded,
        example_with_t: decoded + sep + "t=" + encodeURIComponent(t || "")
      });
    } else {
      show("target", "No 'target' param present.");
    }

    // Status banner
    $("status").innerHTML =
      `tg present: <b>${!!tg}</b> | initData length: <b>${initLen}</b> | token t present: <b>${!!t}</b>`;
  </script>
</body>
</html>
