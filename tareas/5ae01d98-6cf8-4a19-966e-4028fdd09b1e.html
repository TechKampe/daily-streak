<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0a5cff" />
  <title>Caza el Fallo: Taller Eléctrico ⚡</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* Reseteo y base */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }
    html, body { overflow: hidden; overscroll-behavior: none; }
    :root{
      --bg-1: #0a5cff;
      --bg-2: #0a4bd1;
      --bg-3: #082f8c;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.18);
      --stroke: rgba(255,255,255,0.35);
      --txt: #ffffff;
      --muted: #bfe2ff;
      --accent: #41d9ff;
      --accent-2: #a6ff82;
      --alert: #ff6e6e;
      --warning: #ffd56e;
      --btnH: 56px;
      --gap: 10px;
      --radius: 16px;
      --ui-scale: 1;
      --cellH: 64px; /* altura de opción por defecto */
      --cellAR: 6/1; /* relación aspecto (ancho/alto) para botones */
      --hudH: 72px;
      --titleSize: clamp(18px, 2.5vh, 22px);
      --sceneSize: clamp(15px, 2.1vh, 18px);
      --btnSize: clamp(14px, 2vh, 16px);
      --badgeSize: clamp(10px, 1.4vh, 12px);
      --progressH: 6px;
    }
    body.compact {
      --hudH: 60px;
      --titleSize: clamp(16px, 2.2vh, 18px);
      --sceneSize: clamp(14px, 1.9vh, 16px);
      --btnSize: clamp(13px, 1.8vh, 15px);
      --badgeSize: clamp(9px, 1.3vh, 11px);
      --cellH: 56px;
    }

    /* Fondo Fortnite-like */
    .bg{
      position: fixed; inset:0; z-index: -2;
      background: radial-gradient(120% 100% at 85% 10%, var(--bg-1) 0%, var(--bg-2) 45%, var(--bg-3) 100%);
    }
    .bg::after{
      /* brillos abstractos */
      content:""; position:absolute; inset:-10%;
      background:
        radial-gradient(180px 180px at 20% 10%, rgba(255,255,255,0.20), transparent 60%),
        radial-gradient(220px 220px at 80% 40%, rgba(65,217,255,0.25), transparent 70%),
        radial-gradient(260px 200px at 30% 80%, rgba(255,255,255,0.10), transparent 70%);
      filter: blur(8px);
      opacity: 0.8;
    }

    /* Avatar fantasma */
    .avatar {
      position: fixed; right: -10px; bottom: -10px; z-index: -1;
      width: min(45vw, 380px); opacity: 0.16; user-select:none; pointer-events:none;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,0.3));
    }

    /* Logo */
    .logo{
      height: 28px; width: auto; display: block;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.2));
    }

    /* Escena principal */
    .scene{
      position: relative;
      width: 100%;
      padding: max(10px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
      display: grid;
      grid-template-rows: var(--hudH) auto 1fr auto;
      gap: var(--gap);
      color: var(--txt);
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      transform-origin: top center;
      transform: scale(var(--ui-scale));
      touch-action: none;
    }
    @supports (height: 100svh) { .scene { height: 100svh; } }
    @supports not (height: 100svh) { .scene { height: 100dvh; } }
    @supports not (height: 100dvh) { .scene { height: 100vh; } }

    /* HUD */
    .hud{
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.10));
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 8px 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .hud .title{
      font-weight: 800; font-size: var(--titleSize); letter-spacing: 0.2px;
      text-shadow: 0 1px 0 rgba(0,0,0,0.3);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .progressWrap{
      display: grid; align-items: center; justify-items: end;
      gap: 6px;
    }
    .progressBar{
      width: 110px; height: var(--progressH); background: rgba(255,255,255,0.22); border-radius: 99px; overflow: hidden;
    }
    .progress{
      height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #5bffcc);
      box-shadow: 0 0 10px rgba(91,255,204,0.8);
    }
    .progressText{
      font-size: 12px; color: var(--muted);
    }

    /* Micro-escena */
    .story{
      display: grid; align-content: center; gap: 6px;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 10px 12px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      min-height: 68px;
    }
    .story .label{
      font-size: var(--sceneSize); font-weight: 600;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .hint{
      font-size: 12px; color: var(--muted);
      display: inline-flex; gap: 6px; align-items: center;
    }
    .hint .dot{ width: 6px; height: 6px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 6px rgba(65,217,255,0.75); }

    /* Opciones */
    .board{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-content: start;
    }
    .option{
      min-height: var(--cellH);
      display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 8px;
      padding: 10px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.10));
      border: 1px solid var(--stroke);
      border-radius: 14px;
      color: var(--txt);
      cursor: pointer; user-select: none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      outline: none;
      font-size: var(--btnSize);
    }
    .option:focus-visible{ box-shadow: 0 0 0 3px rgba(65,217,255,0.6); }
    .option:hover{ transform: translateY(-1px); }
    .option .badge{
      font-size: var(--badgeSize); font-weight: 700; color: #072b4a;
      padding: 6px 8px; border-radius: 999px;
      background: linear-gradient(180deg, #8ef3ff, #49d6ff);
      border: 1px solid rgba(0,0,0,0.1);
      text-transform: uppercase; letter-spacing: .4px;
    }
    .option .text{
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      line-height: 1.2;
    }
    .option.chosen{
      transform: translateY(-1px) scale(0.98);
    }
    .option.correct{
      border-color: rgba(134,255,172,0.9) !important;
      box-shadow: 0 0 0 2px rgba(134,255,172,0.6), inset 0 0 0 1px rgba(255,255,255,0.2);
      background: linear-gradient(180deg, rgba(134,255,172,0.22), rgba(134,255,172,0.14));
    }
    .option.wrong{
      border-color: rgba(255,110,110,0.9) !important;
      box-shadow: 0 0 0 2px rgba(255,110,110,0.6), inset 0 0 0 1px rgba(255,255,255,0.18);
      background: linear-gradient(180deg, rgba(255,110,110,0.22), rgba(255,110,110,0.12));
    }

    /* Footer mini */
    .footerMini{
      display: grid; grid-template-columns: 1fr auto; align-items: center;
      gap: 10px;
    }
    .statusBubble{
      font-size: 12px; color: var(--muted);
      background: rgba(255,255,255,0.12); border: 1px solid var(--stroke);
      padding: 8px 10px; border-radius: 12px;
      display: inline-flex; gap: 8px; align-items: center;
      min-height: 36px;
    }

    /* Toast feedback */
    .toast{
      position: fixed; left: 50%; top: calc(10px + env(safe-area-inset-top));
      transform: translateX(-50%) translateY(-30px);
      background: rgba(0,0,0,0.55); color: #fff; padding: 8px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      font-size: 13px; opacity: 0; transition: all .25s ease; pointer-events:none;
      backdrop-filter: blur(6px);
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Modales (intro y resultado) */
    .overlay{
      position: fixed; inset: 0; background: rgba(5,16,46,0.62); display: none; align-items: center; justify-content: center;
      padding: 16px; z-index: 50;
    }
    .overlay.show{ display: flex; }
    .modal{
      width: min(520px, 94vw);
      max-height: 90svh; overflow-y: auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.12));
      border: 1px solid var(--stroke); border-radius: 16px; color: var(--txt);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      padding: 16px;
      display: grid; gap: 12px;
    }
    .modal h2{ margin: 0; font-size: clamp(18px, 2.4vh, 22px); }
    .modal p{ margin: 0; font-size: 14px; color: var(--muted); line-height: 1.3; }
    .modal .cta{
      position: sticky; bottom: 0; padding-top: 8px; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.1) 40%);
      display: grid; gap: 8px;
    }
    .btn{
      min-height: 44px;
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px; padding: 10px 14px; border-radius: 12px;
      border: 0; cursor: pointer; font-weight: 800; letter-spacing: .3px;
      color: #071a2a; background: linear-gradient(180deg, #7cf0ff, #41d9ff);
      box-shadow: 0 6px 18px rgba(65,217,255,0.45);
      font-size: clamp(14px, 2.2vh, 16px);
    }
    .btn.alt{
      background: linear-gradient(180deg, #a8ff8c, #56f0a8);
      color: #062311;
    }
    .btn:focus-visible{ outline: 3px solid rgba(65,217,255,0.7); outline-offset: 2px; }

    .resultsList{
      display: grid; gap: 10px; margin-top: 4px;
    }
    .card{
      border: 1px solid var(--stroke); border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.10));
      padding: 10px; display: grid; gap: 6px;
    }
    .card .row{ display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: center; }
    .pill{
      font-size: 12px; color: #072b4a; background: linear-gradient(180deg,#8ef3ff,#49d6ff);
      padding: 6px 8px; border-radius: 999px; font-weight: 800; text-transform: uppercase;
    }
    .tag{
      font-size: 12px; padding: 4px 8px; border-radius: 999px; color: #052313;
      background: linear-gradient(180deg,#a8ff8c,#56f0a8); font-weight: 700;
    }
    .explain{
      font-size: 13px; color: #e9fbff;
    }

    /* Animación de transición escena */
    .fade-enter{ opacity: 0; transform: translateY(6px); }
    .fade-enter-active{ transition: all .22s ease; opacity: 1; transform: translateY(0); }
    .fade-exit{ opacity: 1; transform: translateY(0); }
    .fade-exit-active{ transition: all .16s ease; opacity: 0; transform: translateY(-6px); }

    /* Utilidades */
    .visually-hidden{ position:absolute !important; width:1px; height:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); clip-path: inset(50%); white-space:nowrap; border:0; padding:0; margin:-1px; }
    .muted{ color: var(--muted); }
    .warning{ color: var(--warning); font-size: 12px; }
  </style>
</head>
<body>
  <div class="bg"></div>
  <img class="avatar" src="https://techkampe.github.io/daily-streak/assets/Avatar%202_low.png" alt="" loading="eager" />
  <main id="app" class="scene" aria-live="polite" aria-label="Caza el Fallo: Taller Eléctrico">
    <!-- HUD -->
    <header class="hud" aria-label="Barra de progreso y título">
      <img src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe" class="logo" />
      <div class="title" title="Caza el Fallo: Taller Eléctrico">Caza el Fallo ⚡</div>
      <div class="progressWrap" aria-live="polite">
        <div class="progressBar" aria-hidden="true"><div class="progress" id="progressBar"></div></div>
        <div class="progressText" id="progressText">0/5</div>
      </div>
    </header>

    <!-- Historia breve -->
    <section class="story" id="storyBox">
      <div class="label" id="sceneText">...</div>
      <div class="hint"><span class="dot"></span><span>Detección de error: toca lo que está mal</span></div>
    </section>

    <!-- Opciones -->
    <section class="board" id="board" role="group" aria-label="Opciones de la escena">
      <!-- Botones generados por JS -->
    </section>

    <!-- Footer mini -->
    <footer class="footerMini">
      <div class="statusBubble" id="statusBubble" aria-live="polite">Elige el ítem incorrecto para avanzar</div>
      <div class="statusBubble muted" aria-hidden="true">Tipo: Error</div>
    </footer>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Intro -->
  <div class="overlay show" id="intro">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="introTitle">
      <h2 id="introTitle">Caza el Fallo: Taller Eléctrico ⚡</h2>
      <p id="introText">Eres aprendiz de electricidad en una reforma. En cada micro-escena hay 1 error: herramienta, acción o norma mal aplicada. Toca el ítem incorrecto para avanzar. Son 5 en total.</p>
      <div class="cta">
        <button class="btn" id="startBtn" aria-label="Empezar el reto">Empezar</button>
      </div>
    </div>
  </div>

  <!-- Resultados -->
  <div class="overlay" id="results">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
      <h2 id="resultsTitle">Resultado del reto</h2>
      <p id="scoreLine">Has resuelto 0/5 escenas.</p>

      <div class="resultsList" id="resultsList">
        <!-- Result cards via JS -->
      </div>

      <div class="card" style="margin-top:8px;">
        <div class="row"><span class="pill">Consejo práctico</span><span></span></div>
        <div class="explain">
          • Atención al detalle: revisa tapas, fundas y fijaciones. <br/>
          • Seguridad: señaliza, usa EPIs y evita superficies inestables. <br/>
          • Comunicación: informa al cliente y despeja zonas de paso.
        </div>
      </div>

      <div class="cta">
        <div class="warning" id="initDataWarn" style="display:none;">No se detectó initData. Aún puedes ver tu recompensa.</div>
        <button class="btn alt" id="rewardBtn" aria-label="Ver mi recompensa">Ver mi recompensa</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Datos del juego (5 escenas)
       ========================= */
    const scenes = [
      {
        text: "Salón: montas un enchufe nuevo.",
        options: [
          { label: "Cubreplaca agrietada", type: "Material", wrong: true },
          { label: "Tornillos prietos sin forzar", type: "Acción", wrong: false },
          { label: "Conductores con funda intacta", type: "Material", wrong: false },
          { label: "Borne fase/neutro bien apretados", type: "Acción", wrong: false },
        ],
        explanation: "Nunca instales cubreplacas dañadas: pueden cortar y no protegen. Sustituye piezas agrietadas antes de cerrar el enchufe."
      },
      {
        text: "Vas a cambiar un punto de luz con escalera.",
        options: [
          { label: "Escalera sobre suelo mojado", type: "Norma", wrong: true },
          { label: "Ayudante estabiliza la base", type: "Acción", wrong: false },
          { label: "Ángulo 75° aprox.", type: "Norma", wrong: false },
          { label: "Peldaños sin herramientas", type: "Acción", wrong: false },
        ],
        explanation: "Evita apoyar la escalera en superficies mojadas: puede deslizar. Mantén 75° y base estable; idealmente, con ayudante."
      },
      {
        text: "Revisas el cuadro general del piso.",
        options: [
          { label: "Tapa abierta sin señalizar", type: "Norma", wrong: true },
          { label: "Circuitos bien identificados", type: "Norma", wrong: false },
          { label: "Guantes dieléctricos puestos", type: "EPI", wrong: false },
        ],
        explanation: "Si la tapa del cuadro está abierta, señaliza y bloquea el acceso. Evita contactos accidentales durante la revisión."
      },
      {
        text: "En el pasillo, cables tendidos para pruebas.",
        options: [
          { label: "Cables cruzan sin avisar", type: "Comunicación", wrong: true },
          { label: "Cartel 'Precaución' visible", type: "Comunicación", wrong: false },
          { label: "Pasillo despejado", type: "Acción", wrong: false },
        ],
        explanation: "Si tiendes cables en zona de paso, avisa y señaliza o usa pasacables. Evita caídas del cliente o del equipo."
      },
      {
        text: "Al terminar, recoges restos de cable.",
        options: [
          { label: "Retales al cubo general", type: "Norma", wrong: true },
          { label: "Separas cobre para reciclar", type: "Acción", wrong: false },
          { label: "Zona de trabajo limpia", type: "Acción", wrong: false },
        ],
        explanation: "Los retales de cable se separan para reciclar (cobre/plástico). No mezclar con escombros: reduces residuos y costes."
      }
    ];

    /* =========================
       Estado y utilidades
       ========================= */
    const MAX_LABEL = 48;
    const MAX_EXPL = 180;

    function truncate(str, n){
      if(!str) return "";
      if(str.length <= n) return str;
      return str.slice(0, n-1).trimEnd() + "…";
    }

    function sanitizeSceneData(scene){
      scene.text = truncate(scene.text, MAX_EXPL);
      scene.options.forEach(o => o.label = truncate(o.label, MAX_LABEL));
      scene.explanation = truncate(scene.explanation, MAX_EXPL);
      return scene;
    }
    scenes.forEach(sanitizeSceneData);

    let current = 0;
    const total = scenes.length;
    const answers = []; // {chosen, correct, isHit}

    // initData management
    const params = new URLSearchParams(location.search);
    const initData = params.get("initData") || "";
    const hasInitData = !!initData;

    // DOM refs
    const app = document.getElementById("app");
    const board = document.getElementById("board");
    const storyBox = document.getElementById("storyBox");
    const sceneText = document.getElementById("sceneText");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const statusBubble = document.getElementById("statusBubble");
    const toast = document.getElementById("toast");
    const intro = document.getElementById("intro");
    const startBtn = document.getElementById("startBtn");
    const resultsOverlay = document.getElementById("results");
    const resultsList = document.getElementById("resultsList");
    const scoreLine = document.getElementById("scoreLine");
    const rewardBtn = document.getElementById("rewardBtn");
    const initDataWarn = document.getElementById("initDataWarn");

    /* =========================
       Accesibilidad y vibra
       ========================= */
    const buzz = ms => { try { if(navigator.vibrate) navigator.vibrate(ms); } catch(e){} };

    /* =========================
       Render de escena y opciones
       ========================= */
    function render(){
      const sc = scenes[current];
      sceneText.textContent = sc.text;

      // Progreso
      const p = (current / total) * 100;
      progressBar.style.width = `${p}%`;
      progressText.textContent = `${current}/${total}`;

      // Limpiar tablero
      board.innerHTML = "";
      // Construcción de opciones
      sc.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "option fade-enter";
        btn.setAttribute("type", "button");
        btn.setAttribute("aria-label", `${opt.type}: ${opt.label}`);
        btn.dataset.index = idx;

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = opt.type;

        const txt = document.createElement("span");
        txt.className = "text";
        txt.textContent = opt.label;

        btn.appendChild(badge);
        btn.appendChild(txt);

        btn.addEventListener("click", () => handleChoice(idx, btn), { passive: true });

        board.appendChild(btn);
        requestAnimationFrame(() => {
          btn.classList.add("fade-enter-active");
        });
      });

      // Ajuste de layout para que quepa sin scroll
      ensureFits();
    }

    function handleChoice(idx, btnEl){
      // Evitar doble clic
      if(board.dataset.lock === "1") return;
      board.dataset.lock = "1";

      const sc = scenes[current];
      const chosen = sc.options[idx];
      const wrongOption = sc.options.find(o => o.wrong);
      const isHit = chosen.wrong === true;

      // Visual feedback
      btnEl.classList.add("chosen");
      if(isHit){
        btnEl.classList.add("correct");
        showToast("¡Bien visto! Ese es el fallo.");
      } else {
        btnEl.classList.add("wrong");
        // También marca la correcta
        const wrongIdx = sc.options.findIndex(o => o.wrong);
        const correctEl = board.querySelector(`.option[data-index="${wrongIdx}"]`);
        if(correctEl) correctEl.classList.add("correct");
        showToast("Casi. El fallo era otra opción.");
      }

      buzz(isHit ? 25 : 80);

      // Guarda la respuesta
      answers[current] = {
        chosen: chosen.label,
        correct: wrongOption.label,
        isHit
      };

      // Avanza tras una breve pausa
      setTimeout(() => {
        // salida animada
        Array.from(board.children).forEach(el=>{
          el.classList.remove("fade-enter","fade-enter-active");
          el.classList.add("fade-exit");
          requestAnimationFrame(() => el.classList.add("fade-exit-active"));
        });
        setTimeout(() => {
          current++;
          if(current < total){
            board.dataset.lock = "0";
            render();
          } else {
            finish();
          }
        }, 140);
      }, 520);
    }

    function finish(){
      // Progreso final
      progressBar.style.width = "100%";
      progressText.textContent = `${total}/${total}`;
      statusBubble.textContent = "¡Actividad completada! Consulta tu feedback.";
      // montar resultados
      const hits = answers.filter(a => a && a.isHit).length;
      scoreLine.textContent = `Has resuelto ${hits}/${total} escenas.`;

      // Items de explicación
      resultsList.innerHTML = "";
      scenes.forEach((sc, i) => {
        const a = answers[i] || { chosen: "—", correct: sc.options.find(o=>o.wrong)?.label || "—", isHit: false };
        const card = document.createElement("div");
        card.className = "card";
        const head = document.createElement("div");
        head.className = "row";
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = `Escena ${i+1}`;
        head.appendChild(pill);
        head.appendChild(document.createElement("span"));
        const chosenRow = document.createElement("div");
        chosenRow.className = "row";
        const chosenTag = document.createElement("span");
        chosenTag.className = "tag";
        chosenTag.textContent = "Tu elección";
        const chosenTxt = document.createElement("span");
        chosenTxt.textContent = a.chosen;
        chosenRow.appendChild(chosenTag);
        chosenRow.appendChild(chosenTxt);

        const correctRow = document.createElement("div");
        correctRow.className = "row";
        const correctTag = document.createElement("span");
        correctTag.className = "tag";
        correctTag.style.background = "linear-gradient(180deg,#a8ff8c,#56f0a8)";
        correctTag.textContent = "Correcto";
        const correctTxt = document.createElement("span");
        correctTxt.textContent = a.correct;
        correctRow.appendChild(correctTag);
        correctRow.appendChild(correctTxt);

        const expl = document.createElement("div");
        expl.className = "explain";
        expl.textContent = sc.explanation;

        card.appendChild(head);
        card.appendChild(chosenRow);
        card.appendChild(correctRow);
        card.appendChild(expl);
        resultsList.appendChild(card);
      });

      // Mostrar advertencia de initData si falta
      initDataWarn.style.display = hasInitData ? "none" : "block";

      // Activar overlay de resultados
      resultsOverlay.classList.add("show");

      // Importante: permitir scroll solo en el modal, no global
      // (el modal ya usa max-height y overflow-y:auto)
    }

    function showToast(msg){
      toast.textContent = truncate(msg, 90);
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 900);
    }

    /* =========================
       Ajustes de encaje en pantalla
       ========================= */
    function assertNoOverflow(){
      const fits = app.scrollHeight <= app.clientHeight;
      return fits;
    }

    function applyCompactMode(){
      if(!document.body.classList.contains("compact")){
        document.body.classList.add("compact");
      }
    }

    let fitStep = 0;
    function fitBoardToViewport(){
      // Reducir gradualmente la altura de celda y/o relación aspecto
      // 2 intentos de ajuste "suave"
      const maxSteps = 2;
      while(!assertNoOverflow() && fitStep < maxSteps){
        fitStep++;
        const currentH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--cellH"));
        const newH = Math.max(52, currentH - 6);
        document.documentElement.style.setProperty("--cellH", newH + "px");
      }
    }

    function autoscaleUI(){
      // Como último recurso, escalar la UI hasta 0.88
      const minScale = 0.88;
      let scale = 1.0;
      while(!assertNoOverflow() && scale > minScale){
        scale -= 0.02;
        document.documentElement.style.setProperty("--ui-scale", scale.toFixed(2));
      }
    }

    function ensureFits(){
      // Reset de parámetros base para el cálculo
      document.body.classList.remove("compact");
      document.documentElement.style.setProperty("--ui-scale", "1");
      document.documentElement.style.setProperty("--cellH", "64px");
      fitStep = 0;

      // Paso 1: ¿Cabe?
      if(assertNoOverflow()) return;
      // Paso 2: Modo compacto
      applyCompactMode();
      if(assertNoOverflow()) return;
      // Paso 3: Ajuste de rejilla
      fitBoardToViewport();
      if(assertNoOverflow()) return;
      // Paso 4: Auto-escalado
      autoscaleUI();
      // Done.
    }

    window.addEventListener("resize", ensureFits);
    window.addEventListener("orientationchange", () => setTimeout(ensureFits, 80));

    /* =========================
       Inicio
       ========================= */
    function startGame(){
      intro.classList.remove("show");
      // Primer render
      current = 0;
      answers.length = 0;
      render();
      statusBubble.textContent = "Toca el ítem incorrecto (1/5)";
    }

    startBtn.addEventListener("click", startGame);

    /* =========================
       CTA Final (initData)
       ========================= */
    rewardBtn.addEventListener("click", () => {
      const url = "https://kampe-game-phaser.onrender.com/daily_streak?initData=" + encodeURIComponent(initData);
      location.href = url;
    });

    // Pre-render: mostrar escena 0 (texto) bajo el modal
    (function bootstrap(){
      // Pinta estado inicial antes de empezar (0/5)
      sceneText.textContent = "Detecta el error en cada parada del trabajo.";
      progressBar.style.width = "0%";
      progressText.textContent = `0/${total}`;
      statusBubble.textContent = "Tutorial: 1–2 frases. Pulsa Empezar.";
      // Asegurar que el layout no desborda
      ensureFits();
    })();
  </script>
</body>
</html>