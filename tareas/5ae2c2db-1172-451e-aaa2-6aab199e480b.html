<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>K√§mpe | Chispa en el enchufe ‚ö°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* Reset + base */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden; /* Bloqueo de scroll en gameplay */
      overscroll-behavior: none;
      font-family: "Manrope", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: #fff; background: #0b3bff; /* Fortnite vibe */
    }

    :root{
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.18);
      --glass-stroke: rgba(255,255,255,0.25);
      --accent: #6df0ff;
      --accent-2: #7cff6d;
      --danger: #ff6060;
      --warning: #ffd36d;
      --ok: #69ff9b;
      --ui-scale: 1;
      --hudH: 72px;
      --choicesH: 184px; /* Altura fija para botoner√≠a */
      --radius: 16px;
      --pad: 12px;
    }
    @media (max-width: 350px) {
      :root{ --hudH: 68px; --choicesH: 178px; }
    }
    .compact:root, .scene.compact{
      --hudH: 60px;
      --choicesH: 168px;
      --radius: 14px;
    }

    /* Escena a 100svh con fallbacks */
    .scene {
      position: relative;
      width: 100%;
      transform-origin: top center;
      background:
        radial-gradient(1000px 600px at 80% -20%, rgba(255,255,255,0.18), transparent 60%),
        radial-gradient(1200px 700px at -10% 0%, rgba(39,255,255,0.18), transparent 60%),
        linear-gradient(180deg, #0b3bff 0%, #0826a8 100%);
      padding:
        calc(8px + env(safe-area-inset-top))
        calc(10px + env(safe-area-inset-right))
        calc(10px + env(safe-area-inset-bottom))
        calc(10px + env(safe-area-inset-left));
      touch-action: none; /* Antiderrapes global */
      display: flex; flex-direction: column;
      gap: 8px;
    }
    @supports (height: 100svh) { .scene { height: 100svh; } }
    @supports not (height: 100svh) { @supports (height: 100dvh) { .scene { height: 100dvh; } } }
    @supports not (height: 100svh) { @supports not (height: 100dvh) { .scene { height: 100vh; } } }

    /* Marca y HUD */
    .hud {
      height: var(--hudH);
      min-height: var(--hudH);
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.10));
      border: 1px solid var(--glass-stroke);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      transform: scale(var(--ui-scale));
      overflow: hidden;
    }
    .brand {
      display:flex; align-items:center; gap:8px;
    }
    .brand img {
      width: 36px; height: 36px; object-fit: contain; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.45));
    }
    .brand .title {
      display:flex; flex-direction:column; line-height: 1.05;
    }
    .brand .title .h1 {
      font-weight: 800; letter-spacing: 0.2px;
      font-size: clamp(16px, 2.7vw, 20px);
    }
    .brand .title .h2 {
      font-weight: 600; color: #dff7ff; opacity: 0.92;
      font-size: clamp(10px, 2.1vw, 12px);
      max-width: 56vw; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
    }
    .progress {
      justify-self: end;
      display: flex; align-items: center; gap: 8px;
      background: rgba(0,0,0,0.25);
      padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
      font-weight: 700;
      font-size: clamp(12px, 2.4vw, 14px);
    }
    .progress .dots { display:flex; gap:4px; }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,0.3);
      outline: 1px solid rgba(255,255,255,0.25);
    }
    .dot.active { background: var(--accent-2); outline-color: rgba(0,0,0,0.25); }

    /* Watermark avatar */
    .watermark {
      position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;
    }
    .watermark img {
      position: absolute; right: -40px; bottom: calc(var(--choicesH) - 40px);
      width: 48vh; max-width: 60vw; opacity: 0.14; transform: rotate(-6deg);
      filter: blur(0.2px) saturate(1.1);
    }

    /* Chat area */
    .panel {
      position: relative;
      flex: 1; min-height: 0; /* permit scroll interno */
      display: flex; flex-direction: column;
      gap: 8px;
      border-radius: var(--radius);
      border: 1px solid var(--glass-stroke);
      background: linear-gradient(180deg, rgba(8,28,130,0.65), rgba(17,17,50,0.55));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), 0 10px 30px rgba(0,0,0,0.25);
      padding: 10px;
      transform: scale(var(--ui-scale));
    }
    .chat {
      position: relative;
      flex: 1; min-height: 0;
      padding: 6px;
      border-radius: 12px;
      background: rgba(0,0,0,0.25);
      overflow-y: auto; /* Solo el hist√≥rico del chat puede scrollear */
      scroll-behavior: smooth;
      touch-action: pan-y; /* permitir scroll vertical solo aqu√≠ */
    }
    .messages { display: flex; flex-direction: column; gap: 8px; padding-bottom: 4px; }
    .msg {
      display: grid;
      grid-template-columns: 32px 1fr;
      gap: 8px;
      align-items: flex-start;
      max-width: 100%;
      will-change: transform, opacity;
      animation: pop 220ms ease-out;
    }
    @keyframes pop {
      from { transform: translateY(6px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .msg.right { grid-template-columns: 1fr 32px; }
    .msg.right .avatar { order: 2; }
    .msg.right .bubble { order: 1; background: linear-gradient(180deg, #2b67ff, #184bff); border-color: rgba(255,255,255,0.25); }
    .avatar {
      width: 32px; height: 32px; border-radius: 50%; overflow: hidden; border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .bubble {
      padding: 8px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.10));
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      font-size: clamp(12px, 2.5vw, 14px);
      line-height: 1.25;
      display: flex; flex-direction: column; gap: 2px;
      max-width: 86%;
    }
    .meta {
      display: flex; align-items: baseline; gap: 6px; opacity: 0.9;
      font-size: 11px; font-weight: 700; letter-spacing: 0.2px; color: #bfe9ff;
    }
    .who { max-width: 14ch; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
    .mood { font-size: 12px; }
    .text {
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }

    /* Choices */
    .choices {
      position: sticky; bottom: 0; left: 0; right: 0;
      min-height: var(--choicesH);
      display: grid; grid-template-rows: auto 1fr; gap: 8px;
      padding: 10px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(6,6,20,0.55), rgba(6,6,20,0.75));
      border: 1px solid var(--glass-stroke);
      box-shadow: 0 -8px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);
      transform: scale(var(--ui-scale));
      z-index: 2;
    }
    .tip {
      font-size: clamp(11px, 2.4vw, 12px); color: #d1f4ff; opacity: 0.9;
      display: flex; align-items: center; gap: 8px;
    }
    .tip b { color: #fff; }
    .btns {
      display: grid; grid-template-columns: 1fr; gap: 8px;
    }
    .choice {
      width: 100%;
      min-height: 48px; /* ‚â•44px touch target */
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.12));
      color: #fff;
      font-weight: 800;
      font-size: clamp(14px, 3.6vw, 16px);
      letter-spacing: 0.2px;
      padding: 12px 14px;
      text-align: left;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    .choice:hover, .choice:focus { transform: translateY(-1px); outline: 2px solid var(--accent); box-shadow: 0 10px 24px rgba(0,0,0,0.45); }
    .choice:active { transform: translateY(0); }
    .choice .label {
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; /* 48 chars aprox */
    }
    .choice.correct { border-color: rgba(124,255,109,0.9); background: linear-gradient(180deg, rgba(124,255,109,0.28), rgba(124,255,109,0.16)); }
    .choice.partial { border-color: rgba(255,211,109,0.85); background: linear-gradient(180deg, rgba(255,211,109,0.28), rgba(255,211,109,0.16)); }
    .choice.wrong { border-color: rgba(255,96,96,0.9); background: linear-gradient(180deg, rgba(255,96,96,0.28), rgba(255,96,96,0.16)); }

    /* Intro & Results modals */
    .modal {
      position: absolute; inset: 0;
      display: none;
      align-items: center; justify-content: center;
      padding: 12px;
      z-index: 5;
      background: linear-gradient(180deg, rgba(0,0,0,0.28), rgba(0,0,0,0.55));
      touch-action: none;
    }
    .modal.show { display: flex; }
    .card {
      width: min(680px, 94vw);
      max-height: 90svh; overflow-y: auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.12));
      border: 1px solid var(--glass-stroke);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 16px 44px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
    }
    .card h3 { margin: 0 0 6px 0; font-size: clamp(18px, 4.5vw, 22px); }
    .card p { margin: 6px 0; font-size: clamp(12px, 2.8vw, 14px); opacity: 0.95; }
    .card .small { font-size: clamp(11px, 2.4vw, 12px); opacity: 0.85; }
    .cta {
      margin-top: 10px;
      display: grid; grid-template-columns: 1fr; gap: 8px;
    }
    .button {
      display: inline-flex; align-items: center; justify-content: center;
      min-height: 48px; border-radius: 12px; padding: 10px 14px;
      font-weight: 800; font-size: clamp(14px, 3.6vw, 16px);
      color: #00152e;
      background: linear-gradient(180deg, #80ffea, #41ffd3);
      border: 1px solid rgba(255,255,255,0.5);
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .button:focus { outline: 2px solid #fff; }
    .button.secondary {
      background: linear-gradient(180deg, #ffffff, #d9e9ff);
      color: #00152e;
    }
    .warn {
      color: #ffe07a; font-weight: 700; font-size: clamp(11px, 2.4vw, 12px);
    }

    .list {
      display: grid; gap: 10px; margin-top: 6px;
    }
    .item {
      display: grid; grid-template-columns: 28px 1fr; gap: 10px; align-items: start;
      padding: 10px; border-radius: 12px;
      background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.2);
    }
    .item .ic { width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; border-radius: 8px; }
    .ic.ok { background: rgba(124,255,109,0.25); }
    .ic.mid { background: rgba(255,211,109,0.25); }
    .ic.bad { background: rgba(255,96,96,0.25); }
    .scoreRow {
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
      margin: 6px 0 4px 0;
    }
    .stars { display: flex; gap: 4px; font-size: 18px; }
    .stars .s { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.35)); }
    .note {
      margin-top: 6px; padding: 10px;
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.22);
      background: linear-gradient(180deg, rgba(124,255,109,0.22), rgba(124,255,109,0.1));
      color: #0a1b0f;
    }

    /* Focus visibly */
    :focus-visible { outline: 3px solid var(--accent); outline-offset: 2px; border-radius: 10px; }

    /* Scaling hook (ensureFits) */
    .scene.scaled { transform: scale(var(--ui-scale)); transform-origin: top center; }
  </style>
</head>
<body>
  <div id="scene" class="scene" aria-label="Actividad interactiva 'Chispa en el enchufe'">

    <!-- HUD -->
    <header class="hud" aria-label="Cabecera">
      <div class="brand">
        <img src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Logo K√§mpe" />
        <div class="title">
          <div class="h1">Chispa en el enchufe ‚ö°</div>
          <div class="h2">%%descripcion%% ¬∑ Escenario: En un piso, un enchufe chispea al usar un secador; el cliente est√° nervioso y t√∫, aprendiz, acabas de llegar mientras tu mentora te gu√≠a por chat.</div>
        </div>
      </div>
      <div></div>
      <div class="progress" aria-live="polite" aria-atomic="true">
        <span id="progressText">Intro</span>
        <div class="dots" aria-hidden="true">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
          <div class="dot" id="d5"></div>
        </div>
      </div>
    </header>

    <!-- Watermark big avatar -->
    <div class="watermark" aria-hidden="true">
      <img src="https://techkampe.github.io/daily-streak/assets/Avatar%202_low.png" alt="">
    </div>

    <!-- Panel Chat + Choices -->
    <section class="panel" role="region" aria-label="Chat de la misi√≥n">
      <div id="chat" class="chat" role="log" aria-live="polite" aria-relevant="additions">
        <div id="messages" class="messages"></div>
      </div>

      <div id="choices" class="choices" role="group" aria-label="Opciones">
        <div class="tip">Consejo: <b>elige tu respuesta</b>. El chat se acumula. Solo el hist√≥rico del chat permite scroll.</div>
        <div id="btns" class="btns"></div>
      </div>
    </section>

    <!-- Intro Modal -->
    <div id="intro" class="modal show" role="dialog" aria-modal="true" aria-labelledby="introTitle">
      <div class="card">
        <h3 id="introTitle">Chispa en el enchufe ‚ö°</h3>
        <p>Escenario: En un piso, un enchufe chispea al usar un secador. Tu clienta est√° nerviosa. Tu mentora Lola te gu√≠a por chat.</p>
        <p class="small">Objetivo: seguridad b√°sica (cortar y verificar tensi√≥n, EPI, orden) y trato al cliente (explicar, permiso, tiempos y coste).</p>
        <p class="small">C√≥mo jugar: Toca una opci√≥n por turno. La conversaci√≥n se guarda como en WhatsApp. No hay scroll fuera del chat.</p>
        <div class="cta">
          <button id="startBtn" class="button" aria-label="Empezar el reto">¬°Empezar!</button>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div id="results" class="modal" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
      <div class="card">
        <h3 id="resultsTitle">Resultados del reto</h3>
        <div id="scoreRow" class="scoreRow">
          <div><b>Tu puntuaci√≥n</b></div>
          <div id="stars" class="stars" aria-hidden="true"></div>
        </div>
        <div id="summary" class="list" aria-label="Resumen de decisiones"></div>
        <div class="note" aria-label="Consejo pr√°ctico">
          <b>Consejo CTAIC:</b> Comunica ‚Üí Tensi√≥n OFF ‚Üí Ausencia de tensi√≥n ‚Üí Interviene ‚Üí Comprueba. Repite siempre este orden y ganar√°s seguridad y confianza.
        </div>
        <div class="cta">
          <a id="rewardBtn" class="button secondary" href="#" rel="nofollow">Ver mi recompensa</a>
          <div id="initWarn" class="warn" hidden>Nota: initData no encontrado. Se abrir√° sin datos.</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ==============================
       Estado y contenido del reto
       ============================== */
    const AVATARS = {
      Lola:  "https://techkampe.github.io/daily-streak/assets/Avatar%201_low.png",     // Mentora
      Alex:  "https://techkampe.github.io/daily-streak/assets/Avatar%202_low.png",     // Aprendiz (t√∫)
      "Sra. Ruiz": "https://techkampe.github.io/daily-streak/assets/Avatar%204_low.png" // Cliente
    };

    // Turnos: 5 turnos con opciones Correcta / Parcial / Incorrecta
    // Los textos han sido acotados (‚â§ 48 caracteres aprox) para no romper el layout.
    const TURNS = [
      {
        id: 1,
        pre: [
          { who: "Sra. Ruiz", side: "left", mood: "üòü", text: "¬°El enchufe chispea al usar el secador!" },
          { who: "Lola", side: "left", mood: "üß†", text: "Respira. Comunica y pide acceso al cuadro." }
        ],
        options: [
          { kind: "correct",
            text: "Presentarte, calmar y pedir acceso al cuadro",
            react: { who: "Lola", text: "Bien, primero personas y seguridad. üëå" },
            explain: "Avisar y pedir acceso al cuadro genera confianza y evita riesgos."
          },
          { kind: "partial",
            text: "Pedir desenchufar y esperar",
            react: { who: "Lola", text: "Mejor que tocar, falta cortar desde el cuadro. ‚ö†Ô∏è" },
            explain: "Es prudente, pero debes cortar desde el cuadro antes de intervenir."
          },
          { kind: "wrong",
            text: "Tocar el enchufe para ver si chispea",
            react: { who: "Lola", text: "¬°Alto! Nunca sin cortar tensi√≥n. ‚ùå" },
            explain: "Nunca manipules un enchufe en tensi√≥n: corta y verifica primero."
          }
        ]
      },
      {
        id: 2,
        pre: [
          { who: "Lola", side: "left", mood: "üß≠", text: "En el cuadro, identifica el circuito correcto." }
        ],
        options: [
          { kind: "correct",
            text: "Bajar magneto del circuito de tomas del ba√±o",
            react: { who: "Lola", text: "Perfecto. A√≠sla solo lo necesario. ‚úÖ" },
            explain: "Cortar el circuito afectado evita dejar sin luz toda la vivienda."
          },
          { kind: "partial",
            text: "Bajar el general",
            react: { who: "Lola", text: "Sirve, pero deja todo sin servicio. ‚ö†Ô∏è" },
            explain: "Seguro pero invasivo: mejor el magnetot√©rmico del circuito."
          },
          { kind: "wrong",
            text: "Bajar un diferencial cualquiera",
            react: { who: "Lola", text: "No adivines. Identifica el circuito. ‚ùå" },
            explain: "Bajar un diferencial aleatorio no garantiza cortar el circuito de tomas."
          }
        ]
      },
      {
        id: 3,
        pre: [
          { who: "Lola", side: "left", mood: "üß§", text: "Con el magneto abajo, ¬øpr√≥ximo paso?" }
        ],
        options: [
          { kind: "correct",
            text: "Verificar ausencia con mult√≠metro + guantes",
            react: { who: "Lola", text: "As√≠ se hace: medir y EPI. üëç" },
            explain: "Verifica ausencia con instrumento y usa guantes diel√©ctricos."
          },
          { kind: "partial",
            text: "Solo buscapolos, sin guantes",
            react: { who: "Lola", text: "Falta EPI y mejor usa mult√≠metro. ‚ö†Ô∏è" },
            explain: "El buscapolos orienta; lo ideal es mult√≠metro/medidor y EPI."
          },
          { kind: "wrong",
            text: "Confiarse por bajar el general",
            react: { who: "Lola", text: "Nunca te f√≠es. ¬°Mide siempre! ‚ùå" },
            explain: "Bajar magnetos no basta: mide y confirma ausencia de tensi√≥n."
          }
        ]
      },
      {
        id: 4,
        pre: [
          { who: "Sra. Ruiz", side: "left", mood: "ü§î", text: "¬øQu√© ocurre? ¬øCu√°nto tardar√° y costar√°?" }
        ],
        options: [
          { kind: "correct",
            text: "Explicar y pedir permiso; 20 min y 15‚Ç¨ aprox",
            react: { who: "Sra. Ruiz", text: "Gracias por explicarlo. Adelante. üôÇ" },
            explain: "Transparencia: diagn√≥stico simple, permiso, tiempo y coste estimado."
          },
          { kind: "partial",
            text: "Explicar sin dar tiempos ni coste",
            react: { who: "Lola", text: "Bien explicar, pero da estimaciones. ‚ö†Ô∏è" },
            explain: "Informar es clave: indica permiso, tiempos y coste aproximado."
          },
          { kind: "wrong",
            text: "Decir ‚Äútodo mal‚Äù; 2 h y 100‚Ç¨",
            react: { who: "Lola", text: "Evita alarmismo y sobrecostes. ‚ùå" },
            explain: "No exageres: comunica con calma y justifica con datos."
          }
        ]
      },
      {
        id: 5,
        pre: [
          { who: "Lola", side: "left", mood: "üß∞", text: "Ejecuta, ordena y comprueba al final." }
        ],
        options: [
          { kind: "correct",
            text: "Reparar, ordenar, probar y gestionar residuos",
            react: { who: "Lola", text: "Trabajo limpio y seguro. ‚úÖ" },
            explain: "Cierra ordenado: prueba, deja todo limpio y gestiona residuos."
          },
          { kind: "partial",
            text: "Reparar y probar, pero dejas residuos",
            react: { who: "Lola", text: "Funciona, pero cuida el orden. ‚ö†Ô∏è" },
            explain: "La t√©cnica cuenta, y la imagen tambi√©n: limpia y recoge."
          },
          { kind: "wrong",
            text: "Cambiar y salir sin probar ni recoger",
            react: { who: "Lola", text: "Falt√≥ probar y ordenar. ‚ùå" },
            explain: "Siempre prueba con carga y deja el √°rea en perfecto estado."
          }
        ]
      },
    ];

    /* ==============================
       Referencias DOM
       ============================== */
    const sceneEl = document.getElementById('scene');
    const chatEl = document.getElementById('chat');
    const messagesEl = document.getElementById('messages');
    const btnsEl = document.getElementById('btns');
    const progressText = document.getElementById('progressText');
    const dots = [1,2,3,4,5].map(i => document.getElementById('d'+i));
    const introModal = document.getElementById('intro');
    const resultsModal = document.getElementById('results');
    const summaryEl = document.getElementById('summary');
    const starsEl = document.getElementById('stars');
    const rewardBtn = document.getElementById('rewardBtn');
    const initWarn = document.getElementById('initWarn');

    /* ==============================
       Estado de juego
       ============================== */
    let initData = "";
    let started = false;
    let turnIdx = 0; // 0..4
    const history = []; // mensajes
    const decisions = []; // { turnId, choiceText, kind, explain }
    let score = 0;

    /* ==============================
       Utilidades UI + A11y
       ============================== */
    function clampText(text, maxChars = 48) {
      if (!text) return text;
      if (text.length <= maxChars) return text;
      return text.slice(0, maxChars - 1) + "‚Ä¶";
    }

    function renderMessage({ who, side, mood = "", text }) {
      const msg = document.createElement('div');
      msg.className = 'msg ' + (side === 'right' ? 'right' : 'left');
      msg.setAttribute('role', 'article');
      msg.setAttribute('aria-label', who + " dice: " + text);

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      const img = document.createElement('img');
      img.alt = who;
      img.loading = "lazy";
      img.src = AVATARS[who] || AVATARS["Lola"];
      avatar.appendChild(img);

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const whoEl = document.createElement('div');
      whoEl.className = 'who';
      whoEl.textContent = who;
      const moodEl = document.createElement('div');
      moodEl.className = 'mood';
      moodEl.textContent = mood;
      meta.appendChild(whoEl); meta.appendChild(moodEl);

      const textEl = document.createElement('div');
      textEl.className = 'text';
      textEl.textContent = text;

      bubble.appendChild(meta);
      bubble.appendChild(textEl);

      if (side === 'right') {
        msg.appendChild(bubble);
        msg.appendChild(avatar);
      } else {
        msg.appendChild(avatar);
        msg.appendChild(bubble);
      }
      messagesEl.appendChild(msg);
    }

    function scrollChatToEnd() {
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setProgress() {
      const step = Math.min(turnIdx + 1, 5);
      progressText.textContent = `${step}/5`;
      dots.forEach((d, i) => d.classList.toggle('active', i < step));
    }

    function renderChoices(turn) {
      btnsEl.innerHTML = "";
      const opts = turn.options.slice(0, 3); // m√°ximo 3
      for (const o of opts) {
        const b = document.createElement('button');
        b.className = 'choice';
        b.setAttribute('aria-label', o.text);
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = clampText(o.text, 48);
        b.appendChild(label);
        b.addEventListener('click', () => onChoose(o));
        btnsEl.appendChild(b);
      }
      ensureFits();
    }

    function updateChoiceStyles(kind) {
      // color feedback breve en botones (no bloquea avance)
      [...btnsEl.children].forEach(btn => btn.classList.remove('correct', 'partial', 'wrong'));
      if (kind) {
        const map = { correct: 'correct', partial: 'partial', wrong: 'wrong' };
        [...btnsEl.children].forEach(btn => {
          const label = btn.querySelector('.label')?.textContent || "";
          // naive highlight if contains similar words
          if (map[kind] && label && label.toLowerCase().includes(labelForKind(kind))) {
            btn.classList.add(map[kind]);
          }
        });
      }
    }
    function labelForKind(k) {
      // Not used for exact mapping; kept for future improvements
      return "";
    }

    /* ==============================
       Flujo del juego
       ============================== */
    function startGame() {
      started = true;
      introModal.classList.remove('show');
      // Primer turno
      turnIdx = 0;
      history.length = 0;
      decisions.length = 0;
      score = 0;
      messagesEl.innerHTML = "";
      renderTurn(turnIdx);
      assertNoOverflow() || ensureFits();
    }

    function renderTurn(idx) {
      const t = TURNS[idx];
      // Render pre mensajes (1‚Äì2)
      t.pre.forEach(m => {
        history.push(m);
        renderMessage(m);
      });
      // Render opciones
      renderChoices(t);
      setProgress();
      scrollChatToEnd();
    }

    function onChoose(option) {
      // Deshabilitar botones temporalmente para evitar doble click
      [...btnsEl.children].forEach(b => b.disabled = true);

      // A√±adir el mensaje del jugador (Alex)
      const alexMsg = { who: "Alex", side: "right", mood: "‚úã", text: option.text };
      history.push(alexMsg);
      renderMessage(alexMsg);

      // Reacci√≥n (Lola o Clienta)
      const reactMsg = { who: option.react.who || "Lola", side: "left", mood: "", text: option.react.text };
      history.push(reactMsg);
      renderMessage(reactMsg);

      // Guardar decisi√≥n
      decisions.push({
        turnId: TURNS[turnIdx].id,
        choiceText: option.text,
        kind: option.kind,
        explain: option.explain
      });

      // Scoring
      if (option.kind === "correct") score += 2;
      if (option.kind === "partial") score += 1;

      // Avanzar al siguiente turno
      setTimeout(() => {
        turnIdx++;
        if (turnIdx < TURNS.length) {
          renderTurn(turnIdx);
        } else {
          showResults();
        }
      }, 420);
      setProgress();
      scrollChatToEnd();
      // Re-habilitar botones (se recrear√°n en el siguiente render)
    }

    function showResults() {
      // Activar scroll s√≥lo en la vista final
      enableGlobalScroll(true);

      // Construir estrellas (0‚Äì10 => 0‚Äì5 estrellas)
      starsEl.innerHTML = "";
      const stars = Math.max(0, Math.min(5, Math.round(score / 2)));
      for (let i = 0; i < 5; i++) {
        const s = document.createElement('span');
        s.className = 's';
        s.textContent = i < stars ? '‚≠ê' : '‚òÜ';
        starsEl.appendChild(s);
      }

      // Resumen de decisiones
      summaryEl.innerHTML = "";
      decisions.forEach((d, idx) => {
        const item = document.createElement('div');
        item.className = 'item';
        const ic = document.createElement('div');
        ic.className = 'ic ' + (d.kind === 'correct' ? 'ok' : d.kind === 'partial' ? 'mid' : 'bad');
        ic.textContent = d.kind === 'correct' ? '‚úÖ' : d.kind === 'partial' ? '‚ö†Ô∏è' : '‚ùå';
        const body = document.createElement('div');
        const t = document.createElement('div');
        t.innerHTML = `<b>Turno ${idx + 1}:</b> ${d.choiceText}`;
        const e = document.createElement('div');
        e.style.opacity = 0.9;
        e.style.marginTop = '4px';
        e.textContent = d.explain;
        body.appendChild(t); body.appendChild(e);

        item.appendChild(ic);
        item.appendChild(body);
        summaryEl.appendChild(item);
      });

      resultsModal.classList.add('show');
      ensureFits(); // Ajuste final modal
    }

    /* ==============================
       initData y salida
       ============================== */
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name) || "";
    }
    function setupInitData() {
      initData = getQueryParam('initData') || "";
      const target = "https://kampe-game-phaser.onrender.com/daily_streak?initData=" + encodeURIComponent(initData);
      rewardBtn.href = target;
      initWarn.hidden = !!initData;
    }

    /* ==============================
       Ajustes de layout (guardarra√≠les)
       ============================== */
    function assertNoOverflow() {
      const ok = sceneEl.scrollHeight <= sceneEl.clientHeight + 1; // tolerancia
      return ok;
    }
    function applyCompactMode() {
      if (!sceneEl.classList.contains('compact')) {
        sceneEl.classList.add('compact');
      }
    }
    function fitBoardToViewport() {
      // Ajustes menores de layout si hiciera falta (se podr√≠a recalcular gaps)
      // Forzamos reducci√≥n de paddings si estamos compact
      // (ya definido en CSS con .compact)
    }
    function autoscaleUI() {
      // √öltimo recurso: escalar la escena
      let scale = 1.0;
      while (!assertNoOverflow() && scale > 0.88) {
        scale -= 0.02;
        document.documentElement.style.setProperty('--ui-scale', String(scale));
        sceneEl.classList.add('scaled');
      }
    }
    function ensureFits() {
      // Paso 1: comprobar overflow
      if (assertNoOverflow()) return;

      // Paso 2: compactar
      applyCompactMode();
      if (assertNoOverflow()) return;

      // Paso 3: ajustar layout adicional
      fitBoardToViewport();
      if (assertNoOverflow()) return;

      // Paso 4: escalar
      autoscaleUI();
    }

    function enableGlobalScroll(enabled) {
      if (enabled) {
        document.documentElement.style.overflowY = 'auto';
        document.body.style.overflowY = 'auto';
        document.documentElement.style.overscrollBehavior = 'auto';
        document.body.style.overscrollBehavior = 'auto';
      } else {
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overscrollBehavior = 'none';
        document.body.style.overscrollBehavior = 'none';
      }
    }

    /* ==============================
       Eventos
       ============================== */
    window.addEventListener('resize', () => ensureFits());
    window.addEventListener('orientationchange', () => setTimeout(ensureFits, 100));
    document.getElementById('startBtn').addEventListener('click', startGame);

    /* ==============================
       Inicio
       ============================== */
    (function init(){
      setupInitData();

      // Precargar primer turno (intro visible)
      progressText.textContent = "Intro";
      dots.forEach(d => d.classList.remove('active'));

      // A√±adir mensaje de ambientaci√≥n nada m√°s cargar (bocadillo inicial en el chat)
      const introMsgs = [
        { who: "Lola", side: "left", mood: "üëã", text: "Hola Alex, estamos en guardia hoy. ¬°Listo para el reto?" },
        { who: "Sra. Ruiz", side: "left", mood: "üò∞", text: "Perdonen, me da miedo ese enchufe. ¬øPueden verlo?" }
      ];
      introMsgs.forEach(m => { history.push(m); renderMessage(m); });
      scrollChatToEnd();

      ensureFits();
    })();
  </script>
</body>
</html>