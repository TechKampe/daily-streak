<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Kämpe | Match PRL Eléctrica ⚡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">
  <style>
    /* Reset + base */
    *,*::before,*::after{box-sizing:border-box}
    :root{
      --blue-fn: #1b58ff;
      --blue-fn-2: #2e7bff;
      --ink: #0e1b2b;
      --glass: rgba(255,255,255,0.14);
      --glass-strong: rgba(255,255,255,0.22);
      --txt: #f6fbff;
      --accent: #40f0a8;
      --accent-2: #9bfffb;
      --warn: #ffd35a;
      --error: #ff5a6b;
      --gap: 10px;
      --hudH: 108px;
      --cols: 4;
      --rows: 2;
      --cellAR: 0.78; /* width / height */
      --radius: 14px;
      --ui-scale: 1;
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.25);
      --shadow-sm: 0 6px 16px rgba(0,0,0,0.18);
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);
      --titleSize: clamp(18px, 2.8vw, 22px);
      --cardText: clamp(13px, 2.6vw, 16px);
      --btnSize: clamp(15px, 3.2vw, 18px);
    }
    @media (max-width: 360px){
      :root{ --titleSize: 17px; --cardText: 13.5px; }
    }
    html,body{height:100%; background:#0c2b7a; color:var(--txt); font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    html, body { overflow: hidden; overscroll-behavior: none; }
    body{margin:0}

    /* Scene full height with safe fallbacks */
    .scene{
      position:relative;
      width:100%;
      height:100vh;
      padding: calc(10px + var(--safeTop)) calc(12px + var(--safeRight)) calc(10px + var(--safeBottom)) calc(12px + var(--safeLeft));
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:stretch;
      background:
        radial-gradient(120% 80% at 10% 10%, #4ca8ff 0%, rgba(76,168,255,0) 48%),
        radial-gradient(120% 80% at 90% 0%, #1ec8ff 0%, rgba(30,200,255,0) 40%),
        linear-gradient(160deg, #0d2b8a, #0b1d5a 70%);
      transform-origin: top center;
      transform: scale(var(--ui-scale));
    }
    @supports (height: 100svh) { .scene{ height:100svh; } }
    @supports not (height: 100svh) { .scene{ height:100dvh; } }
    @supports not (height: 100dvh) { .scene{ height:100vh; } }

    /* HUD */
    .hud{
      height: var(--hudH);
      min-height: var(--hudH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
      border:1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      box-shadow: var(--shadow-sm);
    }
    .brand img.logo{
      width:32px; height:32px; object-fit:contain; display:block;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.35));
    }
    .titles{
      display:flex; flex-direction:column; line-height:1.2;
    }
    .title{
      font-weight:800; font-size: var(--titleSize);
      letter-spacing: 0.2px;
      text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    }
    .subtitle{
      font-size: clamp(11px, 2.2vw, 13px); opacity:0.9;
    }
    .stats{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      min-width: 44px;
      padding:8px 10px;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.16);
      border-radius: 999px;
      font-weight:700; font-size:12.5px;
      display:flex; gap:6px; align-items:center;
    }
    .pill .dot{width:8px;height:8px;border-radius:50%;}
    .dot.green{background:var(--accent)}
    .dot.yellow{background:var(--warn)}
    .dot.red{background:var(--error)}

    /* Board wrapper */
    .board-wrap{
      position:relative;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 2px 8px 2px;
    }
    .avatar-bg{
      position:absolute; inset:auto -6px 4px auto;
      width: 36vw; max-width: 180px; opacity:0.18;
      transform: translate(10%, 0);
      pointer-events:none; user-select:none;
      filter: drop-shadow(0 8px 24px rgba(0,0,0,0.4));
    }
    .grid{
      --g: var(--gap);
      width: 100%;
      max-width: 560px;
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      gap: var(--g);
      align-content:center;
      justify-content:center;
      touch-action: none; /* anti-derrapes */
    }

    /* Card */
    .card{
      position:relative;
      perspective: 900px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cardBtn{
      cursor:pointer;
      width: 100%;
      aspect-ratio: var(--cellAR);
      border: none;
      background: transparent;
      padding:0;
      position:relative;
      display:block;
      border-radius: var(--radius);
      outline: none;
    }
    .face{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:10px;
      border-radius: var(--radius);
      backface-visibility: hidden;
      transition: transform 0.5s cubic-bezier(.2,.8,.2,1), box-shadow .25s, background .25s, border .25s;
      box-shadow: var(--shadow-lg);
      border:1px solid rgba(255,255,255,0.16);
    }
    .front{
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      transform: rotateY(0deg);
    }
    .back{
      background: linear-gradient(180deg, rgba(30,255,200,0.14), rgba(30,200,255,0.10));
      transform: rotateY(180deg);
    }
    .card.flipped .front{ transform: rotateY(-180deg); }
    .card.flipped .back { transform: rotateY(0deg); }
    .card.matched .back{
      background: linear-gradient(180deg, rgba(64,240,168,0.24), rgba(64,240,168,0.18));
      border-color: rgba(64,240,168,0.5);
      box-shadow: 0 0 0 2px rgba(64,240,168,0.45), 0 12px 28px rgba(0,0,0,0.35);
    }
    .face .text{
      font-size: var(--cardText); font-weight:800; text-align:center;
      line-height:1.15;
      display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient: vertical; overflow:hidden;
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .face .qmark{ font-size: clamp(18px, 8vw, 32px); opacity:0.9; }

    /* CTAs */
    .btn{
      background: linear-gradient(180deg, #5bffce, #19e6a1);
      color:#05352a; border:none; border-radius:12px;
      box-shadow: 0 10px 22px rgba(25,230,161,0.32), inset 0 1px 0 rgba(255,255,255,0.45);
      padding: 12px 16px; font-weight:800; font-size: var(--btnSize);
      min-height: 44px; min-width: 44px; cursor:pointer;
    }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,0.28), rgba(255,255,255,0.18));
      color:var(--txt); box-shadow: var(--shadow-sm);
      border:1px solid rgba(255,255,255,0.24);
    }
    .btn:focus-visible{ outline: 3px solid #ffd35a; outline-offset: 2px; }

    /* Modals */
    .overlay{
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      padding: 14px;
      background: rgba(0,0,0,0.45);
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(680px, 96vw);
      max-height: 90svh;
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.08));
      border:1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      padding: 16px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal header{
      display:flex; align-items:center; gap:10px; margin-bottom:8px;
    }
    .modal h2{
      margin:0; font-size: clamp(18px, 4.6vw, 22px); font-weight:800;
    }
    .modal p{ margin: 8px 0; line-height:1.35; font-size: clamp(14px, 3.6vw, 16px); }
    .modal .actions{
      position: sticky; bottom:0; padding-top: 10px; margin-top: 10px;
      display:flex; gap:8px; justify-content:stretch;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,0.12) 40%);
      padding-bottom: 4px;
    }
    .modal .actions .btn{ flex: 1 1 auto; }
    .warn-note{ color: var(--warn); font-size: 12.5px; }

    /* Results list */
    .pair-card{
      border-radius: 12px; padding: 12px; margin: 10px 0;
      background: rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.18);
    }
    .pair-card h3{
      font-size: clamp(14px, 3.8vw, 17px); margin: 0 0 6px;
    }
    .pair-card p{ margin: 6px 0; font-size: clamp(13px, 3.4vw, 15px); }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius: 999px; font-weight:800; font-size:12px;
      border:1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.12);
    }
    .badge.ok{ background: rgba(64,240,168,0.18); border-color: rgba(64,240,168,0.55); color:#d4ffef; }
    .badge.no{ background: rgba(255,90,107,0.18); border-color: rgba(255,90,107,0.55); color:#ffdbe0; }

    /* Compact mode: reduce HUD and fonts, hide subtitle */
    .compact .hud{ --hudH: 92px; }
    .compact .subtitle{ display:none; }
    .compact :root{ --titleSize: 16px; --cardText: 12.5px; --btnSize: 15px; }

    /* Focus styles for accessibility */
    .cardBtn:focus-visible .front, .cardBtn:focus-visible .back{
      box-shadow: 0 0 0 3px rgba(255,211,90,0.8), var(--shadow-lg);
    }

    /* Footer help text (small) */
    .foot-help{
      font-size: 12px; opacity:0.85; text-align:center; margin-top: 4px;
    }

  </style>
</head>
<body>
  <div class="scene" id="scene" aria-label="Match PRL Eléctrica">
    <!-- HUD -->
    <div class="hud">
      <div class="brand" aria-hidden="true">
        <img class="logo" src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe" width="32" height="32">
        <div class="titles">
          <div class="title">Match PRL Eléctrica ⚡</div>
          <div class="subtitle">Empareja conceptos clave de seguridad y uso</div>
        </div>
      </div>
      <div class="stats" aria-live="polite">
        <div class="pill" id="attemptsPill" title="Intentos restantes" aria-label="Intentos restantes">
          <span class="dot yellow"></span><span><strong id="triesLeft">12</strong> / 12</span>
        </div>
        <div class="pill" id="matchesPill" title="Parejas acertadas" aria-label="Parejas acertadas">
          <span class="dot green"></span><span><strong id="hits">0</strong>/4</span>
        </div>
      </div>
    </div>

    <!-- Board -->
    <div class="board-wrap">
      <img class="avatar-bg" src="https://techkampe.github.io/daily-streak/assets/Avatar%204_low.png" alt="" aria-hidden="true" loading="lazy">
      <div class="grid" id="board" role="grid" aria-label="Tablero de memoria de 8 cartas">
        <!-- Cards injected by JS -->
      </div>
    </div>

    <div class="foot-help" aria-hidden="true">Voltea 2 cartas por turno. ¡Busca precisión más que velocidad!</div>

    <!-- Intro Modal -->
    <div class="overlay show" id="introOv" aria-modal="true" role="dialog" aria-labelledby="introH2">
      <div class="modal">
        <header>
          <h2 id="introH2">Match PRL Eléctrica ⚡</h2>
        </header>
        <p>Eres aprendiz en una instalación doméstica; antes de tocar cables, tu oficial te pide repasar seguridad básica.</p>
        <p>Objetivo: fija vocabulario de PRL y herramientas eléctricas asociando cada término con su función correcta.</p>
        <p><strong>Tutorial:</strong> Destapa 2 cartas por turno. Si coinciden, quedan bloqueadas; si no, se ocultan tras 1 segundo. Tienes 12 intentos para 4 parejas.</p>
        <div class="actions">
          <button class="btn" id="startBtn" aria-label="Empezar el reto">¡Empezar!</button>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div class="overlay" id="resultsOv" aria-modal="true" role="dialog" aria-labelledby="resH2">
      <div class="modal" id="resultsModal">
        <header>
          <h2 id="resH2">Resultados del reto</h2>
        </header>
        <p id="scoreLine">Has encontrado 0/4 parejas con 0 intentos usados.</p>

        <div id="pairsDetails">
          <!-- Pairs explanations injected -->
        </div>

        <div class="pair-card" role="note" aria-label="Consejo de estudio">
          <h3>Tip de memorización P.A.R.A.</h3>
          <p>Recuerda P.A.R.A.: Proteger, Aislar, Revisar, Avisar. Repítelo en voz alta al preparar tu intervención.</p>
        </div>

        <div class="actions">
          <button class="btn" id="rewardBtn" aria-label="Ver mi recompensa">Ver mi recompensa</button>
        </div>
        <p class="warn-note" id="initDataWarn" style="display:none;">Aviso: initData no recibido. Puedes continuar igualmente.</p>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Data and helpers
    // -----------------------------
    const PAIRS = [
      {
        id: 'epi',
        a: 'EPI',
        b: 'Equipo de Protección Individual',
        expl: 'Póntelo antes de entrar a la zona de trabajo. Casco, gafas y botas reducen riesgos en tareas eléctricas.',
        ex: 'Ejemplo: casco + gafas al entrar al cuarto de contadores.'
      },
      {
        id: 'multimetro',
        a: 'Multímetro',
        b: 'Medir tensión',
        expl: 'Antes de tocar un circuito, comprueba si hay tensión. Selecciona el rango correcto y mide entre fase y neutro.',
        ex: 'Ejemplo: verifica 230 V en un enchufe antes de desmontarlo.'
      },
      {
        id: 'bloqueo',
        a: 'Bloqueo-etiquetado',
        b: 'Cortar y señalizar energía',
        expl: 'Desconecta el circuito y coloca candado y etiqueta para evitar reconexiones accidentales.',
        ex: 'Ejemplo: candado en magneto y tarjeta de “No energizar”.'
      },
      {
        id: 'guantes',
        a: 'Guantes dieléctricos',
        b: 'Aíslan de la corriente',
        expl: 'Úsalos al manipular cables o cuadros. Revisa cortes y fecha de ensayo antes de ponértelos.',
        ex: 'Ejemplo: guantes clase 0 al revisar un cuadro doméstico.'
      }
    ];
    const MAX_ATTEMPTS = 12;

    // Clamp helper for safety (truncate to max length)
    function clampText(txt, max=48) {
      if (!txt) return '';
      const t = txt.trim();
      return t.length > max ? t.slice(0, max-1) + '…' : t;
    }

    // Querystring initData
    const params = new URLSearchParams(location.search);
    const initData = params.get('initData') || "";

    // State
    const state = {
      deck: [],
      first: null,
      second: null,
      lock: false,
      attempts: 0,
      hits: 0,
      finished: false,
      matchedIds: new Set()
    };

    // DOM
    const scene = document.getElementById('scene');
    const board = document.getElementById('board');
    const introOv = document.getElementById('introOv');
    const resultsOv = document.getElementById('resultsOv');
    const startBtn = document.getElementById('startBtn');
    const triesLeftEl = document.getElementById('triesLeft');
    const hitsEl = document.getElementById('hits');
    const attemptsPill = document.getElementById('attemptsPill');
    const rewardBtn = document.getElementById('rewardBtn');
    const pairsDetails = document.getElementById('pairsDetails');
    const scoreLine = document.getElementById('scoreLine');
    const initDataWarn = document.getElementById('initDataWarn');

    // -----------------------------
    // Build deck
    // -----------------------------
    function buildDeck() {
      const deck = [];
      // Each pair becomes two cards with same pairId but different sides
      PAIRS.forEach(p => {
        deck.push({ key: p.id + '_a', pairId: p.id, label: clampText(p.a), matched:false });
        deck.push({ key: p.id + '_b', pairId: p.id, label: clampText(p.b), matched:false });
      });
      // Shuffle (Fisher–Yates)
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      state.deck = deck;
    }

    // -----------------------------
    // Render cards
    // -----------------------------
    function renderBoard() {
      board.innerHTML = '';
      state.deck.forEach((card, idx) => {
        const cell = document.createElement('div');
        cell.className = 'card';
        cell.setAttribute('role','gridcell');
        cell.setAttribute('aria-selected','false');

        const btn = document.createElement('button');
        btn.className = 'cardBtn';
        btn.type = 'button';
        btn.setAttribute('aria-label', 'Carta de memoria');
        btn.dataset.index = idx;

        const front = document.createElement('div');
        front.className = 'face front';
        const qm = document.createElement('div');
        qm.className = 'qmark';
        qm.textContent = '¿?';
        front.appendChild(qm);

        const back = document.createElement('div');
        back.className = 'face back';
        const txt = document.createElement('div');
        txt.className = 'text';
        txt.textContent = card.label;
        back.appendChild(txt);

        btn.appendChild(front);
        btn.appendChild(back);
        cell.appendChild(btn);
        board.appendChild(cell);
      });
    }

    // -----------------------------
    // Gameplay logic
    // -----------------------------
    function flipCard(idx) {
      if (state.lock || state.finished) return;
      const cardEl = board.children[idx];
      if (!cardEl) return;

      const btn = cardEl.querySelector('.cardBtn');
      const card = state.deck[idx];
      if (card.matched) return;

      // Prevent clicking the same card for second pick
      if (state.first && state.first.idx === idx) return;

      cardEl.classList.add('flipped');
      btn.setAttribute('aria-pressed','true');

      if (!state.first) {
        state.first = { idx, card };
      } else if (!state.second) {
        state.second = { idx, card };
        state.lock = true;

        // Count an attempt when two cards are revealed
        state.attempts++;
        updateHUD();

        // Check match
        const isMatch = state.first.card.pairId === state.second.card.pairId;
        if (isMatch) {
          state.deck[state.first.idx].matched = true;
          state.deck[state.second.idx].matched = true;
          state.matchedIds.add(state.first.card.pairId);
          state.hits++;
          setTimeout(() => {
            board.children[state.first.idx].classList.add('matched');
            board.children[state.second.idx].classList.add('matched');
            resetPick();
            updateHUD();
            checkEnd();
          }, 280);
        } else {
          setTimeout(() => {
            // Flip back
            const a = board.children[state.first.idx];
            const b = board.children[state.second.idx];
            a.classList.remove('flipped');
            b.classList.remove('flipped');
            a.querySelector('.cardBtn').setAttribute('aria-pressed','false');
            b.querySelector('.cardBtn').setAttribute('aria-pressed','false');
            resetPick();
            checkEnd();
          }, 900);
        }
      }
    }

    function resetPick() {
      state.first = null;
      state.second = null;
      state.lock = false;
    }

    function updateHUD() {
      const left = Math.max(0, MAX_ATTEMPTS - state.attempts);
      triesLeftEl.textContent = left.toString();
      hitsEl.textContent = state.hits.toString();

      // Color logic attempts
      if (left <= 3) {
        attemptsPill.querySelector('.dot').className = 'dot red';
      } else if (left <= 6) {
        attemptsPill.querySelector('.dot').className = 'dot yellow';
      } else {
        attemptsPill.querySelector('.dot').className = 'dot green';
      }
    }

    function checkEnd() {
      if (state.hits === PAIRS.length) {
        endGame(true);
      } else if (state.attempts >= MAX_ATTEMPTS) {
        endGame(false);
      }
    }

    function endGame(success) {
      state.finished = true;
      // Disable board interaction
      board.style.pointerEvents = 'none';
      showResults();
      // Make page scrollable only now if needed
      document.documentElement.style.overflowY = 'auto';
      document.body.style.overflowY = 'auto';
    }

    // -----------------------------
    // Results modal
    // -----------------------------
    function showResults() {
      const used = state.attempts;
      const left = Math.max(0, MAX_ATTEMPTS - used);
      scoreLine.textContent = `Has encontrado ${state.hits}/${PAIRS.length} parejas usando ${used} intentos. Te quedaron ${left}.`;

      pairsDetails.innerHTML = '';
      PAIRS.forEach(p => {
        const ok = state.matchedIds.has(p.id);
        const row = document.createElement('div');
        row.className = 'pair-card';
        const h = document.createElement('h3');
        h.innerHTML = `<span class="badge ${ok ? 'ok':'no'}">${ok ? 'Acertada' : 'No encontrada'}</span> ${p.a} ↔ ${p.b}`;
        const exp = document.createElement('p');
        exp.textContent = clampExpl(`${p.expl}`); // ensure under 180
        const exa = document.createElement('p');
        exa.style.opacity = 0.9;
        exa.textContent = clampExpl(p.ex);
        row.appendChild(h);
        row.appendChild(exp);
        row.appendChild(exa);
        pairsDetails.appendChild(row);
      });

      if (!initData) {
        initDataWarn.style.display = 'block';
      }

      resultsOv.classList.add('show');
      // Ensure modal is top-focused
      setTimeout(() => {
        resultsOv.querySelector('.modal').focus({preventScroll:true});
      }, 30);
    }

    function clampExpl(t) {
      const s = (t || '').trim();
      // limit to 180 chars
      return s.length > 180 ? s.slice(0,179) + '…' : s;
    }

    // -----------------------------
    // Fit to screen: ensureFits()
    // -----------------------------
    function assertNoOverflow() {
      const sc = scene.scrollHeight <= scene.clientHeight;
      return sc;
    }
    function applyCompactMode() {
      if (!document.body.classList.contains('compact')) {
        document.body.classList.add('compact');
      }
    }
    function fitBoardToViewport() {
      // Adjust aspect ratio so total board height fits within available space
      const hudH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hudH')) || 104;
      const totalH = scene.clientHeight;
      // Additional margins/paddings approximations + help text
      const reserved = hudH + 24 + 24; // hud + paddings + foot-help
      const availBoardH = Math.max(140, totalH - reserved);
      const styles = getComputedStyle(document.documentElement);
      const cols = parseInt(styles.getPropertyValue('--cols')) || 4;
      const rows = parseInt(styles.getPropertyValue('--rows')) || 2;
      const gap = parseFloat(getComputedStyle(board).gap) || 10;
      const boardW = board.clientWidth > 0 ? board.clientWidth : scene.clientWidth - 24;
      const cellW = (boardW - gap * (cols - 1)) / cols;
      // Compute needed aspect ratio so that rows * (cellW/AR) + gaps <= availBoardH
      const gapsH = gap * (rows - 1);
      const maxCardH = (availBoardH - gapsH) / rows;
      let newAR = cellW / Math.max(80, maxCardH);
      // clamp AR to reasonable range
      newAR = Math.min(Math.max(newAR, 0.68), 1.25);
      document.documentElement.style.setProperty('--cellAR', newAR.toFixed(3));
    }
    function autoscaleUI() {
      // As last resort, scale down the entire scene slightly
      let scale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ui-scale')) || 1;
      if (assertNoOverflow()) return;
      // Try down to 0.88
      while (!assertNoOverflow() && scale > 0.88) {
        scale -= 0.02;
        document.documentElement.style.setProperty('--ui-scale', scale.toFixed(2));
      }
    }
    function ensureFits() {
      // 1. Check overflow
      if (assertNoOverflow()) return;
      // 2. Compact mode
      applyCompactMode();
      if (assertNoOverflow()) return;
      // 3. Refit board
      fitBoardToViewport();
      // Minor reflow delay then check
      setTimeout(() => {
        if (assertNoOverflow()) return;
        // 4. Autoscale as last resort
        autoscaleUI();
      }, 0);
    }

    // -----------------------------
    // Event bindings
    // -----------------------------
    function handleBoardClick(e) {
      const btn = e.target.closest('.cardBtn');
      if (!btn) return;
      const idx = parseInt(btn.dataset.index, 10);
      if (Number.isFinite(idx)) flipCard(idx);
    }

    function startGame() {
      introOv.classList.remove('show');
      // Lock global scroll during gameplay
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      ensureFits();
    }

    function goReward() {
      const url = "https://kampe-game-phaser.onrender.com/daily_streak?initData=" + encodeURIComponent(initData);
      location.href = url;
    }

    // -----------------------------
    // Initialize
    // -----------------------------
    function init() {
      // Setup grid variables for 8 cards (4x2)
      document.documentElement.style.setProperty('--cols', '4');
      document.documentElement.style.setProperty('--rows', '2');

      buildDeck();
      renderBoard();
      updateHUD();
      ensureFits();

      board.addEventListener('click', handleBoardClick);
      startBtn.addEventListener('click', startGame);
      rewardBtn.addEventListener('click', goReward);

      window.addEventListener('resize', () => { ensureFits(); });
      window.addEventListener('orientationchange', () => { setTimeout(ensureFits, 100); });

      // Safety: line-clamp long labels already clamped in data
    }

    // Kickoff
    init();
  </script>
</body>
</html>