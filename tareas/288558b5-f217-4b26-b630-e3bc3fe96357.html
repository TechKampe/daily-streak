<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kämpe | Chispa Segura ⚡</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#1e65ff">
  <style>
    /* ===== Reset y base ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden; /* Bloqueo de scroll durante gameplay */
      overscroll-behavior: none;
      background: #0f1d4a;
      color: #eaf2ff;
      font-family: 'Manrope', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    :root{
      --ui-scale: 1;
      --accent: #25f0ff;
      --accent-2: #7cff4d;
      --danger: #ff4d6d;
      --glass: rgba(255,255,255,0.12);
      --glass-2: rgba(255,255,255,0.18);
      --shadow: 0 10px 24px rgba(0,0,0,0.35);
      --hudH: 64px;
      --pad: 16px;
      --radius: 14px;
      --btnH: 56px;
      --avatarOpacity: .18;
    }
    body.compact {
      --hudH: 54px;
      --pad: 12px;
      --radius: 12px;
      --btnH: 52px;
    }
    body.scaled .ui { transform: scale(var(--ui-scale)); transform-origin: top center; }
    /* ===== Scene / altura segura ===== */
    .scene {
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      align-items: stretch;
      background: radial-gradient(120% 100% at 50% 0%, #2a6bff 0%, #0e2e8a 40%, #0b1f69 70%, #081547 100%);
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      isolation: isolate;
      touch-action: none; /* Anti-derrapes */
    }
    @supports (height: 100svh) { .scene{ height: 100svh; } }
    @supports not (height: 100svh) and (height: 100dvh) { .scene{ height: 100dvh; } }
    @supports not (height: 100svh) and not (height: 100dvh) { .scene{ height: 100vh; } }

    .ui { /* wrapper escalable */
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: var(--hudH) 1fr auto;
      gap: 8px;
    }

    /* ===== HUD ===== */
    .hud {
      height: var(--hudH);
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 0 var(--pad);
      position: relative;
      z-index: 5;
    }
    .hud .logo {
      height: calc(var(--hudH) - 18px);
      aspect-ratio: 632 / 176;
      object-fit: contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
    }
    .hud .titleBlock {
      min-width: 0;
    }
    h1.title {
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: clamp(18px, 2.8vh, 22px);
      text-shadow: 0 3px 8px rgba(0,0,0,0.35);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .progress {
      font-size: clamp(12px, 2vh, 14px);
      opacity: .9;
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.24);
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-block;
      backdrop-filter: blur(8px);
    }

    /* ===== Tablero / gameplay ===== */
    .board {
      position: relative;
      padding: 0 var(--pad);
      display: grid;
      align-items: center;
      justify-content: center;
    }
    .avatar {
      position: absolute;
      right: -8%;
      bottom: 8%;
      max-height: 76%;
      opacity: var(--avatarOpacity);
      pointer-events: none;
      user-select: none;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,0.45)) saturate(1.04);
      z-index: 0;
    }
    .card {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.10));
      border: 1px solid rgba(255,255,255,0.28);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 8px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .scenario {
      font-size: clamp(12px, 1.8vh, 14px);
      color: #dbe8ff;
      opacity: 0.95;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .scenario .tag {
      background: rgba(37,240,255,0.18);
      border: 1px solid rgba(37,240,255,0.4);
      color: #b7fff8;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
    }
    .statement {
      margin: 2px 0 2px 0;
      font-size: clamp(18px, 3.1vh, 22px);
      font-weight: 800;
      line-height: 1.15;
      letter-spacing: 0.2px;
      color: #ffffff;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* max 2 líneas */
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 2.4em;
    }
    .card::after{
      content:"";
      position:absolute; inset: -2px;
      border-radius: inherit;
      pointer-events: none;
      background: radial-gradient(120% 200% at 50% -20%, rgba(255,255,255,0.25) 0%, transparent 40%),
                  linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.06));
      mix-blend-mode: overlay;
    }

    /* Microfeedback visual */
    .microfb {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
    }
    .microfb .icon{
      width: 96px; height: 96px;
      border-radius: 50%;
      border: 6px solid transparent;
      transform: scale(0.8);
      opacity: 0;
      transition: all .22s ease;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,0.45));
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.18) 0, rgba(255,255,255,0.1) 50%, transparent 60%);
      backdrop-filter: blur(1px);
    }
    .card.correct .icon {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 6px rgba(124,255,77,0.25), 0 0 24px rgba(124,255,77,0.35) inset;
      opacity: 1; transform: scale(1);
      background-image:
        radial-gradient(circle at 50% 50%, rgba(124,255,77,0.20), rgba(124,255,77,0.08) 60%, transparent 70%);
    }
    .card.wrong .icon {
      border-color: var(--danger);
      box-shadow: 0 0 0 6px rgba(255,77,109,0.22), 0 0 24px rgba(255,77,109,0.35) inset;
      opacity: 1; transform: scale(1);
      background-image:
        radial-gradient(circle at 50% 50%, rgba(255,77,109,0.20), rgba(255,77,109,0.08) 60%, transparent 70%);
    }
    .tick, .cross {
      position: absolute;
      width: 48px; height: 8px;
      background: currentColor;
      border-radius: 6px;
      top: 50%; left: 50%;
      transform-origin: left center;
    }
    .tick { color: var(--accent-2); transform: translate(-40%, -50%) rotate(-45deg); }
    .tick::after {
      content:""; position:absolute; right:-10px; top:-14px;
      width: 80px; height: 8px; background: currentColor; border-radius: 6px; transform: rotate(90deg);
    }
    .cross { color: var(--danger); }
    .cross.one { transform: translate(-50%, -50%) rotate(45deg); }
    .cross.two { transform: translate(-50%, -50%) rotate(-45deg); }

    /* ===== CTA Botonera ===== */
    .cta {
      position: relative;
      z-index: 3;
      padding: 8px var(--pad) calc(8px + env(safe-area-inset-bottom));
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: center;
    }
    .btn {
      height: var(--btnH);
      min-height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.22);
      font-weight: 800;
      letter-spacing: .2px;
      font-size: clamp(16px, 2.4vh, 18px);
      color: #07122f;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.78));
      box-shadow: 0 8px 20px rgba(0,0,0,0.35), 0 0 0 4px rgba(255,255,255,0.06) inset;
      cursor: pointer;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
      outline: none;
      user-select: none;
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px) scale(0.995); }
    .btn:focus-visible { outline: 2px solid #fff; outline-offset: 2px; }
    .btn.true { background: linear-gradient(180deg, #9aff7f, #6dff51); }
    .btn.false { background: linear-gradient(180deg, #ffd0d9, #ff9fb2); }

    /* ===== Intro / Resultados (modales) ===== */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 10;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(6,16,54,0.66), rgba(6,16,54,0.66));
      padding: 12px;
    }
    .modal.open { display: grid; }
    .modal .sheet{
      width: min(720px, 94vw);
      max-height: 90svh;
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.12));
      border: 1px solid rgba(255,255,255,0.28);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow-y: auto; /* scroll local del modal */
      backdrop-filter: blur(12px);
    }
    .modal h2 {
      margin: 0 0 8px 0;
      font-size: clamp(18px, 2.6vh, 22px);
    }
    .modal p {
      margin: 6px 0 12px;
      font-size: clamp(14px, 2.1vh, 16px);
      opacity: .95;
    }
    .modal .sheet .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, transparent, rgba(8,20,70,0.25));
      padding-top: 6px;
    }
    .btn.primary {
      background: linear-gradient(180deg, #58d2ff, #25b4ff);
      color: #00132c;
      border: 1px solid rgba(255,255,255,0.38);
    }
    .btn.ghost {
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      color: #eaf2ff;
    }

    /* Cards de resultados */
    .results-list {
      display: grid;
      gap: 10px;
      margin-top: 8px;
    }
    .r-item {
      background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.08));
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 12px;
      padding: 10px;
    }
    .r-top {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }
    .r-statement {
      font-weight: 800;
      font-size: clamp(14px, 2.1vh, 16px);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,0.26);
      background: rgba(255,255,255,0.14);
      white-space: nowrap;
    }
    .pill.ok { background: rgba(124,255,77,0.18); border-color: rgba(124,255,77,0.5); color:#d8ffd1; }
    .pill.ko { background: rgba(255,77,109,0.18); border-color: rgba(255,77,109,0.5); color:#ffd6de; }
    .r-answers {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;
      font-size: 12px;
    }
    .r-explain {
      margin-top: 6px;
      font-size: clamp(13px, 2vh, 14px);
      opacity: .95;
    }
    .score {
      display: flex; align-items: center; gap: 10px;
      font-weight: 800;
      font-size: clamp(16px, 2.4vh, 18px);
    }
    .score .bar {
      flex: 1;
      height: 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.18);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .score .bar > i {
      display: block; height: 100%;
      background: linear-gradient(90deg, #6dff51, #25f0ff);
      width: 0%;
      transition: width .4s ease;
    }
    .tip {
      margin-top: 10px;
      background: linear-gradient(180deg, rgba(37,240,255,0.08), rgba(37,240,255,0.02));
      border: 1px solid rgba(37,240,255,0.32);
      border-radius: 12px;
      padding: 10px;
      font-size: clamp(13px, 2vh, 14px);
    }
    .tip ul { padding-left: 18px; margin: 6px 0; }
    .tip li { margin: 4px 0; }
    .note {
      font-size: 12px; opacity: .85;
    }
    /* Asegurar CTAs siempre visibles y 44px mínimo */
    .btn, .pill { min-height: 44px; display: inline-grid; place-items: center; }

    /* ===== Compact mode ajustes ===== */
    body.compact .avatar { opacity: 0.12; max-height: 70%; }
    body.compact .statement { font-size: clamp(16px, 2.7vh, 20px); }
    body.compact .btn { font-size: clamp(15px, 2.2vh, 17px); border-radius: 12px; }
    body.compact .hud .logo { height: calc(var(--hudH) - 22px); }
  </style>
</head>
<body>
  <div class="scene">
    <div class="ui" id="uiRoot" aria-labelledby="title">
      <header class="hud">
        <img class="logo" src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe" />
        <div class="titleBlock">
          <h1 id="title" class="title">Chispa Segura ⚡</h1>
          <span id="progress" class="progress" aria-live="polite">1/7</span>
        </div>
        <div></div>
      </header>

      <main class="board" role="main">
        <img class="avatar" src="https://techkampe.github.io/daily-streak/assets/Avatar%202_low.png" alt="" aria-hidden="true" loading="eager">
        <div class="card" id="card">
          <div class="scenario">
            <span class="tag">Visita 1</span>
            <span class="sc-text" id="scText">Revisión de enchufe que se calienta</span>
          </div>
          <div class="content">
            <p class="statement" id="statementText">...</p>
          </div>
          <div class="microfb" aria-hidden="true">
            <div class="icon">
              <span class="tick" hidden></span>
              <span class="cross one" hidden></span>
              <span class="cross two" hidden></span>
            </div>
          </div>
        </div>
      </main>

      <footer class="cta">
        <button id="btnTrue" class="btn true" aria-label="Elegir Verdadero">Verdadero</button>
        <button id="btnFalse" class="btn false" aria-label="Elegir Falso">Falso</button>
      </footer>
    </div>
  </div>

  <!-- Intro modal -->
  <section class="modal intro open" id="intro" role="dialog" aria-modal="true" aria-labelledby="introTitle">
    <div class="sheet">
      <h2 id="introTitle">Chispa Segura ⚡</h2>
      <p>
        Escenario: primera visita; un enchufe se calienta. Responde Verdadero/Falso: verás una señal de acierto/fallo y pasarás al siguiente.
      </p>
      <p style="margin-top:0">
        Objetivo: identificar prácticas básicas de seguridad y trato mínimo al cliente antes de intervenir.
      </p>
      <div class="actions">
        <button class="btn primary" id="startBtn">Empezar</button>
        <button class="btn ghost" id="howBtn" aria-label="Instrucciones rápidas">¿Cómo se juega?</button>
      </div>
    </div>
  </section>

  <!-- Resultados modal -->
  <section class="modal results" id="resultsModal" role="dialog" aria-modal="true" aria-labelledby="resTitle" aria-live="polite">
    <div class="sheet">
      <h2 id="resTitle">Resumen del reto</h2>
      <div class="score">
        Tu puntuación: <span id="scoreText">0/7</span>
        <div class="bar" aria-hidden="true"><i id="scoreBar" style="width:0%"></i></div>
      </div>

      <div class="results-list" id="resultsList" aria-describedby="resHint"></div>
      <p id="resHint" class="note">Consulta tus respuestas, la opción correcta y una breve razón técnica.</p>

      <div class="tip" id="finalTip">
        <strong>Consejo práctico final</strong>
        <ul>
          <li>Checklist EPI: guantes y calzado dieléctricos, gafas.</li>
          <li>Pasos: avisar al cliente, cortar circuito, comprobar ausencia de tensión, diagnosticar, actuar y dejar todo ordenado.</li>
        </ul>
      </div>

      <div class="actions">
        <button class="btn primary" id="rewardBtn">Ver mi recompensa</button>
        <span id="initWarning" class="note" style="display:none;">Aviso: initData no detectado.</span>
      </div>
    </div>
  </section>

  <script>
    // ============================
    // Utilidades y datos del reto
    // ============================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // Truncar con límite duro de caracteres (para cumplir UX hard limits)
    function truncate(str, max) {
      if (!str) return '';
      str = String(str);
      if (str.length <= max) return str;
      return str.slice(0, Math.max(0, max - 1)).trimEnd() + '…';
    }

    // Dataset: 7 afirmaciones (máx 48 chars) y explicación (máx 180 chars)
    const ITEMS = [
      {
        text: "Cortar corriente en el cuadro antes de abrir",
        correct: true,
        explain: "Siempre corta en el magnetotérmico del circuito. Evita energizaciones inesperadas y arcos al desmontar el enchufe."
      },
      {
        text: "Usar guantes dieléctricos al manipular tomas",
        correct: true,
        explain: "Los EPI dieléctricos aíslan de contactos indirectos. Úsalos junto a calzado y gafas de protección."
      },
      {
        text: "El buscapolos sustituye al comprobador",
        correct: false,
        explain: "El buscapolos es orientativo y no garantiza ausencia de tensión. Usa multímetro o comprobador homologado con autotest."
      },
      {
        text: "Avisar al cliente antes de cortar la luz",
        correct: true,
        explain: "Avisar evita sorpresas y pérdida de datos. La coordinación con el cliente reduce riesgos y quejas."
      },
      {
        text: "Verde/amarillo es el conductor de tierra",
        correct: true,
        explain: "Colores: verde/amarillo a tierra, azul neutro, marrón/negro fase. Confundirlos crea riesgo de choque."
      },
      {
        text: "Trabajar descalzo es seguro con suelo seco",
        correct: false,
        explain: "Aunque esté seco, el cuerpo sigue expuesto. Usa calzado aislante y asegúrate de que la zona esté seca y segura."
      },
      {
        text: "Comprobar si saltó el diferencial antes",
        correct: true,
        explain: "Si saltó el RCD puede indicar fuga o defecto. Restablécelo y diagnostica antes de desmontar el mecanismo."
      }
    ].map(it => ({
      text: truncate(it.text, 48),
      correct: it.correct,
      explain: truncate(it.explain, 180)
    }));

    // Estado del juego en memoria
    const state = {
      idx: 0,
      total: ITEMS.length,
      answers: [], // {chosen: true/false, correct: true/false}
      initData: ""
    };

    // ============================
    // Ajuste de layout / guardarraíles
    // ============================
    function assertNoOverflow() {
      const scene = $('.scene');
      if (!scene) return true;
      return scene.scrollHeight <= scene.clientHeight;
    }
    function applyCompactMode() {
      document.body.classList.add('compact');
    }
    function fitBoardToViewport() {
      // Reducir algunos detalles visuales para ganar espacio
      document.querySelector('.avatar')?.style.setProperty('opacity', '0.10');
    }
    function autoscaleUI() {
      const scene = $('.scene');
      const uiRoot = $('#uiRoot');
      if (!scene || !uiRoot) return;
      const ratio = scene.clientHeight / scene.scrollHeight;
      // Último recurso: escalar hasta 0.88 (mínimo)
      const target = Math.max(0.88, Math.min(1, ratio - 0.02));
      document.documentElement.style.setProperty('--ui-scale', String(target));
      document.body.classList.add('scaled');
    }
    function ensureFits() {
      // reset parcial para recalcular bajo condiciones actuales
      document.body.classList.remove('compact');
      document.body.classList.remove('scaled');
      document.documentElement.style.setProperty('--ui-scale', '1');

      if (assertNoOverflow()) return;
      applyCompactMode();
      if (assertNoOverflow()) return;
      fitBoardToViewport();
      // No confiamos en scrollHeight tras transform, así que aplicamos y terminamos
      autoscaleUI();
    }
    window.addEventListener('resize', ensureFits);
    window.addEventListener('orientationchange', ensureFits);

    // ============================
    // Render del turno y UI
    // ============================
    function updateProgress() {
      $('#progress').textContent = `${state.idx + 1}/${state.total}`;
    }
    function showStatement() {
      const current = ITEMS[state.idx];
      $('#statementText').textContent = current.text;
      $('#card').classList.remove('correct', 'wrong');
      // Reset micro iconos
      $$('.tick').forEach(el => el.hidden = true);
      $$('.cross').forEach(el => el.hidden = true);
      updateProgress();
      ensureFits();
    }

    // Microfeedback visual sin texto explicativo
    function microFeedback(isCorrect) {
      const card = $('#card');
      if (!card) return;
      card.classList.remove('correct', 'wrong');
      void card.offsetWidth; // flush
      if (isCorrect) {
        card.classList.add('correct');
        $$('.tick').forEach(el => el.hidden = false);
        $$('.cross').forEach(el => el.hidden = true);
      } else {
        card.classList.add('wrong');
        $$('.tick').forEach(el => el.hidden = true);
        $$('.cross').forEach(el => el.hidden = false);
      }
    }

    // Manejo de respuesta y avance
    let locked = false;
    function answer(chosenBool) {
      if (locked) return;
      locked = true;
      const current = ITEMS[state.idx];
      const isCorrect = chosenBool === current.correct;
      state.answers[state.idx] = { chosen: chosenBool, correct: current.correct };
      microFeedback(isCorrect);
      // Avanzar automáticamente
      setTimeout(() => {
        state.idx++;
        if (state.idx >= state.total) {
          showResults();
        } else {
          showStatement();
        }
        locked = false;
      }, 720);
    }

    // ============================
    // Resultados
    // ============================
    function showResults() {
      // Preparar listado
      const list = $('#resultsList');
      list.innerHTML = '';
      let score = 0;
      state.answers.forEach((ans, i) => {
        const item = ITEMS[i];
        const correct = ans.correct;
        const you = ans.chosen;
        const ok = you === correct;
        if (ok) score++;

        const div = document.createElement('div');
        div.className = 'r-item';
        div.innerHTML = `
          <div class="r-top">
            <div class="r-statement">${item.text}</div>
            <span class="pill ${ok ? 'ok' : 'ko'}">${ok ? 'Acertaste' : 'Fallaste'}</span>
          </div>
          <div class="r-answers">
            <span class="pill">Tu respuesta: <strong>${you ? 'Verdadero' : 'Falso'}</strong></span>
            <span class="pill">Correcta: <strong>${correct ? 'Verdadero' : 'Falso'}</strong></span>
          </div>
          <div class="r-explain">${item.explain}</div>
        `;
        list.appendChild(div);
      });

      // Score visual
      const scoreText = `${score}/${state.total}`;
      $('#scoreText').textContent = scoreText;
      $('#scoreBar').style.width = `${(score / state.total) * 100}%`;

      // Mostrar modal (scroll solo dentro del modal)
      $('#resultsModal').classList.add('open');
    }

    // ============================
    // initData y navegación final
    // ============================
    function getInitData() {
      try {
        const qs = new URLSearchParams(location.search);
        return qs.get('initData') || "";
      } catch {
        return "";
      }
    }
    function goToReward() {
      const qs = encodeURIComponent(state.initData || "");
      const url = `https://kampe-game-phaser.onrender.com/daily_streak?initData=${qs}`;
      location.href = url;
    }

    // ============================
    // Eventos
    // ============================
    document.addEventListener('DOMContentLoaded', () => {
      // initData
      state.initData = getInitData();
      if (!state.initData) {
        $('#initWarning').style.display = 'inline';
      }

      // Botones
      $('#btnTrue').addEventListener('click', () => answer(true));
      $('#btnFalse').addEventListener('click', () => answer(false));

      // Accesos rápidos teclado (opcional)
      window.addEventListener('keydown', (e) => {
        if ($('#resultsModal').classList.contains('open')) return;
        if (e.key.toLowerCase() === 'v' || e.key === 'ArrowLeft') answer(true);
        if (e.key.toLowerCase() === 'f' || e.key === 'ArrowRight') answer(false);
      });

      // Intro
      $('#startBtn').addEventListener('click', () => {
        $('#intro').classList.remove('open');
        showStatement();
        ensureFits();
      });
      $('#howBtn').addEventListener('click', () => {
        alert("Toca Verdadero o Falso. Verás un destello de acierto/fallo y avanzas al siguiente. Al final verás explicaciones y un consejo práctico.");
      });

      // CTA final
      $('#rewardBtn').addEventListener('click', goToReward);

      // Primer render (mientras está el modal de intro abierto)
      updateProgress();
      ensureFits();
    });
  </script>
</body>
</html>