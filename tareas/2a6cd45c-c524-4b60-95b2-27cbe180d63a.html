<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Kämpe | Elige la Herramienta ⚡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1d49ff">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* RESET + BASE */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    html, body { overflow: hidden; overscroll-behavior: none; background: #0f2cff; }
    :root{
      --ui-scale: 1;
      --hudH: 64px;
      --optH: 56px;
      --gap: 12px;
      --glass: rgba(255,255,255,0.16);
      --glass-strong: rgba(255,255,255,0.22);
      --glass-border: rgba(255,255,255,0.24);
      --shadow: 0 8px 28px rgba(0,0,0,0.35);
      --text: #f5f7ff;
      --muted: #d7dcff;
      --accent: #00f0ff;
      --success: #11d07a;
      --danger: #ff4d6d;
      --blue: #1d49ff;
      --blue2: #1539d7;
      --cardH: auto;
    }
    body{ font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; color: var(--text); }

    /* SCENE SIZE WITH SVH + FALLBACKS */
    .scene {
      position: relative;
      width: 100%;
      height: 100vh; /* fallback default */
      padding: calc(env(safe-area-inset-top, 0px) + 12px) 14px calc(env(safe-area-inset-bottom, 0px) + 14px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      transform-origin: top center;
      transform: scale(var(--ui-scale));
      background: radial-gradient(110% 120% at 80% -10%, #3ab1ff 0%, #2a5cff 35%, #1027a8 70%, #0b1553 100%);
      isolation: isolate;
      touch-action: none;
    }
    @supports (height: 100svh) { .scene { height: 100svh; } }
    @supports not (height: 100svh) and (height: 100dvh) { .scene { height: 100dvh; } }
    @supports not (height: 100svh) and not (height: 100dvh) { .scene { height: 100vh; } }

    /* BACKDROP ELEMENTS */
    .avatar-bg{
      position: absolute;
      right: -6%;
      top: 12%;
      width: min(56%, 360px);
      opacity: 0.18;
      pointer-events: none;
      filter: drop-shadow(0 16px 30px rgba(0,0,0,0.35));
      z-index: 0;
      transform: rotate(-4deg);
      user-select: none;
    }
    .glow{
      position: absolute;
      inset: -10%;
      background: radial-gradient(60% 40% at 70% 10%, rgba(0,255,255,0.18), transparent 60%),
                  radial-gradient(30% 30% at 10% 90%, rgba(255,0,170,0.16), transparent 60%);
      z-index: 0;
      pointer-events: none;
    }

    /* HEADER / HUD */
    .hud{
      z-index: 2;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: var(--gap);
      min-height: var(--hudH);
    }
    .logo{
      display:flex; align-items:center; gap:8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.08));
      padding: 6px 10px; border-radius: 12px;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .logo img{ height: 24px; width: auto; display:block; }
    .logo span{
      font-weight: 800; letter-spacing: 0.2px;
      font-size: clamp(12px, 3.4vw, 14px);
      color: #fff;
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }

    .progress{
      display: grid; align-items:center;
      gap: 6px; grid-template-columns: 1fr auto;
    }
    .bar{
      height: 10px; border-radius: 999px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      position: relative; overflow: hidden;
      backdrop-filter: blur(8px);
    }
    .bar > .fill{
      position: absolute; left: 0; top: 0; bottom: 0;
      width: 0%;
      background: linear-gradient(90deg, #06f0ff 0%, #47ffcf 100%);
      box-shadow: 0 0 12px #06f0ff80;
      border-radius: 999px;
      transition: width 320ms ease;
    }
    .counter{
      font-weight: 700;
      font-size: clamp(12px, 3.3vw, 14px);
      color: var(--muted);
    }

    .help-btn{
      justify-self: end;
      background: rgba(255,255,255,0.16);
      border: 1px solid var(--glass-border);
      color: #fff; font-weight: 700;
      padding: 8px 12px; border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      font-size: clamp(12px, 3.4vw, 14px);
    }

    /* MAIN AREA */
    .main{
      z-index: 2;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      align-content: start;
    }
    .title{
      margin: 0;
      font-weight: 800;
      font-size: clamp(18px, 5vw, 22px);
      letter-spacing: 0.2px;
      text-shadow: 0 2px 0 rgba(0,0,0,0.25);
    }
    .desc{
      margin: 2px 0 0 0;
      color: var(--muted);
      font-size: clamp(12px, 3.6vw, 14px);
      line-height: 1.2;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      max-height: 2.6em;
    }

    .card{
      display: grid; grid-template-rows: auto 1fr;
      gap: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.20), rgba(255,255,255,0.10));
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      min-height: 0;
      overflow: hidden;
    }
    .task{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 700;
      font-size: clamp(14px, 4.5vw, 16px);
      line-height: 1.2;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      max-height: 2.6em;
    }

    .options{
      display: grid;
      grid-template-rows: repeat(3, minmax(var(--optH), 1fr));
      gap: 10px;
      min-height: 0;
    }
    .opt{
      display: grid; grid-template-columns: auto 1fr auto;
      align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.24);
      color: #fff;
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      cursor: pointer; user-select: none;
      transition: transform 120ms ease, background 180ms ease, border-color 180ms ease, box-shadow 180ms ease;
      min-height: var(--optH);
      position: relative; overflow: hidden;
    }
    .opt:focus-visible{ outline: 3px solid #00ffe9; outline-offset: 2px; }
    .opt:hover{ transform: translateY(-1px); }
    .opt:active{ transform: translateY(0px) scale(0.98); }

    .opt .ico{
      width: 34px; height: 34px; border-radius: 10px;
      display:grid; place-items:center;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.22);
      font-size: 18px;
    }
    .opt .label{
      font-weight: 800; letter-spacing: 0.2px;
      font-size: clamp(13px, 4vw, 15px);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      max-height: 2.5em;
    }
    .opt .hint{
      color: #d6e2ff; opacity: 0.75; font-size: 12px; display:none;
    }
    .opt .mark{
      width: 20px; height: 20px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.65);
      display: grid; place-items:center;
      font-size: 12px; font-weight: 900;
      background: rgba(0,0,0,0.2);
    }
    .opt.selected{ border-color: #fff; background: rgba(255,255,255,0.22); }
    .opt.right{ border-color: var(--success); box-shadow: 0 0 0 2px rgba(17,208,122,0.5) inset, 0 10px 18px rgba(0,0,0,0.25); }
    .opt.right .mark{ background: #0fd68a; border-color: #cafff0; }
    .opt.wrong{ border-color: var(--danger); box-shadow: 0 0 0 2px rgba(255,77,109,0.5) inset, 0 10px 18px rgba(0,0,0,0.25); }
    .opt.wrong .mark{ background: #ff5a7a; border-color: #ffe3ea; }

    .fade-in{ animation: fadeIn 220ms ease both; }
    .fade-out{ animation: fadeOut 180ms ease both; }
    @keyframes fadeIn { from{ opacity: 0; transform: translateY(8px);} to{ opacity: 1; transform: translateY(0);} }
    @keyframes fadeOut { from{ opacity: 1; transform: translateY(0);} to{ opacity: 0; transform: translateY(-8px);} }

    /* FOOTER */
    .footer{
      z-index: 2;
      display: grid; grid-template-columns: 1fr auto;
      align-items: center; gap: 10px;
    }
    .tip{
      font-size: clamp(11px, 3.2vw, 12px);
      color: var(--muted);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden;
    }
    .skip{
      justify-self: end;
      background: linear-gradient(180deg, #09e1ff, #08b4ff);
      color: #03233f; font-weight: 900;
      border: none; border-radius: 12px;
      padding: 10px 14px;
      min-height: 44px; min-width: 44px;
      box-shadow: 0 10px 22px rgba(0, 255, 255, 0.35);
      font-size: clamp(13px, 3.8vw, 15px);
    }

    /* INTRO MODAL */
    .modal{
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(11,19,60,0.75), rgba(5,8,30,0.85));
      display: grid; place-items: center;
      z-index: 5;
    }
    .modal .panel{
      width: min(560px, 92%);
      max-height: 90svh;
      background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.10));
      border: 1px solid var(--glass-border);
      border-radius: 18px;
      padding: 16px;
      overflow-y: auto;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      text-align: center;
    }
    .modal h2{
      margin: 4px 0 6px 0;
      font-size: clamp(18px, 6vw, 22px); font-weight: 900;
    }
    .modal p{
      margin: 6px 0 12px 0;
      color: var(--muted);
      font-size: clamp(13px, 4vw, 15px);
    }
    .primary{
      display: inline-flex; align-items:center; justify-content:center;
      gap: 8px;
      background: linear-gradient(180deg, #09fbd3, #0cd4ff);
      color: #082042; font-weight: 900;
      border: none; border-radius: 14px;
      padding: 12px 16px; min-height: 48px; min-width: 44px;
      font-size: clamp(14px, 4.2vw, 16px);
      box-shadow: 0 10px 26px rgba(12,212,255,0.45);
    }

    /* RESULTS SCREEN */
    .results{
      position: fixed; inset: 0; z-index: 10; display: none;
      background: linear-gradient(180deg, #071041, #0b1553 65%);
      padding: calc(env(safe-area-inset-top, 0px) + 12px) 14px calc(env(safe-area-inset-bottom, 0px) + 18px);
      overflow-y: auto;
    }
    .results .header{
      display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;
      margin-bottom: 10px;
    }
    .results .header img{ height: 28px; }
    .results h2{
      margin: 4px 0 6px 0;
      font-size: clamp(18px, 6vw, 22px);
      font-weight: 900;
      color: #fff;
    }
    .score{
      background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.10));
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      padding: 10px 12px;
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px;
      margin-bottom: 10px;
    }
    .score .big{
      font-size: clamp(16px, 5.2vw, 18px); font-weight: 800;
    }
    .score .badge{
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.28);
      border-radius: 999px;
      padding: 6px 10px; font-weight: 800; font-size: 12px; color: #fff;
    }
    .list{
      display: grid; gap: 10px; margin-bottom: 14px;
    }
    .item{
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      border: 1px solid var(--glass-border);
      border-radius: 14px; padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .item .t{ font-weight: 800; margin: 0 0 6px 0; font-size: 14px; }
    .row{ display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 6px; }
    .tag{ background: rgba(0,0,0,0.28); border: 1px solid rgba(255,255,255,0.24); border-radius: 10px; padding: 6px 8px; font-size: 12px; }
    .ok{ color: #24e59f; border-color: #24e59f55; }
    .bad{ color: #ff7b95; border-color: #ff7b9555; }
    .explain{ font-size: 12px; color: var(--muted); line-height: 1.2; }
    .explain span{ color: #cfe8ff; }

    .tips{
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      border: 1px solid var(--glass-border); border-radius: 14px; padding: 10px 12px;
      margin-bottom: 12px;
    }
    .tips h3{ margin: 0 0 6px 0; font-size: 15px; font-weight: 800; }
    .tips ul{ margin: 0; padding-left: 14px; }
    .tips li{ margin: 4px 0; font-size: 13px; color: #e8f3ff; }

    .cta-row{
      position: sticky; bottom: 0; background: linear-gradient(180deg, transparent, rgba(7,16,65,0.92) 40%);
      padding: 10px 0 0 0;
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .secondary{
      background: rgba(255,255,255,0.14); color: #fff; font-weight: 900;
      border: 1px solid rgba(255,255,255,0.24);
      border-radius: 12px; min-height: 48px;
      box-shadow: var(--shadow); font-size: 14px;
    }
    .reward{
      background: linear-gradient(180deg, #00ffd9, #00b3ff); color: #001c2c;
      border: none; border-radius: 12px; min-height: 48px;
      font-weight: 900; box-shadow: 0 10px 24px rgba(0,255,255,0.4); font-size: 14px;
    }
    .warn{
      grid-column: 1/-1;
      margin-top: 6px; font-size: 12px; color: #ffd476;
      display: none;
    }

    /* COMPACT MODE */
    .compact .scene{ --hudH: 54px; --optH: 52px; --gap: 10px; }
    .compact .desc{ display:none; }
    .compact .title{ font-size: clamp(16px, 4.8vw, 20px); }
    .compact .opt .label{ font-size: clamp(12px, 3.8vw, 14px); }
    .compact .opt .ico{ width: 30px; height: 30px; }
    .compact .task{ font-size: clamp(13px, 4.2vw, 15px); }

    /* ACCESSIBILITY */
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

  </style>
</head>
<body>
  <div class="scene" id="scene" aria-live="polite">
    <img class="avatar-bg" src="https://techkampe.github.io/daily-streak/assets/Avatar%203_low.png" alt="" loading="eager" />
    <div class="glow"></div>

    <!-- HUD -->
    <header class="hud">
      <div class="logo" aria-label="Kämpe">
        <img src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe" />
        <span>Kämpe</span>
      </div>
      <div class="progress" aria-label="Progreso">
        <div class="bar" aria-hidden="true"><div class="fill" id="barFill" style="width:0%"></div></div>
        <div class="counter"><span id="step">0</span>/6</div>
      </div>
      <button class="help-btn" id="helpBtn" type="button" aria-label="Ver tutorial">¿Cómo jugar?</button>
    </header>

    <!-- MAIN -->
    <main class="main">
      <div>
        <h1 class="title">Elige la Herramienta ⚡</h1>
        <p class="desc" id="challengeDesc">Arregla detalles rápidos en una vivienda con un maletín básico. Reconoce la herramienta idónea y aplica criterio seguro.</p>
      </div>

      <section class="card">
        <div class="task" id="taskText">Tarea</div>
        <div class="options" id="options" role="listbox" aria-label="Opciones de herramienta">
          <!-- Options injected by JS -->
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="tip" id="tipText">Consejo: prioriza la herramienta segura y específica.</div>
      <button class="skip" id="skipBtn" type="button" aria-label="Saltar tarea">Saltar</button>
    </footer>

    <!-- INTRO MODAL -->
    <div class="modal" id="intro" role="dialog" aria-modal="true" aria-labelledby="introTitle">
      <div class="panel">
        <div class="header" style="display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; justify-items:center;">
          <img src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe" loading="eager" style="height:28px;">
          <strong style="opacity:.9;">Reto diario</strong>
        </div>
        <h2 id="introTitle">Elige la Herramienta ⚡</h2>
        <p>Selecciona la herramienta más adecuada en cada tarea. 6 turnos, respuestas cortas y sin scroll. ¿Listo/a?</p>
        <button class="primary" id="startBtn" type="button" aria-label="Empezar">Empezar</button>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <section class="results" id="results" aria-labelledby="resTitle">
    <div class="header">
      <img src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe" />
      <h2 id="resTitle">Resumen del reto</h2>
    </div>

    <div class="score">
      <div class="big"><span id="hits">0</span>/6 correctas</div>
      <div class="badge" id="badge">Bien hecho</div>
    </div>

    <div class="list" id="resultsList">
      <!-- items injected -->
    </div>

    <div class="tips">
      <h3>Consejos y seguridad (EPI)</h3>
      <ul>
        <li>Guantes dieléctricos y gafas al cortar o pelar conductores.</li>
        <li>Verifica tensión con multímetro antes de tocar bornes.</li>
        <li>Usa herramientas aisladas VDE en trabajo energizado.</li>
        <li>Ordena cables con bridas; corta el sobrante a ras.</li>
      </ul>
    </div>

    <div class="cta-row">
      <button class="secondary" id="retryBtn" type="button">Repetir</button>
      <button class="reward" id="rewardBtn" type="button">Ver mi recompensa</button>
      <div class="warn" id="warn">Aviso: initData no detectado. Aún puedes continuar.</div>
    </div>
  </section>

  <div class="sr-only" aria-live="polite" id="ariaLive"></div>

  <script>
    // STATE + DATA
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
    const clampLabel = (t, max=48) => (t.length > max ? t.slice(0, max-1) + '…' : t);

    const initData = new URLSearchParams(location.search).get('initData') || "";
    const hasInit = !!new URLSearchParams(location.search).get('initData');

    const tasks = [
      {
        task: "Pelar un conductor de 1,5 mm² sin dañar hilos.",
        options: [
          { icon:"🧰", label:"Pelacables ajustable", key:"pelacables", correct:true },
          { icon:"🔪", label:"Cúter", key:"cutter", correct:false },
          { icon:"🛠️", label:"Alicate universal", key:"alicate", correct:false }
        ],
        why: "El pelacables retira la funda sin morder el cobre. El cúter puede mellar hilos; el alicate universal aplasta y no es preciso.",
        tip: "Ajusta el calibre en 1,5 mm²; gira suave y tira recto."
      },
      {
        task: "Medir si hay 230 V en un enchufe.",
        options: [
          { icon:"📟", label:"Multímetro en volt AC", key:"multimetro", correct:true },
          { icon:"🔎", label:"Buscapolos", key:"buscapolos", correct:false },
          { icon:"🪛", label:"Destornillador", key:"destornillador", correct:false }
        ],
        why: "El multímetro mide tensión real entre fase y neutro. El buscapolos solo indica presencia; el destornillador no mide.",
        tip: "Coloca puntas en L y N; rango >230 V AC."
      },
      {
        task: "Apretar el borne de un interruptor.",
        options: [
          { icon:"🪛", label:"Destornillador aislado VDE", key:"destVDE", correct:true },
          { icon:"🔧", label:"Llave fija", key:"llavefija", correct:false },
          { icon:"🐊", label:"Alicate pico‑loro", key:"picoloro", correct:false }
        ],
        why: "El destornillador aislado encaja y protege frente a tensión. La llave fija y el pico‑loro no sirven para tornillos de borne.",
        tip: "Usa la punta correcta (plana/PH) para no barrer."
      },
      {
        task: "Cortar bridas o canaleta plástica.",
        options: [
          { icon:"✂️", label:"Tijera de electricista", key:"tijera", correct:true },
          { icon:"🪚", label:"Sierra de arco", key:"sierra", correct:false },
          { icon:"📟", label:"Multímetro", key:"multi2", correct:false }
        ],
        why: "La tijera corta limpio y a ras. La sierra es basta y peligrosa; el multímetro no corta.",
        tip: "Sujeta la brida y corta al ras para evitar aristas."
      },
      {
        task: "Identificar la fase rápidamente.",
        options: [
          { icon:"🔎", label:"Buscapolos homologado", key:"bpk", correct:true },
          { icon:"🔨", label:"Martillo", key:"martillo", correct:false },
          { icon:"🔩", label:"Llaves Allen", key:"allen", correct:false }
        ],
        why: "El buscapolos indica fase al contacto. Martillo y Allen no detectan tensión.",
        tip: "Confirma con multímetro si vas a intervenir."
      },
      {
        task: "Cortar cable de 1,5 mm².",
        options: [
          { icon:"🔗", label:"Alicates de corte", key:"corte", correct:true },
          { icon:"🪚", label:"Serrucho", key:"serrucho", correct:false },
          { icon:"🧰", label:"Pelacables", key:"pelac2", correct:false }
        ],
        why: "El alicate de corte hace un corte limpio. El serrucho es peligroso; el pelacables no está diseñado para seccionar.",
        tip: "Corta perpendicular y lejos de los dedos."
      }
    ];

    // UI REFS
    const scene = qs('#scene');
    const taskText = qs('#taskText');
    const optionsEl = qs('#options');
    const stepEl = qs('#step');
    const barFill = qs('#barFill');
    const tipText = qs('#tipText');
    const intro = qs('#intro');
    const startBtn = qs('#startBtn');
    const helpBtn = qs('#helpBtn');
    const skipBtn = qs('#skipBtn');
    const ariaLive = qs('#ariaLive');
    const results = qs('#results');
    const hitsEl = qs('#hits');
    const badgeEl = qs('#badge');
    const resultsList = qs('#resultsList');
    const retryBtn = qs('#retryBtn');
    const rewardBtn = qs('#rewardBtn');
    const warn = qs('#warn');

    // GAME STATE
    let current = 0;
    let locked = false;
    const answers = []; // {index, chosenKey, correctKey, isCorrect}

    // AUDIO FEEDBACK via WebAudio (lightweight)
    let audioCtx;
    function beep(freq=880, dur=120, type='sine', vol=0.03){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.02); o.stop(audioCtx.currentTime + 0.03); }, dur);
      }catch(e){}
    }
    function haptic(pattern=[20]){
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    // RENDER
    function render(){
      const item = tasks[current];
      taskText.textContent = item.task;
      optionsEl.innerHTML = '';
      item.options.forEach((op, idx)=>{
        const btn = document.createElement('button');
        btn.className = 'opt fade-in';
        btn.setAttribute('role', 'option');
        btn.setAttribute('aria-label', op.label + (op.correct ? ' (correcta potencial)' : ''));
        btn.dataset.key = op.key;
        btn.dataset.correct = op.correct ? '1' : '0';
        btn.innerHTML = `
          <div class="ico" aria-hidden="true">${op.icon}</div>
          <div class="label">${clampLabel(op.label)}</div>
          <div class="mark">${idx+1}</div>
        `;
        btn.addEventListener('click', ()=>onChoose(btn, op));
        optionsEl.appendChild(btn);
      });

      stepEl.textContent = String(current+1);
      barFill.style.width = `${((current)/tasks.length)*100}%`;
      tipText.textContent = "Elige la herramienta idónea. ¡Seguridad primero!";
      ensureFits();
    }

    function onChoose(btn, op){
      if (locked) return;
      locked = true;
      const correctOption = tasks[current].options.find(o=>o.correct);
      const isCorrect = !!op.correct;

      // Visual
      qsa('.opt', optionsEl).forEach(el=>el.classList.remove('selected','right','wrong'));
      btn.classList.add('selected');
      setTimeout(()=>{
        btn.classList.add(isCorrect ? 'right':'wrong');
        // Mark also the right option if wrong
        if(!isCorrect){
          const rightBtn = qsa('.opt', optionsEl).find(el=>el.dataset.correct==='1');
          if (rightBtn) rightBtn.classList.add('right');
        }
      }, 60);

      // Feedback
      if (isCorrect){ beep(880,120,'sine'); haptic([15, 25, 15]); ariaLive.textContent = 'Correcto'; }
      else { beep(220,120,'triangle'); haptic([30, 60, 30]); ariaLive.textContent = 'Incorrecto'; }

      // Save
      answers.push({
        index: current,
        chosenKey: op.key,
        chosenLabel: op.label,
        correctKey: correctOption.key,
        correctLabel: correctOption.label,
        isCorrect
      });

      // Next after short delay
      setTimeout(()=>{
        // Slide out/in
        qsa('.opt', optionsEl).forEach(el=>{ el.classList.remove('fade-in'); el.classList.add('fade-out'); });
        setTimeout(()=>{
          current++;
          if (current < tasks.length){
            render();
          } else {
            finish();
          }
          locked = false;
        }, 180);
      }, 650);
    }

    function skip(){
      if (locked) return;
      // Register as skipped (wrong) but without penalizing explanation
      const correctOption = tasks[current].options.find(o=>o.correct);
      answers.push({
        index: current,
        chosenKey: '__skip__',
        chosenLabel: 'Saltado',
        correctKey: correctOption.key,
        correctLabel: correctOption.label,
        isCorrect: false
      });
      current++;
      if (current < tasks.length) render();
      else finish();
    }

    function finish(){
      // Fill final progress
      barFill.style.width = '100%';
      // Build results
      const hits = answers.filter(a=>a.isCorrect).length;
      hitsEl.textContent = String(hits);
      badgeEl.textContent = hits >= 5 ? '¡Pro nivel!' : hits >= 3 ? 'Bien hecho' : 'Sigue practicando';

      resultsList.innerHTML = '';
      answers.forEach(a=>{
        const t = tasks[a.index];
        const div = document.createElement('div');
        div.className = 'item';
        const chosenTxt = a.chosenLabel || '—';
        div.innerHTML = `
          <p class="t">${t.task}</p>
          <div class="row">
            <div class="tag ${a.isCorrect?'ok':'bad'}">Tu elección: ${clampLabel(chosenTxt, 48)}</div>
            <div class="tag ok">Correcta: ${clampLabel(t.options.find(o=>o.correct).label, 48)}</div>
          </div>
          <p class="explain"><span>Por qué:</span> ${truncate(t.why, 180)}</p>
          <p class="explain"><span>Tip:</span> ${truncate(t.tip, 180)}</p>
        `;
        resultsList.appendChild(div);
      });

      // Show results
      results.style.display = 'block';
      document.documentElement.style.overflowY = 'auto';
      document.body.style.overflowY = 'auto';
      if (!hasInit) warn.style.display = 'block';
      // Ensure focus
      results.setAttribute('tabindex', '-1');
      results.focus();
    }

    function truncate(str, max=180){
      if(!str) return '';
      return (str.length>max) ? str.slice(0, max-1) + '…' : str;
    }

    // FIT / RESPONSIVE ENSURE
    function assertNoOverflow(){
      const ok = scene.scrollHeight <= scene.clientHeight;
      return ok;
    }
    function applyCompactMode(){
      if (!document.body.classList.contains('compact')) {
        document.body.classList.add('compact');
      }
    }
    function fitBoardToViewport(){
      // Adjust option height if needed
      const currentOptH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--optH')) || 56;
      if (currentOptH > 48){
        document.documentElement.style.setProperty('--optH', (currentOptH - 4) + 'px');
      }
    }
    function autoscaleUI(min=0.88){
      let scale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ui-scale')) || 1;
      let guard = 0;
      while (!assertNoOverflow() && scale > min && guard < 10){
        scale = Math.max(min, +(scale - 0.02).toFixed(2));
        document.documentElement.style.setProperty('--ui-scale', scale);
        guard++;
      }
    }
    function ensureFits(){
      // Reset baseline on each call
      document.documentElement.style.setProperty('--ui-scale', '1');
      document.documentElement.style.setProperty('--optH', '56px');
      document.body.classList.remove('compact');

      // 1) Check
      if (assertNoOverflow()) return;
      // 2) Compact
      applyCompactMode();
      if (assertNoOverflow()) return;
      // 3) Recalc grid sizes
      fitBoardToViewport();
      if (assertNoOverflow()) return;
      // 4) Autoscale
      autoscaleUI();
    }

    // EVENTS
    startBtn.addEventListener('click', ()=>{
      intro.style.display = 'none';
      render();
      ensureFits();
    });
    helpBtn.addEventListener('click', ()=>{
      intro.style.display = 'grid';
    });
    skipBtn.addEventListener('click', skip);

    retryBtn.addEventListener('click', ()=>{
      // Reset all
      current = 0; locked = false;
      answers.length = 0;
      results.style.display = 'none';
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      barFill.style.width = '0%';
      stepEl.textContent = '1';
      render();
      haptic([10]);
    });

    rewardBtn.addEventListener('click', ()=>{
      const url = `https://kampe-game-phaser.onrender.com/daily_streak?initData=${encodeURIComponent(initData)}`;
      location.href = url;
    });

    // INIT: preset description clamp and welcome
    window.addEventListener('resize', ()=> ensureFits());
    window.addEventListener('orientationchange', ()=> setTimeout(ensureFits, 200));
    document.addEventListener('visibilitychange', ()=> {
      if (document.visibilityState === 'visible') setTimeout(ensureFits, 100);
    });

    // Initial state (do not start automatically)
    stepEl.textContent = '0';
    warn.style.display = hasInit ? 'none' : 'block';

    // Accessibility: keyboard navigation
    optionsEl.addEventListener('keydown', (e)=>{
      const focusables = qsa('.opt', optionsEl);
      const idx = focusables.indexOf(document.activeElement);
      if (e.key === 'ArrowDown'){
        e.preventDefault();
        const next = focusables[Math.min(focusables.length-1, (idx<0?0:idx+1))];
        next?.focus();
      } else if (e.key === 'ArrowUp'){
        e.preventDefault();
        const prev = focusables[Math.max(0, (idx>0?idx-1:0))];
        prev?.focus();
      } else if (e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        document.activeElement?.click();
      }
    });

    // Preload avatar fast
    // (No heavy assets; critical images already in DOM)

  </script>
</body>
</html>