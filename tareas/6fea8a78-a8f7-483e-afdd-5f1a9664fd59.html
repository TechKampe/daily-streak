<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Entrevista con el reclutador eléctrico • Kämpe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1373ff" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    /* Base reset + mobile safety */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    html, body { overflow: hidden; overscroll-behavior: none; background: #0e3cff; }
    :root {
      --blue-900: #0a2fd1;
      --blue-700: #1670ff;
      --blue-500: #34a0ff;
      --violet-500: #6a6cff;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.22);
      --text: #e9f2ff;
      --muted: #b8d3ff;
      --success: #29d17c;
      --warning: #ffd65a;
      --danger: #ff5d6e;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --ring: 0 0 0 3px rgba(255,255,255,0.4);
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
    }
    body {
      font-family: 'Manrope', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,0.12), transparent 60%),
        radial-gradient(800px 500px at 120% 10%, rgba(111,173,255,0.15), transparent 60%),
        linear-gradient(180deg, #0f47ff 0%, #0c2ccf 60%, #0b1b7d 100%);
    }

    /* App container */
    .app {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      padding: 0 var(--safe-left) 0 var(--safe-right);
    }

    /* Scene viewport with safe height (no scroll during gameplay) */
    .scene {
      width: min(860px, 100%);
      max-width: 100%;
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: var(--shadow);
      border-radius: 18px;
      backdrop-filter: blur(18px) saturate(120%);
      -webkit-backdrop-filter: blur(18px) saturate(120%);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: none;
      padding-top: calc(10px + var(--safe-top));
      padding-bottom: calc(10px + var(--safe-bot));
    }
    @supports (height: 100svh) { .scene { height: 100svh; } }
    @supports not (height: 100svh) { @supports (height: 100dvh) { .scene { height: 100dvh; } } }
    @supports not (height: 100svh) { @supports not (height: 100dvh) { .scene { height: 100vh; } } }

    /* Top bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      z-index: 3;
    }
    .logo {
      width: clamp(28px, 4vw, 36px);
      height: clamp(28px, 4vw, 36px);
      object-fit: contain;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.4));
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .title {
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: clamp(16px, 2.2vw + 10px, 22px);
      margin: 0;
      line-height: 1.1;
      text-shadow: 0 3px 18px rgba(0,0,0,0.45);
    }
    .subtitle {
      font-size: clamp(11px, 2vw + 6px, 13px);
      color: var(--muted);
      margin: 0;
      line-height: 1.2;
    }
    .progress {
      margin-left: auto;
      display: grid;
      justify-items: end;
      gap: 6px;
      min-width: 90px;
    }
    .progress-text {
      font-weight: 700;
      font-size: clamp(12px, 1.4vw + 8px, 14px);
      color: #f3f7ff;
    }
    .bar {
      width: 120px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.15);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .bar > span {
      display: block;
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #49d1ff, #6a8bff 50%, #24ffb5);
      box-shadow: 0 0 10px rgba(105,175,255,0.8);
      transition: width 260ms ease;
    }

    /* Content area (no scroll in gameplay) */
    .stage {
      position: relative;
      flex: 1;
      display: grid;
      grid-template-rows: 1fr auto;
      padding: 10px 14px 12px;
      gap: 8px;
      overflow: hidden;
    }

    /* Background decorative avatar (prominent but subtle) */
    .bg-avatar {
      position: absolute;
      right: -10px;
      bottom: 60px;
      width: 52%;
      max-width: 320px;
      opacity: 0.10;
      filter: saturate(120%) drop-shadow(0 12px 24px rgba(0,0,0,0.25));
      user-select: none;
      pointer-events: none;
      transform: scaleX(-1) rotate(-3deg);
    }

    /* Chat area (clamped, no scrolling) */
    .chat {
      position: relative;
      display: grid;
      align-content: end;
      gap: 8px;
      overflow: hidden;
    }
    .bubble {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: start;
      max-width: 100%;
      padding: 10px;
      border-radius: 14px;
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
      animation: pop 140ms ease-out both;
    }
    .bubble.reaction.correct { border-color: rgba(41,209,124,0.65); }
    .bubble.reaction.partial { border-color: rgba(255,214,90,0.65); }
    .bubble.reaction.wrong { border-color: rgba(255,93,110,0.65); }
    @keyframes pop { from { transform: translateY(8px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    .avatar {
      width: clamp(32px, 5vw, 42px);
      height: clamp(32px, 5vw, 42px);
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.75);
      object-fit: cover;
      background: #0d1a44;
    }
    .bubble .meta {
      margin-bottom: 4px;
      font-weight: 800;
      letter-spacing: 0.2px;
      color: #fff;
      font-size: clamp(12px, 1.8vw + 8px, 14px);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .bubble .text {
      font-size: clamp(14px, 2.2vw + 8px, 16px);
      color: #eef6ff;
      line-height: 1.25;
    }
    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 800;
      font-size: clamp(10px, 1.5vw + 7px, 12px);
      color: #0a1433;
      background: linear-gradient(180deg, #9fe7ff, #6bdfff);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 1px 0 rgba(0,0,0,0.1);
    }

    /* Choices area (sticky/fixed position within scene) */
    .choices {
      position: relative;
      display: grid;
      gap: 8px;
      padding: 10px 2px 2px;
      z-index: 2;
    }
    .choices-inner {
      position: sticky;
      bottom: 0;
      display: grid;
      gap: 8px;
      background: linear-gradient(180deg, transparent 0%, rgba(7,18,70,0.5) 40%, rgba(7,18,70,0.8) 100%);
      padding: 10px 12px calc(10px + var(--safe-bot));
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 14px;
      min-height: 48px;
      border-radius: 12px;
      border: 0;
      font-weight: 800;
      letter-spacing: 0.2px;
      cursor: pointer;
      color: #071743;
      background: linear-gradient(180deg, #c9e6ff, #7fc2ff);
      box-shadow: 0 6px 0 #3b72d6, 0 8px 18px rgba(0,0,0,0.35);
      font-size: clamp(14px, 2.5vw + 10px, 17px);
      transition: transform 80ms ease, box-shadow 80ms ease, filter 120ms ease;
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(2px); box-shadow: 0 4px 0 #3b72d6, 0 6px 12px rgba(0,0,0,0.3); }
    .btn:focus-visible { outline: none; box-shadow: 0 6px 0 #3b72d6, 0 8px 18px rgba(0,0,0,0.35), var(--ring); }
    .btn.alt {
      background: linear-gradient(180deg, #fff3c2, #ffd56d);
      box-shadow: 0 6px 0 #c7982c, 0 8px 18px rgba(0,0,0,0.35);
    }
    .btn.danger {
      background: linear-gradient(180deg, #ffc9d0, #ff97a2);
      box-shadow: 0 6px 0 #b24c56, 0 8px 18px rgba(0,0,0,0.35);
    }
    .btn.primary {
      background: linear-gradient(180deg, #99ffdf, #5ff1c0);
      box-shadow: 0 6px 0 #1d9a75, 0 8px 18px rgba(0,0,0,0.35);
      color: #052d1f;
    }

    .mini {
      font-size: clamp(11px, 2vw + 7px, 13px);
      color: var(--muted);
      text-align: center;
    }

    /* Intro screen */
    .intro {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100%;
      padding: 6px 14px 10px;
      gap: 10px;
    }
    .intro-card {
      display: grid;
      gap: 10px;
      align-content: start;
      padding: 14px;
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .intro h2 {
      margin: 0;
      font-size: clamp(18px, 3.5vw + 12px, 26px);
      line-height: 1.1;
      text-shadow: 0 3px 18px rgba(0,0,0,0.45);
    }
    .intro p {
      margin: 0;
      font-size: clamp(13px, 2.2vw + 9px, 16px);
      line-height: 1.25;
      color: #f3f8ff;
    }

    /* Results (scroll allowed) */
    .results {
      display: none;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      overflow-y: auto;
      padding: 12px 14px calc(14px + var(--safe-bot));
      scroll-behavior: smooth;
    }
    .mentor-callout {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      padding: 12px;
      background: rgba(41,209,124,0.16);
      border: 1px solid rgba(41,209,124,0.45);
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .results h3 {
      margin: 0;
      font-size: clamp(16px, 3vw + 10px, 22px);
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      margin-left: 6px;
      color: #001e12;
    }
    .pill.ok { background: #6bffbc; }
    .pill.partial { background: #ffe07a; }
    .pill.no { background: #ff9aa7; }

    .decision {
      display: grid;
      gap: 6px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .decision .q {
      font-weight: 800;
      color: #eef6ff;
      font-size: 14px;
    }
    .decision .a {
      color: #dfeaff;
      font-size: 14px;
    }
    .decision .explain {
      color: #cfe2ff;
      font-size: 13px;
    }

    .results-actions {
      display: grid;
      gap: 10px;
      margin-top: 4px;
    }
    .warn {
      color: #ffe5a6;
      font-size: 12px;
      text-align: center;
    }

    /* Accessibility helpers */
    .sr-only {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
    }

    /* Responsive minor tweaks */
    @media (min-width: 600px) {
      .bar { width: 160px; }
      .bg-avatar { width: 38%; max-width: 360px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="scene" id="scene" aria-live="polite">
      <header class="topbar">
        <img class="logo" src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="Kämpe logo" />
        <div class="title-wrap">
          <h1 class="title">Entrevista con el reclutador eléctrico</h1>
          <p class="subtitle">Simulación breve. Tono cercano y profesional.</p>
        </div>
        <div class="progress" aria-label="Progreso">
          <div class="progress-text" id="progressText">0/5</div>
          <div class="bar" aria-hidden="true"><span id="progressBar"></span></div>
        </div>
      </header>

      <!-- Intro -->
      <section class="intro" id="intro" role="region" aria-label="Introducción">
        <div class="intro-card">
          <h2>Bienvenido/a a Kämpe</h2>
          <p>Vas a vivir una entrevista para aprendiz electricista con un reclutador realista.</p>
          <p style="opacity:.9">Tutorial: elige una respuesta por turno. Verás la reacción y pasarás al siguiente.</p>
        </div>

        <div class="chat" aria-hidden="true">
          <img class="bg-avatar" src="https://techkampe.github.io/daily-streak/assets/Avatar%203_low.png" alt="" loading="lazy">
        </div>

        <div class="choices">
          <div class="choices-inner">
            <button class="btn primary" id="startBtn" aria-label="Empezar la simulación">Empezar</button>
            <div class="mini">Duración: 2–4 min • Sin scroll • Reacciones inmediatas</div>
          </div>
        </div>
      </section>

      <!-- Gameplay Stage -->
      <section class="stage" id="stage" role="region" aria-label="Entrevista" style="display:none;">
        <div class="chat" id="chatArea"></div>
        <img class="bg-avatar" src="https://techkampe.github.io/daily-streak/assets/Avatar%203_low.png" alt="" loading="lazy">
        <div class="choices">
          <div class="choices-inner" id="choicesInner">
            <!-- Buttons injected -->
          </div>
        </div>
      </section>

      <!-- Results -->
      <section class="results" id="results" role="region" aria-label="Resultados">
        <div class="mentor-callout">
          <img class="avatar" src="https://techkampe.github.io/daily-streak/assets/Avatar%201_low.png" alt="Mentor" loading="lazy">
          <div>
            <h3>Mentor</h3>
            <p style="margin:6px 0 0;">Buen trabajo. Repasemos tus decisiones y cómo pulir tus respuestas para brillar en la próxima entrevista.</p>
          </div>
        </div>

        <div id="summaryList" aria-live="polite"></div>

        <div class="decision" style="margin-top:6px;">
          <div class="q">Consejo práctico</div>
          <div class="a">En entrevistas, conecta tu motivación con aprendizaje, seguridad y valor al cliente. Usa ejemplos breves y concreta tus acciones (qué harás, cómo, con qué estándar).</div>
        </div>

        <div class="results-actions">
          <button class="btn primary" id="rewardBtn" aria-label="Ver mi recompensa">Ver mi recompensa</button>
          <div class="warn" id="initWarning" style="display:none;">No se encontró initData. Se continuará sin él.</div>
          <button class="btn alt" id="retryBtn" aria-label="Reintentar el desafío">Reintentar</button>
        </div>
        <div style="height:8px;"></div>
      </section>
    </div>
  </div>

  <script>
    // Preserve EXACT raw initData parameter
    function getRawInitData() {
      const q = window.location.search;
      const m = q.match(/[?&]initData=([^&#]*)/);
      return m ? m[1] : "";
    }
    const RAW_INIT = getRawInitData();

    // Lock gameplay scroll on load
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    // Elements
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const intro = document.getElementById('intro');
    const stage = document.getElementById('stage');
    const chatArea = document.getElementById('chatArea');
    const choicesInner = document.getElementById('choicesInner');
    const results = document.getElementById('results');
    const summaryList = document.getElementById('summaryList');
    const rewardBtn = document.getElementById('rewardBtn');
    const retryBtn = document.getElementById('retryBtn');
    const initWarning = document.getElementById('initWarning');

    // Avatars
    const AVATARS = {
      recruiter: "https://techkampe.github.io/daily-streak/assets/Avatar%203_low.png",
      mentor: "https://techkampe.github.io/daily-streak/assets/Avatar%201_low.png"
    };

    // Turns data
    const TURNS = [
      {
        topic: "Motivación",
        prompt: "¿Por qué quieres ser aprendiz electricista con nosotros?",
        options: [
          { label: "Quiero aprender de profesionales y crecer con proyectos reales.", type: "correct",
            react: "Eso queremos oír: ganas de aprender y aportar." ,
            explain: "Enfatizar aprendizaje, seguridad y valor al equipo demuestra mentalidad profesional."
          },
          { label: "Porque me gusta cacharrear cables desde siempre.", type: "partial",
            react: "Interés hay, pero cuida el tono y menciona seguridad/estándares.",
            explain: "El interés es válido, pero menciona prácticas seguras y objetivos formativos."
          },
          { label: "Para ganar buen dinero rápido.", type: "wrong",
            react: "El dinero importa, pero buscamos compromiso con el oficio.",
            explain: "Centrarse solo en dinero transmite poca orientación a aprendizaje y servicio."
          }
        ]
      },
      {
        topic: "Cliente",
        prompt: "Un cliente se queja por un retraso en la instalación. ¿Qué harías?",
        options: [
          { label: "Explico el motivo, propongo solución y confirmo por escrito.", type: "correct",
            react: "Bien: claridad, plan de acción y trazabilidad.",
            explain: "Transparencia + nueva cita/alternativa y confirmación escrita reducen fricción."
          },
          { label: "Pido disculpas y prometo ir cuanto antes, sin concretar.", type: "partial",
            react: "Falta concreción. Promesas vagas generan más frustración.",
            explain: "Disculparse ayuda, pero sin tiempos y plan claro no cierras el problema."
          },
          { label: "No es mi culpa; que hable con la oficina.", type: "wrong",
            react: "Derivar sin empatía da mala imagen del equipo.",
            explain: "Evitar culpas y mantener la comunicación con el cliente es clave."
          }
        ]
      },
      {
        topic: "Seguridad",
        prompt: "Ves a un compañero trabajando sin cortar la corriente. ¿Qué haces?",
        options: [
          { label: "Detengo el trabajo y aplico bloqueo/etiquetado; informo al supervisor.", type: "correct",
            react: "Correcto. Primero la vida: LOTO y comunicación.",
            explain: "Bloqueo/etiquetado (LOTO), verificar ausencia de tensión y escalar si es necesario."
          },
          { label: "Le aviso rápido y me vuelvo a lo mío.", type: "partial",
            react: "Mejor asegurar que se corrige y reportarlo.",
            explain: "Alertar ayuda, pero hay que verificar que se aísle y registrar el incidente."
          },
          { label: "Lo dejo; sabe lo que hace.", type: "wrong",
            react: "Riesgo grave. Nunca normalices prácticas inseguras.",
            explain: "Tolerar riesgos viola protocolos y pone vidas en peligro."
          }
        ]
      },
      {
        topic: "Diagnóstico",
        prompt: "Un circuito dispara el diferencial de forma intermitente. ¿Cómo procedes?",
        options: [
          { label: "Pruebo aislamiento con megóhmetro, reviso por tramos y registro consumos.", type: "correct",
            react: "Enfoque técnico y ordenado. +1.",
            explain: "Diagnóstico sistemático antes de reemplazar componentes evita fallos repetidos."
          },
          { label: "Reinicio el cuadro y observo si vuelve a pasar.", type: "partial",
            react: "Solo observar no basta. Falta medir y aislar la falla.",
            explain: "Observar sirve, pero hay que medir, etiquetar y acotar el tramo defectuoso."
          },
          { label: "Cambio el diferencial sin revisar.", type: "wrong",
            react: "Reemplazar a ciegas puede ocultar la causa real.",
            explain: "Saltar al reemplazo sin pruebas es mala práctica y costoso."
          }
        ]
      },
      {
        topic: "Actitud",
        prompt: "No conoces una norma o esquema. ¿Qué haces?",
        options: [
          { label: "Consulto manuales y pido guía a un oficial; tomo notas.", type: "correct",
            react: "Excelente: fuentes fiables y aprendizaje activo.",
            explain: "Buscar normativa y apoyo del equipo asegura calidad y aprendizaje."
          },
          { label: "Busco en internet un buen rato en horario.", type: "partial",
            react: "Útil como apoyo, pero controla el tiempo y valida fuentes.",
            explain: "Internet ayuda, pero prioriza documentación oficial y mentores."
          },
          { label: "Improviso y ya.", type: "wrong",
            react: "Riesgo y mala imagen. Mejor preguntar o documentarse.",
            explain: "Improvisar compromete seguridad, normas y confianza."
          }
        ]
      }
    ];

    const STATE = {
      current: 0,
      log: [] // {topic, choiceText, type, explain}
    };

    function setProgress() {
      const total = TURNS.length;
      const step = Math.min(STATE.current + 1, total);
      progressText.textContent = `${STATE.current}/${total}`;
      const w = (STATE.current / total) * 100;
      progressBar.style.width = w + '%';
    }

    function renderTurn() {
      // Update progress (before answering current turn)
      setProgress();

      const turn = TURNS[STATE.current];
      // Clear chat and choices
      chatArea.innerHTML = '';
      choicesInner.innerHTML = '';

      // Recruiter bubble (prompt)
      chatArea.appendChild(makeBubble({
        avatar: AVATARS.recruiter,
        name: 'Reclutador',
        tag: turn.topic,
        text: turn.prompt
      }));

      // Build choices (2-3 max)
      turn.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'btn' + (opt.type === 'wrong' ? ' danger' : (opt.type === 'partial' ? ' alt' : ''));
        btn.textContent = opt.label;
        btn.setAttribute('aria-label', `Elegir: ${opt.label}`);
        btn.onclick = () => chooseOption(opt);
        choicesInner.appendChild(btn);
      });
    }

    function makeBubble({ avatar, name, tag, text, kind }) {
      const wrap = document.createElement('div');
      wrap.className = 'bubble' + (kind ? ' reaction ' + kind : '');
      const img = document.createElement('img');
      img.className = 'avatar';
      img.src = avatar;
      img.alt = name;
      img.loading = "lazy";
      const content = document.createElement('div');
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span>${name}</span>` + (tag ? ` <span class="tag">${tag}</span>` : '');
      const tx = document.createElement('div');
      tx.className = 'text';
      tx.textContent = text;
      content.appendChild(meta);
      content.appendChild(tx);
      wrap.appendChild(img);
      wrap.appendChild(content);
      return wrap;
    }

    function chooseOption(opt) {
      // Disable choices to prevent double tap
      Array.from(choicesInner.querySelectorAll('button')).forEach(b => b.disabled = true);

      // Record decision
      const turn = TURNS[STATE.current];
      STATE.log.push({
        topic: turn.topic,
        prompt: turn.prompt,
        choiceText: opt.label,
        type: opt.type,
        explain: opt.explain
      });

      // Show reaction bubble
      const reaction = makeBubble({
        avatar: AVATARS.recruiter,
        name: 'Reclutador',
        text: opt.react,
        kind: opt.type
      });
      chatArea.appendChild(reaction);

      // Advance after short delay
      setTimeout(nextTurn, 1050);
    }

    function nextTurn() {
      STATE.current++;
      const total = TURNS.length;
      if (STATE.current < total) {
        renderTurn();
      } else {
        finish();
      }
    }

    function finish() {
      // Show full progress
      progressText.textContent = `${TURNS.length}/${TURNS.length}`;
      progressBar.style.width = '100%';

      // Hide gameplay, show results and enable scroll
      intro.style.display = 'none';
      stage.style.display = 'none';
      results.style.display = 'flex';
      document.documentElement.style.overflowY = 'auto';
      document.body.style.overflowY = 'auto';

      // Build summary
      const score = STATE.log.filter(x => x.type === 'correct').length;
      const header = document.createElement('div');
      header.className = 'decision';
      header.innerHTML = `<div class="q">Tu resultado</div>
        <div class="a">Respuestas correctas: <b>${score}/${TURNS.length}</b></div>
        <div class="explain">Repasa cada decisión: verás cuál era la opción profesional y por qué.</div>`;
      summaryList.innerHTML = '';
      summaryList.appendChild(header);

      STATE.log.forEach((d, i) => {
        const item = document.createElement('div');
        item.className = 'decision';
        const pillClass = d.type === 'correct' ? 'ok' : (d.type === 'partial' ? 'partial' : 'no');
        const label = d.type === 'correct' ? 'Correcta' : (d.type === 'partial' ? 'Parcial' : 'Incorrecta');
        item.innerHTML = `
          <div class="q">${i+1}. ${d.topic} <span class="pill ${pillClass}">${label}</span></div>
          <div class="a">${d.prompt}</div>
          <div class="a" style="opacity:.95"><b>Elegiste:</b> ${d.choiceText}</div>
          <div class="explain"><b>Por qué:</b> ${d.explain}</div>
        `;
        summaryList.appendChild(item);
      });

      // Reward button
      rewardBtn.onclick = () => {
        const url = "https://kampe-game-phaser.onrender.com/daily_streak?initData=" + RAW_INIT;
        window.location.href = url;
      };
      // Warning if no initData
      if (!RAW_INIT) initWarning.style.display = 'block';
    }

    function start() {
      intro.style.display = 'none';
      stage.style.display = 'grid';
      STATE.current = 0;
      STATE.log = [];
      setProgress();
      renderTurn();
    }

    // Events
    document.getElementById('startBtn').addEventListener('click', start, { passive: true });
    retryBtn.addEventListener('click', () => {
      // Lock gameplay scroll again
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      results.style.display = 'none';
      intro.style.display = 'none';
      stage.style.display = 'grid';
      STATE.current = 0;
      STATE.log = [];
      setProgress();
      renderTurn();
      // Scroll stage to top just in case
      document.getElementById('scene').scrollTop = 0;
    });

    // Initialize UI progress
    setProgress();
  </script>
</body>
</html>