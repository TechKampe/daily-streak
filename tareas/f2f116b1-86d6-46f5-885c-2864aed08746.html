
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>K√§mpe Reto: El Orden S√ç Altera el Circuito ‚ö°Ô∏è</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
    
    <style>
        /* ------------------- */
        /* --- RESET & SETUP --- */
        /* ------------------- */
        :root {
            --kampe-blue: #007BFF;
            --kampe-cyan: #00BFFF;
            --kampe-electric: #00F4E0;
            --bg-ivory: #FAF9F6;
            --text-dark: #333;
            --text-light: #f8f9fa;
            --grey-warm: #EAEAEA;
            --grey-medium: #888;
            --success: #28a745;
            --danger: #dc3545;
            --shadow-color: rgba(0, 123, 255, 0.1);

            /* Safe areas for iOS */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);

            --ui-scale: 1;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Baloo 2', cursive;
            background-color: var(--bg-ivory);
            color: var(--text-dark);
            overflow: hidden; /* Critical: No scroll during gameplay */
            overscroll-behavior: none;
        }
        
        body.results-active {
            overflow: hidden; /* Body remains locked */
        }
        
        button {
            font-family: 'Baloo 2', cursive;
            cursor: pointer;
        }

        /* -------------------- */
        /* --- MAIN SCENE --- */
        /* -------------------- */
        .scene {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Aligned to top for content flow */
            align-items: center;
            width: 100%;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Fallback */
            height: 100svh; /* Preferred */
            padding: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left);
            background-color: var(--bg-ivory);
            position: relative;
            overflow: hidden;
            background-image: url('https://techkampe.github.io/daily-streak/assets/Avatar%202_low.png');
            background-size: 80% auto;
            background-repeat: no-repeat;
            background-position: 50% 120%;
            background-blend-mode: luminosity;
            opacity: 0.5;
        }

        /* Viewport support fallbacks */
        @supports (height: 100svh) { .scene { height: 100svh; } }
        @supports not (height: 100svh) {
            @supports (height: 100dvh) { .scene { height: 100dvh; } }
            @supports not (height: 100dvh) { .scene { height: 100vh; } }
        }

        .game-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transform: scale(var(--ui-scale));
            transform-origin: top center;
            transition: transform 0.2s ease-out;
            z-index: 2;
        }

        .scene.compact .game-header { padding-top: 0; }
        .scene.compact .challenge-title { font-size: clamp(1.1rem, 4vw, 1.3rem); margin: 0.5rem 0; }


        /* -------------------- */
        /* --- GAME UI --- */
        /* -------------------- */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.5rem 0;
        }

        .kampe-logo {
            height: 30px;
            width: auto;
        }

        .progress-indicator {
            font-size: clamp(0.9rem, 4vw, 1.1rem);
            font-weight: 600;
            background: var(--grey-warm);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .challenge-title {
            text-align: center;
            font-size: clamp(1.25rem, 5vw, 1.5rem);
            font-weight: 700;
            margin: 1rem 0;
            line-height: 1.2;
        }

        .steps-container {
            flex-grow: 1;
            width: 100%;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden; /* Prevents internal scroll */
            touch-action: none;
        }

        .step-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), box-shadow 0.3s ease;
        }

        .step-item.moving {
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
        }

        .step-content {
            flex-grow: 1;
            padding: 0 10px;
            font-size: clamp(0.9rem, 3.8vw, 1rem);
            font-weight: 500;
            /* Text truncation */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 2.8em; /* Fallback for line-clamp */
            line-height: 1.4em;
        }

        .step-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .control-btn {
            background-color: var(--grey-warm);
            border: none;
            width: 44px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #d8d8d8;
        }
        .control-btn:focus-visible {
            outline: 2px solid var(--kampe-blue);
            outline-offset: 2px;
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--text-dark);
        }
        
        .game-footer {
            margin-top: auto; /* Pushes footer to the bottom */
            padding-top: 1rem;
            width: 100%;
        }


        /* -------------------- */
        /* --- MODALS --- */
        /* -------------------- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-ivory);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 450px;
            max-height: 90svh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: clamp(1.4rem, 5.5vw, 1.8rem);
            font-weight: 800;
            text-align: center;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .modal-description {
            font-size: clamp(0.9rem, 4vw, 1.05rem);
            text-align: center;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        /* Results Modal Specifics */
        .results-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .results-list {
            list-style: none;
        }
        .results-list h4 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .result-item {
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }
        .result-item.correct { background-color: #d4edda; }
        .result-item.incorrect { background-color: #f8d7da; }
        .result-item span {
            font-weight: 700;
            margin-right: 8px;
            min-width: 1.5em;
            text-align: center;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            width: 1.5em;
            height: 1.5em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .feedback-section {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }
        .feedback-section h5 {
            font-weight: 700;
            color: var(--kampe-blue);
            margin-bottom: 0.5rem;
        }
        .feedback-section p {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        #init-data-warning {
            text-align: center;
            font-size: 0.8rem;
            color: var(--grey-medium);
            margin-top: 1rem;
            display: none;
        }

        /* -------------------- */
        /* --- GENERIC COMPONENTS --- */
        /* -------------------- */
        .btn {
            display: block;
            width: 100%;
            padding: 14px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: clamp(1rem, 4.5vw, 1.2rem);
            color: var(--text-light);
            background-image: linear-gradient(45deg, var(--kampe-blue), var(--kampe-cyan));
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        .btn:focus-visible {
            outline: 2px solid var(--kampe-cyan);
            outline-offset: 3px;
        }
        .btn:active {
            transform: translateY(0);
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body>

    <main class="scene" id="main-scene">
        <div class="game-wrapper" id="game-wrapper">
            <!-- Game Header -->
            <header class="game-header" style="visibility: hidden;">
                <img src="https://techkampe.github.io/daily-streak/assets/kampe_logo_blanco.png" alt="K√§mpe Logo" class="kampe-logo">
                <div class="progress-indicator" id="progress-indicator">Reto 1/3</div>
            </header>
            
            <!-- Challenge Title -->
            <h1 class="challenge-title" id="challenge-title"></h1>

            <!-- Steps -->
            <ul class="steps-container" id="steps-list"></ul>

            <!-- Footer / CTA -->
            <footer class="game-footer" style="visibility: hidden;">
                <button class="btn" id="confirm-btn">Confirmar orden</button>
            </footer>
        </div>
    </main>

    <!-- Intro Modal -->
    <div class="modal-overlay visible" id="intro-modal">
        <div class="modal-content">
            <h2 class="modal-title">El Orden S√ç Altera el Circuito ‚ö°Ô∏è</h2>
            <p class="modal-description">Un cliente necesita cambiar un interruptor. Demuestra que conoces el protocolo de seguridad. Ordena los pasos en la secuencia correcta para completar cada reto y evitar riesgos.</p>
            <button class="btn" id="start-btn">¬°A ello!</button>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal-overlay" id="results-modal">
        <div class="modal-content">
            <h2 class="modal-title" id="result-title">Revisando tu secuencia...</h2>
            <div class="results-comparison" id="results-comparison">
                <!-- Content generated by JS -->
            </div>
            <div class="feedback-section">
                <h5>üí° Explicaci√≥n</h5>
                <p id="result-explanation"></p>
            </div>
            <div class="feedback-section">
                <h5>üõ°Ô∏è Consejo K√§mpe</h5>
                <p id="result-tip"></p>
            </div>
            <button class="btn" id="next-challenge-btn" style="margin-top: 1.5rem;">Siguiente Reto</button>
            <p id="init-data-warning">No se detect√≥ initData. El progreso no se guardar√°.</p>
        </div>
    </div>

    <!-- Template for a step item -->
    <template id="step-template">
        <li class="step-item">
            <div class="step-content"></div>
            <div class="step-controls">
                <button class="control-btn up-btn" aria-label="Mover hacia arriba">
                    <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg>
                </button>
                <button class="control-btn down-btn" aria-label="Mover hacia abajo">
                    <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
                </button>
            </div>
        </li>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const challenges = [
            {
                title: "Cambio de interruptor",
                correctOrder: [
                    "Cortar la corriente en el cuadro general.",
                    "Verificar ausencia de tensi√≥n con mult√≠metro.",
                    "Desmontar el embellecedor y el mecanismo.",
                    "Desconectar los cables del interruptor viejo.",
                    "Conectar el nuevo interruptor y fijarlo.",
                    "Restablecer la corriente y probar el circuito."
                ],
                explanation: "La seguridad es lo primero. Siempre corta la corriente y verifica que no hay tensi√≥n ANTES de tocar cualquier componente. El montaje es el proceso inverso.",
                tip: "La regla de oro del electricista: 'Las 5 Reglas de Oro'. ¬°Apr√©ndetelas! Cortar, bloquear, verificar, poner a tierra y proteger."
            },
            {
                title: "Instalaci√≥n de un enchufe",
                correctOrder: [
                    "Bajar el interruptor autom√°tico del circuito.",
                    "Identificar y pelar los cables con cuidado.",
                    "Conectar fase, neutro y tierra en sus bornes.",
                    "Atornillar el mecanismo en la caja de empotrar.",
                    "Colocar el marco embellecedor."
                ],
                explanation: "Aislar el circuito espec√≠fico es suficiente. La conexi√≥n correcta (Fase-Neutro-Tierra) es crucial para la seguridad y el funcionamiento del aparato.",
                tip: "Usa un buscapolos para identificar la fase, pero un mult√≠metro para confirmar la ausencia de tensi√≥n. ¬°Nunca te f√≠es solo de la luz del buscapolos!"
            },
            {
                title: "Protocolo de consignaci√≥n",
                correctOrder: [
                    "Identificar el circuito correcto en el cuadro.",
                    "Cortar la corriente del circuito a intervenir.",
                    "Bloquear y se√±alizar el interruptor autom√°tico.",
                    "Comprobar ausencia de tensi√≥n en el punto de trabajo."
                ],
                explanation: "Este es el protocolo profesional de consignaci√≥n. Bloquear y se√±alizar evita que alguien rearme la corriente por error mientras trabajas.",
                tip: "Si no puedes bloquear el interruptor, como m√≠nimo, deja una nota clara y visible: 'NO CONECTAR - TRABAJOS EN CURSO'."
            }
        ];

        // --- STATE ---
        const gameState = {
            currentChallengeIndex: 0,
            totalChallenges: challenges.length,
            initData: ''
        };

        // --- DOM ELEMENTS ---
        const scene = document.getElementById('main-scene');
        const gameWrapper = document.getElementById('game-wrapper');
        const introModal = document.getElementById('intro-modal');
        const resultsModal = document.getElementById('results-modal');
        const startBtn = document.getElementById('start-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const nextChallengeBtn = document.getElementById('next-challenge-btn');
        const stepsList = document.getElementById('steps-list');
        const stepTemplate = document.getElementById('step-template');
        const progressIndicator = document.getElementById('progress-indicator');
        const challengeTitle = document.getElementById('challenge-title');
        const gameHeader = document.querySelector('.game-header');
        const gameFooter = document.querySelector('.game-footer');
        
        // --- INITIALIZATION ---
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            gameState.initData = urlParams.get('initData') || '';

            startBtn.addEventListener('click', startGame);
            confirmBtn.addEventListener('click', handleConfirm);
            nextChallengeBtn.addEventListener('click', handleNext);
            
            window.addEventListener('resize', debounce(ensureFits));
            window.addEventListener('orientationchange', debounce(ensureFits));
        }

        function startGame() {
            introModal.classList.remove('visible');
            gameHeader.style.visibility = 'visible';
            gameFooter.style.visibility = 'visible';
            loadChallenge(gameState.currentChallengeIndex);
        }

        // --- GAME LOGIC ---
        function loadChallenge(index) {
            const challenge = challenges[index];
            stepsList.innerHTML = '';
            challengeTitle.textContent = challenge.title;
            progressIndicator.textContent = `Reto ${index + 1}/${gameState.totalChallenges}`;

            const shuffledSteps = [...challenge.correctOrder].sort(() => Math.random() - 0.5);
            
            shuffledSteps.forEach((stepText, i) => {
                const clone = stepTemplate.content.cloneNode(true);
                const li = clone.querySelector('.step-item');
                li.querySelector('.step-content').textContent = stepText;
                
                const upBtn = li.querySelector('.up-btn');
                const downBtn = li.querySelector('.down-btn');

                upBtn.addEventListener('click', () => moveStep(li, -1));
                downBtn.addEventListener('click', () => moveStep(li, 1));
                
                stepsList.appendChild(li);
            });
            updateButtonStates();
            setTimeout(ensureFits, 50); // Delay for render
        }

        function moveStep(item, direction) {
            item.classList.add('moving');
            if (direction === -1 && item.previousElementSibling) {
                item.parentElement.insertBefore(item, item.previousElementSibling);
            } else if (direction === 1 && item.nextElementSibling) {
                item.parentElement.insertBefore(item.nextElementSibling, item);
            }
            updateButtonStates();
            setTimeout(() => item.classList.remove('moving'), 300);
        }

        function updateButtonStates() {
            const items = stepsList.querySelectorAll('.step-item');
            items.forEach((item, index) => {
                item.querySelector('.up-btn').disabled = (index === 0);
                item.querySelector('.down-btn').disabled = (index === items.length - 1);
            });
        }
        
        function handleConfirm() {
            confirmBtn.classList.add('shake');
            setTimeout(() => confirmBtn.classList.remove('shake'), 500);

            const userOrder = [...stepsList.querySelectorAll('.step-content')].map(el => el.textContent);
            const correctOrder = challenges[gameState.currentChallengeIndex].correctOrder;
            
            let isCorrect = true;
            if (userOrder.length !== correctOrder.length) {
                isCorrect = false;
            } else {
                for (let i = 0; i < userOrder.length; i++) {
                    if (userOrder[i] !== correctOrder[i]) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            showResults(userOrder, correctOrder, isCorrect);
        }

        function showResults(userOrder, correctOrder, isCorrect) {
            const challenge = challenges[gameState.currentChallengeIndex];
            
            document.getElementById('result-title').textContent = isCorrect ? "¬°Secuencia Perfecta!" : "¬°Casi lo tienes!";
            
            const comparisonContainer = document.getElementById('results-comparison');
            comparisonContainer.innerHTML = `
                <div class="results-list">
                    <h4>Tu Orden</h4>
                    ${userOrder.map((step, i) => `
                        <div class="result-item ${step === correctOrder[i] ? 'correct' : 'incorrect'}">
                            <span>${i + 1}</span> ${step}
                        </div>`).join('')}
                </div>
                <div class="results-list">
                    <h4>Orden Correcto</h4>
                    ${correctOrder.map((step, i) => `
                        <div class="result-item correct">
                             <span>${i + 1}</span> ${step}
                        </div>`).join('')}
                </div>
            `;
            
            document.getElementById('result-explanation').textContent = challenge.explanation;
            document.getElementById('result-tip').textContent = challenge.tip;

            if (gameState.currentChallengeIndex >= gameState.totalChallenges - 1) {
                nextChallengeBtn.textContent = "Ver mi recompensa";
            } else {
                nextChallengeBtn.textContent = "Siguiente Reto";
            }
            
            resultsModal.classList.add('visible');
            document.body.classList.add('results-active');
        }

        function handleNext() {
            resultsModal.classList.remove('visible');
            document.body.classList.remove('results-active');

            if (gameState.currentChallengeIndex >= gameState.totalChallenges - 1) {
                // Final action
                if (!gameState.initData) {
                    const warning = document.getElementById('init-data-warning');
                    warning.style.display = 'block';
                    // Re-enable button but don't redirect
                    return;
                }
                window.location.href = `https://kampe-game-phaser.onrender.com/daily_streak?initData=${gameState.initData}`;
            } else {
                gameState.currentChallengeIndex++;
                loadChallenge(gameState.currentChallengeIndex);
            }
        }


        // --- UX & LAYOUT FITTING ---
        function ensureFits() {
            gameWrapper.style.setProperty('--ui-scale', 1);
            scene.classList.remove('compact');
            
            // Allow DOM to update before measuring
            requestAnimationFrame(() => {
                let isOverflowing = scene.scrollHeight > scene.clientHeight;

                // 1. Try compact mode
                if (isOverflowing) {
                    scene.classList.add('compact');
                }

                requestAnimationFrame(() => {
                    isOverflowing = scene.scrollHeight > scene.clientHeight;

                    // 2. Try scaling down as a last resort
                    if (isOverflowing) {
                        const scale = Math.min(1, scene.clientHeight / scene.scrollHeight);
                        const finalScale = Math.max(0.88, scale); // Minimum scale of 0.88
                        gameWrapper.style.setProperty('--ui-scale', finalScale);
                    }
                });
            });
        }
        
        function debounce(func, wait = 100) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- START THE APP ---
        init();
    });
    </script>

</body>
</html>
