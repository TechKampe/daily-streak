
<!DOCTYPE html>
<html lang="es" class="gameplay">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ðŸ”§ Ordena y Domina: Protocolos del Taller - KÃ¤mpe Games</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://techkampe.github.io/daily-streak/assets/css/daily_tasks.css">
</head>
<body>
<div class="scene gameplay" id="scene">
<div class="hud">
<div class="hud-titles">
<div class="brand">ðŸ”§ Ordena y Domina</div>
<div class="subtitle" id="subtitle">Ordena los pasos correctamente</div>
</div>
<div class="progress-row">
<div class="bar-wrap">
<span class="bar-label">Progreso</span>
<div class="bar"><i id="progress" style="width:0%"></i></div>
</div>
<span class="badge" id="counter">Reto 1/3</span>
</div>
</div>
<div class="main" id="main"></div>
<div class="footer">
<div class="helper" id="helper">Usa â†‘â†“ o arrastra para ordenar</div>
<button class="cta" id="cta">Confirmar orden</button>
</div>
</div>
<img class="avatar" src="https://techkampe.github.io/daily-streak/assets/Avatar%201_low.png" alt="" loading="lazy">
<div class="modal-backdrop" id="modal">
<div class="modal">
<div class="modal-title">ðŸ”§ Â¡Bienvenido al Taller!</div>
<div class="modal-body">Tu supervisor te pide demostrar que conoces los procedimientos. Ordena cada secuencia de pasos correctamente.</div>
<div class="modal-actions">
<button class="cta" onclick="closeModal()">Â¡Empezar!</button>
</div>
</div>
</div>
<script>
const challenges=[
{title:"Circuito ElÃ©ctrico",steps:["Cortar suministro elÃ©ctrico","Verificar ausencia de tensiÃ³n","SeÃ±alizar zona de trabajo","Realizar la intervenciÃ³n","Restablecer suministro"],tip:"Nunca trabajes en un circuito sin verificar ausencia de tensiÃ³n con un detector homologado."},
{title:"Escalera PortÃ¡til",steps:["Inspeccionar estado de la escalera","Colocar en superficie estable","Asegurar Ã¡ngulo 75Â° (1:4)","Mantener 3 puntos de apoyo","Bajar de frente a la escalera"],tip:"El Ã¡ngulo correcto es 1 metro de base por cada 4 de altura."},
{title:"Visita TÃ©cnica a Cliente",steps:["Identificarse y mostrar credencial","Explicar trabajo a realizar","Proteger zona de trabajo","Ejecutar la reparaciÃ³n","Limpiar y verificar con cliente"],tip:"La buena comunicaciÃ³n genera confianza y evita malentendidos."}
];
let currentChallenge=0,userOrder=[],results=[],draggedIdx=null;
const scene=document.getElementById('scene'),main=document.getElementById('main'),cta=document.getElementById('cta'),modal=document.getElementById('modal'),prog=document.getElementById('progress'),counter=document.getElementById('counter'),subtitle=document.getElementById('subtitle'),helper=document.getElementById('helper');

function shuffle(arr){let a=[...arr];for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function closeModal(){modal.classList.remove('active');renderChallenge();}

function renderChallenge(){
if(currentChallenge>=challenges.length){showResults();return;}
const ch=challenges[currentChallenge];
userOrder=shuffle(ch.steps);
subtitle.textContent=ch.title;
counter.textContent=`Reto ${currentChallenge+1}/3`;
prog.style.width=((currentChallenge)/3*100)+'%';
helper.textContent='Usa â†‘â†“ o arrastra para ordenar';
cta.textContent='Confirmar orden';
cta.onclick=confirmOrder;
renderCards();
ensureFits();
}

function renderCards(){
main.innerHTML=`<div class="cards-list" id="cardsList">${userOrder.map((s,i)=>`
<div class="card" data-idx="${i}" draggable="true">
<span class="card-num">${i+1}</span>
<span class="card-text">${s.length>45?s.slice(0,42)+'...':s}</span>
<div class="card-controls">
<button class="btn-ghost" aria-label="Subir" onclick="moveCard(${i},-1)">â†‘</button>
<button class="btn-ghost" aria-label="Bajar" onclick="moveCard(${i},1)">â†“</button>
</div>
</div>`).join('')}</div>`;
attachDragEvents();
}

function moveCard(idx,dir){
const newIdx=idx+dir;
if(newIdx<0||newIdx>=userOrder.length)return;
[userOrder[idx],userOrder[newIdx]]=[userOrder[newIdx],userOrder[idx]];
const cards=document.querySelectorAll('.card');
cards[idx].classList.add('dragging');
setTimeout(()=>{renderCards();ensureFits();},150);
}

function attachDragEvents(){
const cards=document.querySelectorAll('.card');
cards.forEach(card=>{
card.addEventListener('dragstart',e=>{
draggedIdx=parseInt(card.dataset.idx);
card.classList.add('dragging');
e.dataTransfer.effectAllowed='move';
});
card.addEventListener('dragend',()=>{
card.classList.remove('dragging');
draggedIdx=null;
});
card.addEventListener('dragover',e=>{
e.preventDefault();
e.dataTransfer.dropEffect='move';
});
card.addEventListener('drop',e=>{
e.preventDefault();
const targetIdx=parseInt(card.dataset.idx);
if(draggedIdx!==null&&draggedIdx!==targetIdx){
const item=userOrder.splice(draggedIdx,1)[0];
userOrder.splice(targetIdx,0,item);
renderCards();
ensureFits();
}
});
card.addEventListener('touchstart',handleTouchStart,{passive:true});
card.addEventListener('touchmove',handleTouchMove,{passive:false});
card.addEventListener('touchend',handleTouchEnd);
});
}

let touchStartY=0,touchCardIdx=null,touchCard=null;
function handleTouchStart(e){
touchCard=e.currentTarget;
touchCardIdx=parseInt(touchCard.dataset.idx);
touchStartY=e.touches[0].clientY;
touchCard.classList.add('dragging');
}
function handleTouchMove(e){
if(touchCard===null)return;
e.preventDefault();
}
function handleTouchEnd(e){
if(touchCard===null)return;
const touchEndY=e.changedTouches[0].clientY;
const diff=touchEndY-touchStartY;
if(Math.abs(diff)>30){
const dir=diff>0?1:-1;
const newIdx=touchCardIdx+dir;
if(newIdx>=0&&newIdx<userOrder.length){
[userOrder[touchCardIdx],userOrder[newIdx]]=[userOrder[newIdx],userOrder[touchCardIdx]];
renderCards();
ensureFits();
}
}
touchCard.classList.remove('dragging');
touchCard=null;
touchCardIdx=null;
}

function confirmOrder(){
const ch=challenges[currentChallenge];
const correct=JSON.stringify(userOrder)===JSON.stringify(ch.steps);
results.push({title:ch.title,userOrder:[...userOrder],correctOrder:[...ch.steps],correct,tip:ch.tip});
currentChallenge++;
if(currentChallenge<challenges.length){
showFeedback(correct,ch);
}else{
showResults();
}
}

function showFeedback(correct,ch){
const feedbackClass=correct?'correct':'incorrect';
main.innerHTML=`<div class="result-item ${feedbackClass}" style="margin:8px 0">
<div class="result-question">${correct?'âœ“ Â¡Orden correcto!':'âœ— Orden incorrecto'}</div>
<div class="result-answer">${correct?'Bien hecho.':'Revisa el orden correcto abajo.'}</div>
${!correct?`<div class="result-explanation"><strong>Correcto:</strong> ${ch.steps.map((s,i)=>(i+1)+'. '+s.slice(0,25)).join(' â†’ ')}</div>`:''}
<div class="result-explanation">ðŸ’¡ ${ch.tip}</div>
</div>`;
helper.textContent='Siguiente reto';
cta.textContent='Continuar';
cta.onclick=renderChallenge;
ensureFits();
}

function showResults(){
setTimeout(()=>{
document.documentElement.classList.replace('gameplay','results');
scene.classList.replace('gameplay','results');
const totalCorrect=results.filter(r=>r.correct).length;
scene.innerHTML=`
<div class="results-header">
<div class="results-title">ðŸ”§ Â¡SesiÃ³n completada!</div>
<div class="results-score">${totalCorrect}/3</div>
<div class="results-subtitle">Secuencias correctas</div>
</div>
<div class="results-list">
${results.map(r=>`<div class="result-item ${r.correct?'correct':'incorrect'}">
<div class="result-question">${r.title}</div>
<div class="result-answer">${r.correct?'âœ“ Orden correcto':'âœ— Incorrecto'}</div>
${!r.correct?`<div class="result-explanation"><strong>Tu orden:</strong> ${r.userOrder.map((s,i)=>(i+1)+'.'+s.slice(0,18)).join(', ')}</div>
<div class="result-explanation"><strong>Correcto:</strong> ${r.correctOrder.map((s,i)=>(i+1)+'.'+s.slice(0,18)).join(', ')}</div>`:''}
<div class="result-explanation">ðŸ’¡ ${r.tip}</div>
</div>`).join('')}
</div>
<div class="footer"><button class="cta" onclick="completeTask()">Ver mi recompensa</button></div>`;
},500);
}

function completeTask(){
if(window.ReactNativeWebView){
window.ReactNativeWebView.postMessage(JSON.stringify({action:'TASK_COMPLETED'}));
}
}

function ensureFits(){
scene.classList.remove('compact','compact-xs');
document.documentElement.style.setProperty('--ui-scale',1);
if(scene.scrollHeight>scene.clientHeight)scene.classList.add('compact');
if(scene.scrollHeight>scene.clientHeight)scene.classList.add('compact-xs');
if(scene.scrollHeight>scene.clientHeight){
document.documentElement.style.setProperty('--ui-scale',Math.max(0.88,scene.clientHeight/scene.scrollHeight));
}
}

window.addEventListener('load',()=>{modal.classList.add('active');ensureFits();});
window.addEventListener('resize',ensureFits);
window.addEventListener('orientationchange',()=>setTimeout(ensureFits,100));
</script>
</body>
</html>
