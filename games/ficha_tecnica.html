<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ficha TÃ©cnica</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--pri:#00E6BC;--acc:#04FFB4;--suc:#C5FFDF;--dan:#E74C3C;--war:#FFFFAB;--dk:#0B214A;--olive:#004957;--navy:#0B214A;--lime:#04FFB4;--lemon:#FFFFAB;--mint:#C5FFDF;--fire:#E74C3C;--turq:#00E6BC}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Baloo 2',cursive;background:#0B214A}
body{padding-top:env(safe-area-inset-top);padding-top:constant(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-bottom:constant(safe-area-inset-bottom)}
#W{position:relative;width:100%;max-width:430px;margin:0 auto;height:100%;overflow:hidden;background:linear-gradient(180deg,#0B214A 0%,#0D2D5E 40%,#0F1B2D 100%)}
.scr{position:absolute;inset:0;display:flex;flex-direction:column;transition:opacity .35s;z-index:100}
.scr.off{opacity:0;pointer-events:none;z-index:-1}
.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;pointer-events:none}
.dim{position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:1;pointer-events:none}
.btn{background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:19px;font-weight:700;padding:14px 48px;border-radius:50px;cursor:pointer;box-shadow:0 4px 16px rgba(0,230,188,.3);transition:transform .1s;letter-spacing:.5px}
.btn:active{transform:scale(.96)}

/* INTRO */
#intro{align-items:center;justify-content:flex-end;padding-bottom:40px}
.intro-card{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;padding:0 20px;width:100%}
.intro-av{width:260px;height:340px;object-fit:contain;filter:drop-shadow(0 4px 24px rgba(0,0,0,.6));margin-bottom:-40px;position:relative;z-index:1}
.intro-bub{position:relative;z-index:2;background:#fff;color:var(--navy);padding:20px 24px;border-radius:22px;box-shadow:0 4px 24px rgba(0,0,0,.35);font-size:17px;font-weight:600;line-height:1.45;text-align:center;margin-bottom:20px;width:100%}
.intro-title{font-size:28px;font-weight:800;color:#fff;text-shadow:0 3px 16px rgba(0,0,0,.5);margin-bottom:8px;z-index:10;position:relative}

/* HUD */
.hud{position:absolute;top:0;left:0;right:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;padding-right:66px;background:linear-gradient(180deg,rgba(11,33,74,.92)0%,rgba(11,33,74,.3)70%,transparent 100%);pointer-events:none}
.hud-left{display:flex;align-items:center;gap:8px}
.hud-round{background:rgba(0,0,0,.35);padding:4px 12px;border-radius:16px;color:rgba(255,255,255,.8);font-size:14px;font-weight:600}

/* GAMEPLAY */
#play{z-index:10}
.round-content{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:58px 14px 14px;overflow-y:auto;-webkit-overflow-scrolling:touch}

/* TOOL IMAGE */
.tool-header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:10px;flex-shrink:0}
.tool-img{width:60%;height:auto;object-fit:contain;border-radius:12px;border:3px solid #fff}
.tool-name{color:#0B214A;font-size:22px;font-weight:800;text-align:center}

/* SLOTS */
.slots-area{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;flex-shrink:0}
.slot-row{display:flex;align-items:center;gap:8px;min-height:48px}
.slot-label{width:80px;flex-shrink:0;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;text-align:right;line-height:1.2}
.slot-box{flex:1;min-height:44px;background:#fff;border:2px dashed rgba(11,33,74,.2);border-radius:14px;display:flex;align-items:center;justify-content:center;padding:8px 10px;transition:all .2s;position:relative}
.slot-box.highlight{background:#fff;transform:scale(1.03);box-shadow:0 0 0 3px rgba(70,111,234,.4)}
.slot-box.filled{border-style:solid;background:#fff}
.slot-box.correct{border-color:var(--turq)!important;background:#fff!important}
.slot-box.incorrect{border-color:var(--dan)!important;background:rgba(231,76,60,.15)!important}
.slot-box .tag-text{color:#0B214A;font-size:13px;font-weight:700;text-align:center;line-height:1.2}
.slot-icon{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:20px;height:20px;opacity:0;transition:opacity .3s;display:flex;align-items:center;justify-content:center}
.slot-icon.show{opacity:1}
.slot-icon svg{width:20px;height:20px}

/* Slot & tag colors â€” 3 dynamic colors assigned per ficha */
.slot-color-0 .slot-label{color:#0B214A}
.slot-color-0 .slot-box{border-color:#466FEA}
.slot-color-0 .slot-box.highlight{border-color:#466FEA;background:rgba(70,111,234,.15)}
.slot-color-0 .slot-box.filled{border-color:#466FEA}

.slot-color-1 .slot-label{color:#0B214A}
.slot-color-1 .slot-box{border-color:#FF792E}
.slot-color-1 .slot-box.highlight{border-color:#FF792E;background:rgba(255,121,46,.15)}
.slot-color-1 .slot-box.filled{border-color:#FF792E}

.slot-color-2 .slot-label{color:#0B214A}
.slot-color-2 .slot-box{border-color:#A544B0}
.slot-color-2 .slot-box.highlight{border-color:#A544B0;background:rgba(165,68,176,.15)}
.slot-color-2 .slot-box.filled{border-color:#A544B0}

/* TAGS POOL */
.tags-label{color:#0B214A;font-size:11px;font-weight:600;text-align:center;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;flex-shrink:0}
.tags-pool{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;padding:6px 0;flex-shrink:0}
.tag{font-size:12px;font-weight:700;padding:8px 14px;border-radius:12px;cursor:grab;touch-action:none;transition:all .15s;box-shadow:0 2px 8px rgba(0,0,0,.2);line-height:1.2;max-width:180px;text-align:center;position:relative;z-index:10;border:2px solid transparent;-webkit-touch-callout:none}
.tag.dragging{opacity:.4;transform:scale(.9)}
.tag.ghost{position:fixed;z-index:9999;pointer-events:none;transform:scale(1.08);box-shadow:0 6px 20px rgba(0,0,0,.4);transition:none}
.tag.used{display:none}

/* Tag colors â€” 3 dynamic colors, solid backgrounds, white text */
.tag-color-0{background:#466FEA;color:#fff;border-color:#3558c7}
.tag-color-0.ghost{background:#466FEA}
.tag-color-1{background:#FF792E;color:#fff;border-color:#e0641a}
.tag-color-1.ghost{background:#FF792E}
.tag-color-2{background:#A544B0;color:#fff;border-color:#8a3694}
.tag-color-2.ghost{background:#A544B0}

/* VALIDATE BUTTON */
.validate-area{display:flex;justify-content:center;margin-top:16px;flex-shrink:0}
.btn-validate{background:var(--navy);color:var(--turq);border:none;font-family:'Baloo 2',cursive;font-size:17px;font-weight:700;padding:12px 40px;border-radius:50px;cursor:pointer;box-shadow:0 4px 16px rgba(11,33,74,.3);transition:all .2s;opacity:0;pointer-events:none;transform:translateY(10px)}
.btn-validate.show{opacity:1;pointer-events:auto;transform:translateY(0)}
.btn-validate:active{transform:scale(.96)}

/* FEEDBACK overlay */
.feedback-bar{position:absolute;bottom:0;left:0;right:0;z-index:60;padding:10px 14px 12px;display:flex;align-items:flex-start;gap:10px;transform:translateY(100%);transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none;flex-wrap:wrap}
.feedback-bar.show{transform:translateY(0);pointer-events:auto;cursor:pointer}
.feedback-bar.ok{background:var(--mint)}
.feedback-bar.err{background:rgba(231,76,60,.95)}
.fb-icon{width:28px;height:28px;object-fit:contain;flex-shrink:0}
.fb-text{color:#fff;font-size:13px;font-weight:600;line-height:1.25;flex:1;min-width:0}
.feedback-bar.ok .fb-text{color:var(--navy)}
.fb-right{display:flex;flex-direction:column;align-items:center;gap:6px;flex-shrink:0}
.fb-pts{display:none}
.fb-next{background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:14px;font-weight:700;padding:7px 20px;border-radius:20px;cursor:pointer;white-space:nowrap;pointer-events:auto;touch-action:manipulation}
.fb-next:active{transform:scale(.95);opacity:.8}

/* Speed badge */
.speed-badge{position:absolute;top:60px;right:16px;z-index:70;font-size:16px;font-weight:800;padding:6px 16px;border-radius:20px;color:#fff;opacity:0;transform:translateY(10px) scale(.8);transition:all .3s;pointer-events:none}
.speed-badge.show{opacity:1;transform:translateY(0) scale(1)}
.speed-badge.gold{background:linear-gradient(135deg,var(--lemon),#e6e68a);color:var(--navy)}
.speed-badge.orange{background:linear-gradient(135deg,var(--turq),var(--lime));color:var(--navy)}

/* Salva popup */
.salva-popup{position:absolute;bottom:0;left:8px;z-index:65;display:flex;align-items:flex-end;gap:8px;opacity:0;transform:translateX(-100%);transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
.salva-popup.show{opacity:1;transform:translateX(0)}
.salva-popup img{width:140px;height:183px;object-fit:contain;filter:drop-shadow(0 3px 12px rgba(0,0,0,.5))}
.salva-popup .salva-msg{background:#fff;color:var(--navy);font-size:13px;font-weight:600;padding:8px 14px;border-radius:14px;border-bottom-left-radius:4px;box-shadow:0 3px 14px rgba(0,0,0,.3);max-width:200px;line-height:1.3;margin-bottom:40px}

/* RESULTS */
#results{align-items:center;justify-content:center;padding:24px;z-index:200}
.res-inner{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;width:100%}
.res-badge{background:var(--turq);color:var(--navy);font-size:14px;font-weight:700;padding:6px 20px;border-radius:20px;margin-bottom:10px;display:none}
.res-badge.show{display:block}
.res-title{font-size:28px;font-weight:800;color:#fff;margin-bottom:4px}
.res-sub{font-size:14px;color:rgba(255,255,255,.6);margin-bottom:20px;text-align:center}
.res-scores{display:flex;gap:36px;margin-bottom:16px}
.res-val{font-size:42px;font-weight:800;text-align:center}
.res-label{font-size:12px;color:rgba(255,255,255,.5);font-weight:600;text-align:center}
.res-new{color:var(--lemon);font-size:16px;font-weight:800;margin-bottom:12px;display:none}
.res-new.show{display:block}
.res-bot{display:flex;flex-direction:column;align-items:center}
.res-av{width:280px;height:366px;object-fit:contain;filter:drop-shadow(0 4px 22px rgba(0,0,0,.5));margin-bottom:-30px;position:relative;z-index:1}
.res-bot .btn{position:relative;z-index:2}
.res-record{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:12px}

/* Correction detail */
.correction-list{width:100%;display:flex;flex-direction:column;gap:4px;margin-top:6px}
.correction-item{font-size:12px;font-weight:600;line-height:1.3;padding:2px 0}
.correction-item.ok{color:var(--navy)}
.correction-item.err{color:var(--dan)}
.feedback-bar.ok .correction-item.err{color:var(--dan)}

@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.anim-in{animation:fadeInUp .4s ease-out both}
</style>
</head>
<body>
<div id="W">

<!-- INTRO -->
<div class="scr" id="intro">
    <img class="bg" id="intro-bg" alt="">
    <div class="dim"></div>
    <div class="intro-card">
        <h1 class="intro-title">Ficha TÃ©cnica</h1>
        <img class="intro-av" id="intro-av" alt="Salva">
        <div class="intro-bub" id="intro-msg"></div>
        <button class="btn" id="intro-btn">Â¡A por ello!</button>
    </div>
</div>

<!-- GAMEPLAY -->
<div class="scr off" id="play">
    <img class="bg" id="play-bg" alt="">
    <div class="hud">
        <div class="hud-left">
            <div class="hud-round" id="hud-round">Ficha 1/4</div>
        </div>
    </div>
    <div class="round-content" id="round-content"></div>
    <div class="feedback-bar" id="fb-bar">
        <img class="fb-icon" id="fb-icon" alt="">
        <div class="fb-text" id="fb-text"></div>
        <div class="fb-right">
            <div class="fb-pts" id="fb-pts"></div>
            <button class="fb-next" id="fb-next">Siguiente</button>
        </div>
    </div>
    <div class="speed-badge" id="speed-badge"></div>
    <div class="salva-popup" id="salva-pop">
        <img id="salva-pop-img" alt="Salva">
        <div class="salva-msg" id="salva-pop-msg"></div>
    </div>
</div>

<!-- RESULTS -->
<div class="scr off" id="results" style="background:var(--navy)">
    <div class="res-inner">
        <div class="res-badge" id="res-badge">MISIÃ“N COMPLETADA</div>
        <h2 class="res-title">Fin de partida</h2>
        <p class="res-sub" id="res-sub"></p>
        <div class="res-scores">
            <div><div class="res-val" id="res-score" style="color:#00E6BC">0</div><div class="res-label">PuntuaciÃ³n</div></div>
            <div><div class="res-val" id="res-record" style="color:#FFFFAB">0</div><div class="res-label">RÃ©cord</div></div>
        </div>
        <div class="res-new" id="res-new">Â¡NUEVO RÃ‰CORD!</div>
        <div class="res-bot">
            <img class="res-av" id="res-av" alt="Salva">
            <button class="btn" id="res-btn">Â¡Otra ronda!</button>
        </div>
        <div class="res-record" id="res-rec-text"></div>
    </div>
</div>

</div>
<script>
/* ========== ASSET PATHS ========== */
const A={
  bg_taller:'https://res.cloudinary.com/kampe/image/upload/v1771938582/bg_taller_pr4v4o.png',
  bg_ficha:'https://res.cloudinary.com/kampe/image/upload/v1772013397/bg_ficha_tecnica_uhu0ss.png',
  salva_base:'https://res.cloudinary.com/kampe/image/upload/v1771938594/salva_base_x8eghx.png',
  salva_happy:'https://res.cloudinary.com/kampe/image/upload/v1771938597/salva_happy_ccjemp.png',
  salva_celebrating:'https://res.cloudinary.com/kampe/image/upload/v1771938594/salva_celebrating_xki0p5.png',
  salva_worried:'https://res.cloudinary.com/kampe/image/upload/v1771938598/salva_worried_glnc2b.png',
  salva_facepalm:'https://res.cloudinary.com/kampe/image/upload/v1771938595/salva_facepalm_iz3myg.png',
  ico_check:'https://res.cloudinary.com/kampe/image/upload/v1771531177/icono_check.png',
  ico_cruz:'https://res.cloudinary.com/kampe/image/upload/v1771531178/icono_cruz.png',
  tool_taladro:'https://res.cloudinary.com/kampe/image/upload/v1772013398/tool_taladro_percutor_r1i4aj.png',
  tool_atornillador:'https://res.cloudinary.com/kampe/image/upload/v1772013397/tool_atornillador_impacto_b6f06b.png',
  tool_radial:'https://res.cloudinary.com/kampe/image/upload/v1772013397/tool_radial_amoladora_ceyoei.png',
  tool_sierra:'https://res.cloudinary.com/kampe/image/upload/v1772013397/tool_sierra_calar_hl6fxp.png'
};

/* ========== FICHAS DATA ========== */
const FICHAS=[
  {
    id:'taladro',
    name:'Taladro Percutor',
    img:A.tool_taladro,
    correct:{
      funcion:'Perforar materiales',
      accesorio:'Broca (widia/metal/madera)',
      riesgo:'Giro brusco de muÃ±eca',
      epi:'Gafas + guantes',
      error:'Forzar cuando se bloquea'
    },
    distractors:{
      funcion:['Cortar tubo metÃ¡lico','Atornillar rÃ¡pido'],
      accesorio:['Disco de corte','Hoja de sierra'],
      riesgo:['Retroceso violento','Tornillo disparado'],
      epi:['Solo guantes','No hace falta EPI'],
      error:['Quitar el protector','Pasar rosca']
    },
    explain:{
      funcion:'El taladro percutor perfora paredes, madera y metal gracias a su rotaciÃ³n y percusiÃ³n.',
      accesorio:'Cada material necesita su broca: widia para pared, afilada para metal, centradora para madera.',
      riesgo:'Si la broca se bloquea, el taladro gira bruscamente y puede lesionar la muÃ±eca.',
      epi:'Las gafas protegen del polvo y los guantes mejoran el agarre.',
      error:'Forzar un taladro bloqueado puede romper la broca o provocar un tirÃ³n peligroso.'
    }
  },
  {
    id:'atornillador',
    name:'Atornillador ElÃ©ctrico',
    img:A.tool_atornillador,
    correct:{
      funcion:'Fijar y atornillar',
      accesorio:'Punta de atornillar',
      riesgo:'Tornillo disparado / rebote punta',
      epi:'Gafas',
      error:'Apretar hasta romper'
    },
    distractors:{
      funcion:['Perforar materiales','Cortar y desbastar'],
      accesorio:['Broca widia','Disco de corte'],
      riesgo:['Giro brusco de muÃ±eca','Disco que se rompe'],
      epi:['Gafas + guantes + auditiva','No hace falta EPI'],
      error:['Forzar cuando se bloquea','Quitar el protector']
    },
    explain:{
      funcion:'El atornillador elÃ©ctrico fija tornillos rÃ¡pido. El de impacto aÃ±ade mÃ¡s par de apriete.',
      accesorio:'Cada tornillo necesita su punta: PH, PHz, plano, Torx...',
      riesgo:'Un tornillo mal alineado puede salir disparado. La punta puede rebotar.',
      epi:'Las gafas protegen de posibles fragmentos o tornillos que salten.',
      error:'Pasar de rosca rompe el material o el tornillo. Ajusta el par de apriete.'
    }
  },
  {
    id:'radial',
    name:'Radial / Amoladora',
    img:A.tool_radial,
    correct:{
      funcion:'Cortar y desbastar',
      accesorio:'Disco (corte/desbaste)',
      riesgo:'Retroceso violento / disco roto',
      epi:'Gafas + guantes + auditiva',
      error:'Quitar el protector'
    },
    distractors:{
      funcion:['Perforar materiales','Fijar y atornillar'],
      accesorio:['Broca widia','Punta de atornillar'],
      riesgo:['Giro brusco de muÃ±eca','Tornillo disparado'],
      epi:['Solo guantes','No hace falta EPI'],
      error:['Forzar cuando se bloquea','Pasar rosca']
    },
    explain:{
      funcion:'La radial corta tubo metÃ¡lico, varilla roscada y desbasta superficies.',
      accesorio:'Disco fino para cortar, grueso para desbastar. Nunca uses el disco incorrecto.',
      riesgo:'El retroceso puede lanzar la radial. Un disco roto sale disparado.',
      epi:'Gafas contra partÃ­culas, guantes para el agarre, protecciÃ³n auditiva por el ruido.',
      error:'Sin protector, las chispas y fragmentos impactan directamente. Es la regla de oro.'
    }
  },
  {
    id:'sierra',
    name:'Sierra de Calar',
    img:A.tool_sierra,
    correct:{
      funcion:'Cortes curvos en madera',
      accesorio:'Hoja de sierra',
      riesgo:'Corte descontrolado / vibraciÃ³n',
      epi:'Gafas + guantes',
      error:'Forzar la mÃ¡quina'
    },
    distractors:{
      funcion:['Cortar tubo metÃ¡lico','Fijar y atornillar'],
      accesorio:['Disco de corte','Punta de atornillar'],
      riesgo:['Retroceso violento','Tornillo disparado'],
      epi:['Gafas + guantes + auditiva','No hace falta EPI'],
      error:['Quitar el protector','Apretar hasta romper']
    },
    explain:{
      funcion:'La sierra de calar hace cortes curvos y rectos en madera y materiales blandos.',
      accesorio:'Cada material necesita una hoja diferente. La hoja incorrecta astilla o se rompe.',
      riesgo:'Si fuerzas la sierra, el corte se descontrola y la vibraciÃ³n excesiva puede causar accidentes.',
      epi:'Las gafas protegen de astillas y los guantes mejoran el control.',
      error:'Dejar trabajar a la mÃ¡quina. Si fuerzas, la hoja se rompe o el corte sale torcido.'
    }
  }
];

const ALL_FIELDS=['funcion','accesorio','riesgo','epi','error'];
const FIELD_LABELS={funcion:'FunciÃ³n',accesorio:'Accesorio',riesgo:'Riesgo',epi:'EPI',error:'Error novato'};
const FIELDS_PER_FICHA=3; // show 3 random fields per ficha
const CHIP_COLORS=['#466FEA','#FF792E','#A544B0'];
let fieldColorMap={}; // field -> colorIndex (0,1,2)

const SVG_CHECK='<svg viewBox="0 0 24 24" fill="none" stroke="#04FFB4" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
const SVG_CROSS='<svg viewBox="0 0 24 24" fill="none" stroke="#E74C3C" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';

/* ========== GAME STATE ========== */
let score=0,fichaIdx=0,fichaOrder=[],fichaStartTime=0;
let record=parseInt(localStorage.getItem('ficha_tecnica_record'))||0;
let taskCompleted=false;
let slotContents={}; // field -> tag text or null
let currentFicha=null;
let currentFields=[]; // the 3 random fields for this ficha
let ghostEl=null;
let dragTag=null;
let dragSourceSlot=null; // if dragging from a slot

const $=id=>document.getElementById(id);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
const pick=arr=>arr[Math.floor(Math.random()*arr.length)];

/* ========== SALVA MESSAGES ========== */
const MSG_PERFECT=["Â¡Ficha perfecta! Conoces esta mÃ¡quina.","Â¡Crack! Ni un fallo.","Â¡Dominas esta herramienta!"];
const MSG_GOOD=["Â¡Bien! Pero repasa lo que fallaste.","Casi perfecta, ojo con los detalles.","Buen trabajo, pero puedes mejorar."];
const MSG_BAD=["Uf, repasa esta herramienta.","Necesitas estudiar mÃ¡s esta mÃ¡quina.","Esta herramienta merece mÃ¡s atenciÃ³n."];

/* ========== SCREENS ========== */
function showScreen(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.add('off'));
  $(id).classList.remove('off');
}

/* ========== FEEDBACK ========== */
function showFeedback(ok,text,pts){
  const bar=$('fb-bar');
  bar.className='feedback-bar show '+(ok?'ok':'err');
  $('fb-icon').src=ok?A.ico_check:A.ico_cruz;
  $('fb-text').innerHTML=text;
  $('fb-pts').textContent=pts>0?'+'+pts+'pts':'0 pts';
  $('fb-next').style.display='block';
}
function hideFeedback(){
  $('fb-bar').className='feedback-bar';
  $('fb-next').style.display='none';
}

function showSalva(expr,msg){
  $('salva-pop-img').src=A['salva_'+expr];
  $('salva-pop-msg').textContent=msg;
  // Position Salva so it peeks above feedback bar
  setTimeout(()=>{
    const fbH=$('fb-bar').offsetHeight||60;
    $('salva-pop').style.bottom=(fbH-20)+'px';
    $('salva-pop').classList.add('show');
  },50);
}
function hideSalva(){$('salva-pop').classList.remove('show')}

function showSpeed(bonus){
  const el=$('speed-badge');
  if(bonus>=30){el.textContent='âš¡ RAYO';el.className='speed-badge show gold'}
  else if(bonus>=15){el.textContent='ðŸ”¥ RÃPIDO';el.className='speed-badge show orange'}
  else{el.className='speed-badge';return}
}
function hideSpeed(){$('speed-badge').className='speed-badge'}

function waitForNext(fn){
  const next=$('fb-next');
  let done=false;
  const go=()=>{
    if(done)return;
    done=true;
    next.onclick=null;
    hideFeedback();hideSalva();hideSpeed();fn();
  };
  // Only advance via the "Siguiente" button
  setTimeout(()=>{next.onclick=go},600);
}

/* ========== INIT ========== */
function init(){
  $('intro-bg').src=A.bg_ficha;
  $('intro-av').src=A.salva_happy;
  $('intro-msg').textContent='Â¿Conoces tus mÃ¡quinas? Completa la ficha de cada una arrastrando las respuestas.';
  $('intro-btn').onclick=startGame;
  $('res-btn').onclick=startGame;
  showScreen('intro');
}

/* ========== START GAME ========== */
function startGame(){
  score=0;fichaIdx=0;taskCompleted=false;
  fichaOrder=shuffle([0,1,2,3]);
  $('play-bg').src=A.bg_ficha;
  showScreen('play');
  hideFeedback();hideSalva();hideSpeed();
  playFicha();
}

/* ========== UPDATE HUD ========== */
function updateHUD(){
  $('hud-round').textContent='Ficha '+(fichaIdx+1)+'/4';
}

/* ========== PLAY FICHA ========== */
function playFicha(){
  if(fichaIdx>=4){showResults();return}
  updateHUD();
  currentFicha=FICHAS[fichaOrder[fichaIdx]];
  fichaStartTime=Date.now();
  attempts=0;

  // Pick 3 random fields for this ficha
  currentFields=shuffle([...ALL_FIELDS]).slice(0,FIELDS_PER_FICHA);
  slotContents={};
  fieldColorMap={};
  currentFields.forEach((f,i)=>{slotContents[f]=null;fieldColorMap[f]=i});

  const content=$('round-content');
  content.scrollTop=0;

  // Build tags: for each active field, 1 correct + distractors
  const allTags=[];
  currentFields.forEach(f=>{
    allTags.push({text:currentFicha.correct[f],field:f});
    currentFicha.distractors[f].forEach(d=>{
      if(!allTags.find(t=>t.text===d)){
        allTags.push({text:d,field:f});
      }
    });
  });
  shuffle(allTags);

  // Build slots HTML with dynamic color classes
  let slotsHTML='';
  currentFields.forEach(f=>{
    const ci=fieldColorMap[f];
    slotsHTML+=`<div class="slot-row slot-color-${ci}">
      <div class="slot-label">${FIELD_LABELS[f]}</div>
      <div class="slot-box" data-field="${f}" id="slot-${f}">
        <div class="slot-icon" id="icon-${f}"></div>
      </div>
    </div>`;
  });

  // Build tags HTML with dynamic color class per field
  let tagsHTML='';
  allTags.forEach((t,i)=>{
    const ci=fieldColorMap[t.field];
    tagsHTML+=`<div class="tag tag-color-${ci}" data-idx="${i}" data-field="${t.field}" data-color="${ci}" data-text="${t.text.replace(/"/g,'&quot;')}">${t.text}</div>`;
  });

  content.innerHTML=`
    <div class="tool-header anim-in">
      <img class="tool-img" src="${currentFicha.img}" alt="${currentFicha.name}">
      <div class="tool-name">${currentFicha.name}</div>
    </div>
    <div class="slots-area anim-in" id="slots-area">${slotsHTML}</div>
    <div class="tags-label">Arrastra cada respuesta a su campo (mismo color)</div>
    <div class="tags-pool anim-in" id="tags-pool">${tagsHTML}</div>
    <div class="validate-area">
      <button class="btn-validate" id="btn-validate">Validar ficha</button>
    </div>`;

  $('btn-validate').onclick=validateFicha;

  // Setup drag for tags
  setupDrag();
}

/* ========== DRAG SYSTEM ========== */
const DRAG_THRESHOLD=8; // px movement before drag starts
let selectedTag=null;
let selectedTagEl=null;

function setupDrag(){
  const pool=$('tags-pool');
  const tags=pool.querySelectorAll('.tag');
  const slots=document.querySelectorAll('.slot-box');

  tags.forEach(tag=>{
    tag.addEventListener('touchstart',e=>onPointerDown(e,tag),{passive:false});
    tag.addEventListener('mousedown',e=>onPointerDown(e,tag));
  });

  // Tap slot: return tag or place selected tag
  slots.forEach(slot=>{
    slot.addEventListener('click',e=>{
      const field=slot.dataset.field;
      if(slotContents[field]){
        returnTagToPool(field);
      }else if(selectedTag){
        fillSlot(field,selectedTag);
        hideTagInPool(selectedTag);
        deselectTag();
        checkAllFilled();
      }
    });
  });
}

function selectTag(tag){
  deselectTag();
  selectedTag=tag.dataset.text;
  selectedTagEl=tag;
  tag.style.outline='3px solid #fff';
  tag.style.outlineOffset='2px';
}

function deselectTag(){
  if(selectedTagEl){
    selectedTagEl.style.outline='';
    selectedTagEl.style.outlineOffset='';
  }
  selectedTag=null;
  selectedTagEl=null;
}

function onPointerDown(e,tag){
  if(tag.classList.contains('used'))return;
  const isTouch=!!e.touches;
  const startX=isTouch?e.touches[0].clientX:e.clientX;
  const startY=isTouch?e.touches[0].clientY:e.clientY;
  let isDragging=false;
  let moved=false;
  const text=tag.dataset.text;

  // Prevent scroll while touching a tag
  e.preventDefault();

  const onMove=ev=>{
    const cx=isTouch?ev.touches[0].clientX:ev.clientX;
    const cy=isTouch?ev.touches[0].clientY:ev.clientY;
    const dx=cx-startX,dy=cy-startY;

    if(!isDragging){
      if(Math.abs(dx)>DRAG_THRESHOLD||Math.abs(dy)>DRAG_THRESHOLD){
        isDragging=true;
        moved=true;
        startDrag(tag,text,startX,startY);
      }
      return;
    }

    ev.preventDefault();
    updateDrag(cx,cy);
  };

  const onEnd=ev=>{
    document.removeEventListener(isTouch?'touchmove':'mousemove',onMove);
    document.removeEventListener(isTouch?'touchend':'mouseup',onEnd);

    if(isDragging){
      const cx=isTouch?ev.changedTouches[0].clientX:ev.clientX;
      const cy=isTouch?ev.changedTouches[0].clientY:ev.clientY;
      endDrag(tag,text,cx,cy);
    }else{
      // It was a tap â€” select or toggle
      if(selectedTag===text){
        deselectTag();
      }else{
        selectTag(tag);
      }
    }
  };

  document.addEventListener(isTouch?'touchmove':'mousemove',onMove,{passive:false});
  document.addEventListener(isTouch?'touchend':'mouseup',onEnd);
}

function startDrag(tag,text){
  dragTag=text;
  dragSourceSlot=null;
  deselectTag();

  // If tag is in a slot, remove it
  for(const f of currentFields){
    if(slotContents[f]===text){
      dragSourceSlot=f;
      clearSlot(f);
      break;
    }
  }

  tag.classList.add('dragging');

  // Create ghost
  ghostEl=document.createElement('div');
  const colorClass=tag.dataset.color!==undefined?'tag-color-'+tag.dataset.color:'';
  ghostEl.className='tag ghost '+colorClass;
  ghostEl.textContent=text;
  ghostEl.style.left='-9999px';
  document.body.appendChild(ghostEl);
}

function updateDrag(x,y){
  if(!ghostEl)return;
  // Use transform for GPU-accelerated smooth movement
  const gw=ghostEl.offsetWidth||100;
  const gh=ghostEl.offsetHeight||36;
  ghostEl.style.left='0px';
  ghostEl.style.top='0px';
  ghostEl.style.transform='translate3d('+(x-gw/2)+'px,'+(y-gh-12)+'px,0) scale(1.08)';

  clearHighlights();
  const field=getSlotUnder(x,y);
  if(field){
    const slot=document.querySelector(`.slot-box[data-field="${field}"]`);
    if(slot)slot.classList.add('highlight');
  }
}

function endDrag(tag,text,cx,cy){
  tag.classList.remove('dragging');
  if(ghostEl){ghostEl.remove();ghostEl=null}
  clearHighlights();

  const slotField=getSlotUnder(cx,cy);
  if(slotField){
    const existing=slotContents[slotField];
    if(existing&&existing!==text){
      clearSlot(slotField);
      showTagInPool(existing);
    }
    fillSlot(slotField,text);
    hideTagInPool(text);
  }else{
    showTagInPool(text);
  }

  checkAllFilled();
  dragTag=null;
  dragSourceSlot=null;
}

function getSlotUnder(x,y){
  const slots=document.querySelectorAll('.slot-box');
  const PAD=20;
  for(const slot of slots){
    const r=slot.getBoundingClientRect();
    if(x>=r.left-PAD&&x<=r.right+PAD&&y>=r.top-PAD&&y<=r.bottom+PAD){
      return slot.dataset.field;
    }
  }
  return null;
}

function clearHighlights(){
  document.querySelectorAll('.slot-box.highlight').forEach(s=>s.classList.remove('highlight'));
}

function fillSlot(field,text){
  slotContents[field]=text;
  const slot=document.querySelector(`.slot-box[data-field="${field}"]`);
  slot.classList.add('filled');
  // Remove old tag-text if any
  const oldTag=slot.querySelector('.tag-text');
  if(oldTag)oldTag.remove();
  const span=document.createElement('span');
  span.className='tag-text';
  span.textContent=text;
  slot.insertBefore(span,slot.querySelector('.slot-icon'));
}

function clearSlot(field){
  slotContents[field]=null;
  const slot=document.querySelector(`.slot-box[data-field="${field}"]`);
  slot.classList.remove('filled','correct','incorrect');
  const oldTag=slot.querySelector('.tag-text');
  if(oldTag)oldTag.remove();
  const icon=slot.querySelector('.slot-icon');
  if(icon){icon.classList.remove('show');icon.innerHTML=''}
}

function returnTagToPool(field){
  const text=slotContents[field];
  if(!text)return;
  clearSlot(field);
  showTagInPool(text);
  checkAllFilled();
}

function hideTagInPool(text){
  const pool=$('tags-pool');
  pool.querySelectorAll('.tag').forEach(t=>{
    if(t.dataset.text===text)t.classList.add('used');
  });
}

function showTagInPool(text){
  const pool=$('tags-pool');
  pool.querySelectorAll('.tag').forEach(t=>{
    if(t.dataset.text===text)t.classList.remove('used');
  });
}

function checkAllFilled(){
  const filled=currentFields.every(f=>slotContents[f]!==null);
  const btn=$('btn-validate');
  if(filled){btn.classList.add('show')}
  else{btn.classList.remove('show')}
}

/* ========== VALIDATE ========== */
let attempts=0; // track attempts per ficha

function validateFicha(){
  const elapsed=(Date.now()-fichaStartTime)/1000;
  let correctCount=0;
  const incorrectFields=[];
  const total=currentFields.length;
  attempts++;

  currentFields.forEach(f=>{
    const slot=document.querySelector(`.slot-box[data-field="${f}"]`);
    const icon=slot.querySelector('.slot-icon');
    const isCorrect=slotContents[f]===currentFicha.correct[f];

    if(isCorrect){
      slot.classList.add('correct');
      icon.innerHTML=SVG_CHECK;
      icon.classList.add('show');
      correctCount++;
      // Lock correct slots
      slot.style.pointerEvents='none';
    }else{
      slot.classList.add('incorrect');
      icon.innerHTML=SVG_CROSS;
      icon.classList.add('show');
      incorrectFields.push(f);
    }
  });

  $('btn-validate').classList.remove('show');

  if(correctCount===total||attempts>=2){
    // Final â€” lock everything, score, and move on
    document.querySelectorAll('.tag').forEach(t=>{t.style.pointerEvents='none'});
    document.querySelectorAll('.slot-box').forEach(s=>{s.style.pointerEvents='none'});

    // Calculate score (only first-attempt corrects get full points)
    const basePts=correctCount*30;
    const perfectBonus=(correctCount===total&&attempts===1)?60:0;
    const speedBonus=(correctCount===total&&attempts===1)?(elapsed<15?30:elapsed<25?15:0):0;
    const totalPts=basePts+perfectBonus+speedBonus;
    score+=totalPts;

    if(speedBonus>0)showSpeed(speedBonus);

    let fbText=`${correctCount}/${total} campos correctos`;
    if(incorrectFields.length>0){
      fbText+=`<div class="correction-list">${incorrectFields.map(f=>`<div class="correction-item err">â†’ ${FIELD_LABELS[f]}: ${currentFicha.correct[f]}</div>`).join('')}</div>`;
    }

    const isGood=correctCount>=2;
    showFeedback(isGood,fbText,totalPts);

    if(correctCount===total){
      showSalva('celebrating',pick(MSG_PERFECT));
    }else if(correctCount>=2){
      showSalva('happy',pick(MSG_GOOD));
    }else{
      showSalva('worried',pick(MSG_BAD));
    }

    updateHUD();
    waitForNext(()=>{fichaIdx++;playFicha()});
  }else{
    // Not all correct on first attempt â€” let them retry the wrong ones
    showSalva('worried','Revisa los campos en rojo. Â¡Puedes corregirlos!');

    // After a short pause, unlock incorrect slots for retry
    setTimeout(()=>{
      incorrectFields.forEach(f=>{
        const slot=document.querySelector(`.slot-box[data-field="${f}"]`);
        // Return the wrong answer to pool
        const wrongText=slotContents[f];
        clearSlot(f);
        if(wrongText)showTagInPool(wrongText);
        // Re-enable slot
        slot.style.pointerEvents='auto';
      });
      // Re-enable remaining tags
      document.querySelectorAll('.tag:not(.used)').forEach(t=>{t.style.pointerEvents='auto'});
      hideSalva();
      checkAllFilled();
    },1200);
  }
}

/* ========== RESULTS ========== */
function showResults(){
  showScreen('results');
  $('res-score').textContent=score;
  const isNew=score>record;
  if(isNew){record=score;localStorage.setItem('ficha_tecnica_record',record)}
  $('res-record').textContent=record;
  $('res-new').classList.toggle('show',isNew);

  if(score>=480){
    $('res-badge').classList.add('show');
    $('res-badge').textContent='MISIÃ“N COMPLETADA';
    $('res-av').src=A.salva_celebrating;
    $('res-sub').textContent='Â¡Manos de pro! Conoces tus herramientas.';
  }else if(score>=300){
    $('res-badge').classList.add('show');
    $('res-badge').textContent='MISIÃ“N COMPLETADA';
    $('res-av').src=A.salva_happy;
    $('res-sub').textContent='Aprobado, pero hay margen de mejora.';
  }else{
    $('res-badge').classList.remove('show');
    $('res-av').src=A.salva_worried;
    $('res-sub').textContent='Repasa el temario. Las mÃ¡quinas exigen respeto.';
  }

  $('res-rec-text').textContent='RÃ©cord: '+record+' pts';

  // Send TASK_COMPLETED if threshold met
  if(score>=300&&!taskCompleted){
    taskCompleted=true;
    try{window.ReactNativeWebView.postMessage(JSON.stringify({action:'TASK_COMPLETED'}))}catch(e){}
  }
}

/* ========== BOOT ========== */
init();
</script>
</body>
</html>
