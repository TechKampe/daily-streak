<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Salva-Herramientas</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--pri:#00E6BC;--acc:#04FFB4;--suc:#C5FFDF;--dan:#E74C3C;--war:#FFFFAB;--dk:#0B214A;--olive:#004957;--navy:#0B214A;--lime:#04FFB4;--lemon:#FFFFAB;--mint:#C5FFDF;--fire:#E74C3C;--turq:#00E6BC}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Baloo 2',cursive;background:#0a0a0a;touch-action:none}
body{padding-top:env(safe-area-inset-top);padding-top:constant(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-bottom:constant(safe-area-inset-bottom)}
#W{position:relative;width:100%;max-width:430px;margin:0 auto;height:100%;overflow:hidden;background:#0a0a0a}
.scr{position:absolute;inset:0;display:flex;flex-direction:column;transition:opacity .35s;z-index:100}
.scr.off{opacity:0;pointer-events:none;z-index:-1}
.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;pointer-events:none}
.dim{position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:1;pointer-events:none}
.btn{background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:19px;font-weight:700;padding:14px 48px;border-radius:50px;cursor:pointer;box-shadow:0 4px 16px rgba(0,230,188,.3);transition:transform .1s;letter-spacing:.5px}
.btn:active{transform:scale(.96)}

/* INTRO */
#intro{align-items:center;justify-content:flex-end;padding-bottom:40px}
.intro-card{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;padding:0 20px;width:100%}
.intro-av{width:260px;height:340px;object-fit:contain;filter:drop-shadow(0 4px 24px rgba(0,0,0,.6));margin-bottom:-40px;position:relative;z-index:1}
.intro-bub{position:relative;z-index:2;background:#fff;color:var(--navy);padding:20px 24px;border-radius:22px;box-shadow:0 4px 24px rgba(0,0,0,.35);font-size:17px;font-weight:600;line-height:1.45;text-align:center;margin-bottom:20px;width:100%}
.intro-title{font-size:28px;font-weight:800;color:#fff;text-shadow:0 3px 16px rgba(0,0,0,.5);margin-bottom:8px;z-index:10;position:relative}

/* HUD */
.hud{position:absolute;top:0;left:0;right:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;padding-right:66px;background:linear-gradient(180deg,rgba(11,33,74,.92)0%,rgba(11,33,74,.3)70%,transparent 100%);pointer-events:none}
.hud-left{display:flex;align-items:center;gap:8px}
.hud-pts{background:rgba(0,0,0,.5);padding:5px 14px;border-radius:20px;color:#fff;font-size:18px;font-weight:700}
.hud-round{background:rgba(0,0,0,.35);padding:4px 12px;border-radius:16px;color:rgba(255,255,255,.8);font-size:14px;font-weight:600}

/* GAMEPLAY */
#play{z-index:10}
.round-content{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:70px 16px 16px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.task-text{color:#fff;font-size:18px;font-weight:700;text-align:center;line-height:1.4;padding:14px 16px;background:var(--navy);border-radius:18px;margin-bottom:10px}
.task-label{color:rgba(255,255,255,.6);font-size:13px;font-weight:600;text-align:center;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}

/* OPTIONS (Type A/D) */
.options{display:flex;flex-direction:column;gap:10px;justify-content:flex-start}
.opt{display:flex;align-items:center;gap:14px;background:rgba(255,255,255,.88);border:2px solid rgba(255,255,255,.95);border-radius:18px;padding:12px 16px;cursor:pointer;transition:all .2s;touch-action:manipulation}
.opt:active{transform:scale(.97)}
.opt img{width:70px;height:70px;object-fit:contain;flex-shrink:0;filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.opt .opt-name{color:#1a1a1a;font-size:16px;font-weight:700;line-height:1.3}
.opt.correct{border-color:var(--turq);background:var(--mint)}
.opt.incorrect{border-color:var(--dan);background:rgba(231,76,60,.12)}
.opt.disabled{pointer-events:none;opacity:.35}
.opt.correct .opt-name{color:var(--navy)}
.opt.incorrect .opt-name{color:var(--dan)}

/* TYPE B - fault detection */
.fault-img-wrap{display:flex;justify-content:center;margin-bottom:8px}
.fault-img{width:220px;height:220px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(0,0,0,.5));border-radius:16px;background:rgba(255,255,255,.08);padding:14px}
.opt-text-only{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.88);border:2px solid rgba(255,255,255,.95);border-radius:18px;padding:14px 18px;cursor:pointer;transition:all .2s;touch-action:manipulation;color:#1a1a1a;font-size:15px;font-weight:600;line-height:1.3}
.opt-text-only:active{transform:scale(.97)}
.opt-text-only.correct{border-color:var(--turq);background:var(--mint);color:var(--navy)}
.opt-text-only.incorrect{border-color:var(--dan);background:rgba(231,76,60,.12);color:var(--dan)}
.opt-text-only.disabled{pointer-events:none;opacity:.35}

/* TYPE C2 - PH vs PHz */
.screw-img-wrap{display:flex;justify-content:center;margin-bottom:20px}
.screw-img{width:200px;height:200px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(0,0,0,.5));border-radius:50%;background:rgba(255,255,255,.85);padding:15px}
.btn-pair{display:flex;gap:12px;justify-content:center}
.btn-choice{flex:1;max-width:160px;padding:16px 10px;background:rgba(255,255,255,.85);border:2px solid rgba(255,255,255,.95);border-radius:18px;color:var(--navy);font-family:'Baloo 2',cursive;font-size:17px;font-weight:700;text-align:center;cursor:pointer;transition:all .2s;touch-action:manipulation}
.btn-choice:active{transform:scale(.96)}
.btn-choice.correct{border-color:var(--turq);background:var(--mint);color:var(--navy)}
.btn-choice.incorrect{border-color:var(--dan);background:rgba(231,76,60,.12);color:var(--dan)}
.btn-choice.disabled{pointer-events:none;opacity:1}

/* Comparison feedback */
.compare-wrap{display:flex;gap:16px;justify-content:center;align-items:center;margin:16px 0}
.compare-item{display:flex;flex-direction:column;align-items:center;gap:6px}
.compare-item img{width:100px;height:100px;object-fit:contain;border-radius:50%;background:rgba(255,255,255,.85);padding:8px}
.compare-label{color:#fff;font-size:14px;font-weight:700;background:rgba(0,0,0,.4);padding:3px 12px;border-radius:10px}
.compare-vs{color:rgba(255,255,255,.4);font-size:20px;font-weight:800}

.btn-confirm{margin-top:12px;width:100%;padding:14px;background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:17px;font-weight:700;border-radius:16px;cursor:pointer;touch-action:manipulation}
.btn-confirm:active{transform:scale(.97)}

/* TYPE C1 - Measure between marks */
.measure-area{position:relative;flex:1;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;gap:10px;padding:0 8px}
.wall-surface{position:relative;width:100%;height:120px;background:rgba(255,255,255,.06);border-radius:12px;border:1px solid rgba(255,255,255,.15);touch-action:none;overflow:visible}
/* Wall marks (start/end) */
.wall-pin{position:absolute;top:0;bottom:0;width:3px;z-index:5}
.wall-pin::before{content:'';position:absolute;top:12px;left:50%;transform:translateX(-50%);width:16px;height:16px;border-radius:50%}
.wall-pin::after{position:absolute;top:34px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:700;white-space:nowrap;letter-spacing:.5px}
.wall-pin.pin-a{background:var(--pri)}.wall-pin.pin-a::before{background:var(--pri)}.wall-pin.pin-a::after{content:'A';color:var(--pri)}
.wall-pin.pin-b{background:var(--dan)}.wall-pin.pin-b::before{background:var(--dan)}.wall-pin.pin-b::after{content:'B';color:var(--dan)}
/* Draggable metro tape */
.metro-tape{position:absolute;height:34px;bottom:8px;background:linear-gradient(180deg,#F7D33E,#E8C02A);border-radius:6px;z-index:10;cursor:grab;touch-action:none;box-shadow:0 2px 8px rgba(0,0,0,.3);overflow:hidden;transition:box-shadow .2s}
.metro-tape.dragging{cursor:grabbing;box-shadow:0 4px 16px rgba(0,0,0,.5)}
.metro-tape.placed{box-shadow:0 2px 8px rgba(0,0,0,.2)}
/* Tape handles */
.tape-handle{position:absolute;top:0;bottom:0;width:22px;z-index:12;cursor:ew-resize;touch-action:none;display:flex;align-items:center;justify-content:center}
.tape-handle::after{content:'';width:3px;height:18px;border-radius:2px;background:rgba(0,0,0,.3)}
.tape-handle-l{left:0;border-right:1px solid rgba(0,0,0,.15)}
.tape-handle-r{right:0;border-left:1px solid rgba(0,0,0,.15)}
/* Ruler ticks on tape */
.ruler-tick{position:absolute;top:0;width:1px;background:rgba(0,0,0,.4)}
.ruler-tick-label{position:absolute;bottom:2px;font-size:8px;font-weight:700;color:rgba(0,0,0,.6);transform:translateX(-50%);pointer-events:none;font-family:'Baloo 2',cursive}
/* Reading display */
.metro-reading{position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:#F7D33E;font-size:12px;font-weight:700;padding:2px 10px;border-radius:8px;white-space:nowrap;pointer-events:none;z-index:15}
/* Measure input area */
.measure-input-area{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%}
.measure-input-row{display:flex;align-items:center;gap:10px;justify-content:center}
.measure-input{width:90px;padding:10px 8px;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.25);border-radius:14px;color:#fff;font-family:'Baloo 2',cursive;font-size:22px;font-weight:700;text-align:center;outline:none;-webkit-appearance:none;appearance:none;transition:border-color .2s}
.measure-input:focus{border-color:var(--pri)}
.measure-input::placeholder{color:rgba(255,255,255,.3)}
.measure-unit{color:rgba(255,255,255,.6);font-size:18px;font-weight:700}
.measure-hint{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;text-align:center;line-height:1.4}
.measure-result{text-align:center;padding:8px 12px;border-radius:14px;font-size:13px;font-weight:700;line-height:1.3}
.measure-result.ok{background:rgba(0,230,188,.15);color:var(--turq)}
.measure-result.err{background:rgba(231,76,60,.15);color:var(--dan)}

/* FEEDBACK overlay */
.feedback-bar{position:absolute;bottom:0;left:0;right:0;z-index:60;padding:14px 16px 18px;min-height:88px;display:flex;align-items:center;gap:12px;transform:translateY(100%);transition:transform .3s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
.feedback-bar.show{transform:translateY(0);pointer-events:auto;cursor:pointer}
.feedback-bar.ok{background:var(--mint)}
.feedback-bar.err{background:rgba(231,76,60,.95)}
.fb-icon{width:36px;height:36px;object-fit:contain;flex-shrink:0}
.fb-text{color:#fff;font-size:14px;font-weight:600;line-height:1.3;flex:1}
.feedback-bar.ok .fb-text{color:var(--navy)}
.fb-right{display:flex;flex-direction:column;align-items:center;gap:6px;flex-shrink:0}
.fb-next{background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:14px;font-weight:700;padding:7px 20px;border-radius:20px;cursor:pointer;white-space:nowrap;pointer-events:auto;touch-action:manipulation}
.fb-next:active{transform:scale(.95);opacity:.8}

/* Speed badge */
.speed-badge{position:absolute;top:60px;right:16px;z-index:70;font-size:16px;font-weight:800;padding:6px 16px;border-radius:20px;color:#fff;opacity:0;transform:translateY(10px) scale(.8);transition:all .3s;pointer-events:none}
.speed-badge.show{opacity:1;transform:translateY(0) scale(1)}
.speed-badge.gold{background:linear-gradient(135deg,var(--lemon),#e6e68a);color:var(--navy);text-shadow:none}
.speed-badge.orange{background:linear-gradient(135deg,var(--turq),var(--lime));color:var(--navy);text-shadow:none}
.speed-badge.green{background:linear-gradient(135deg,var(--mint),var(--turq));color:var(--navy);text-shadow:none}

/* Salva popup */
.salva-popup{position:absolute;bottom:56px;left:8px;z-index:55;display:flex;align-items:flex-end;gap:8px;opacity:0;transform:translateX(-100%);transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
.salva-popup.show{opacity:1;transform:translateX(0)}
.salva-popup img{width:120px;height:157px;object-fit:contain;filter:drop-shadow(0 3px 12px rgba(0,0,0,.5))}
.salva-popup .salva-msg{background:#fff;color:var(--navy);font-size:13px;font-weight:600;padding:8px 14px;border-radius:14px;border-bottom-left-radius:4px;box-shadow:0 3px 14px rgba(0,0,0,.3);max-width:200px;line-height:1.3;margin-bottom:40px}

/* RESULTS */
#results{align-items:center;justify-content:center;padding:24px;z-index:200}
.res-inner{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;width:100%}
.res-badge{background:var(--turq);color:var(--navy);font-size:14px;font-weight:700;padding:6px 20px;border-radius:20px;margin-bottom:10px;display:none}
.res-badge.show{display:block}
.res-title{font-size:28px;font-weight:800;color:#fff;margin-bottom:4px}
.res-sub{font-size:14px;color:rgba(255,255,255,.6);margin-bottom:20px;text-align:center}
.res-scores{display:flex;gap:36px;margin-bottom:16px}
.res-val{font-size:42px;font-weight:800;text-align:center}
.res-label{font-size:12px;color:rgba(255,255,255,.5);font-weight:600;text-align:center}
.res-new{color:var(--lemon);font-size:16px;font-weight:800;margin-bottom:12px;display:none}
.res-new.show{display:block}
.res-bot{display:flex;flex-direction:column;align-items:center}
.res-av{width:280px;height:366px;object-fit:contain;filter:drop-shadow(0 4px 22px rgba(0,0,0,.5));margin-bottom:-30px;position:relative;z-index:1}
.res-bot .btn{position:relative;z-index:2}
.res-record{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:12px}

/* Phase transition */
.phase-trans{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:0}
.phase-trans img{width:200px;height:262px;object-fit:contain;filter:drop-shadow(0 4px 20px rgba(0,0,0,.5));margin-bottom:-12px;position:relative;z-index:1}
.phase-trans .phase-num{color:var(--turq);font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:2px}
.phase-trans .phase-title{color:#fff;font-size:22px;font-weight:800;text-align:center;line-height:1.3}
.phase-trans .phase-bub{background:#fff;color:var(--navy);font-size:15px;font-weight:600;padding:14px 20px;border-radius:18px;text-align:center;line-height:1.4;margin-top:0;box-shadow:0 4px 20px rgba(0,0,0,.3);max-width:340px}

@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.anim-in{animation:fadeInUp .4s ease-out both}
</style>
</head>
<body>
<div id="W">

<!-- INTRO -->
<div class="scr" id="intro">
    <img class="bg" id="intro-bg" alt="">
    <div class="dim"></div>
    <div class="intro-card">
        <h1 class="intro-title">Salva-Herramientas</h1>
        <img class="intro-av" id="intro-av" alt="Salva">
        <div class="intro-bub" id="intro-msg"></div>
        <button class="btn" id="intro-btn">¡A por ello!</button>
    </div>
</div>

<!-- GAMEPLAY -->
<div class="scr off" id="play">
    <img class="bg" id="play-bg" alt="">
    <div class="dim" id="play-dim"></div>
    <div class="hud">
        <div class="hud-left">
            <div class="hud-pts" id="hud-pts">0 aciertos</div>
            <div class="hud-round" id="hud-round">1/10</div>
        </div>
    </div>
    <div class="round-content" id="round-content"></div>
    <div class="feedback-bar" id="fb-bar">
        <img class="fb-icon" id="fb-icon" alt="">
        <div class="fb-text" id="fb-text"></div>
        <div class="fb-right">
            <button class="fb-next" id="fb-next" style="display:none">Siguiente</button>
        </div>
    </div>
    <div class="speed-badge" id="speed-badge"></div>
    <div class="salva-popup" id="salva-pop">
        <img id="salva-pop-img" alt="Salva">
        <div class="salva-msg" id="salva-pop-msg"></div>
    </div>
</div>

<!-- RESULTS -->
<div class="scr off" id="results">
    <img class="bg" id="res-bg" alt="">
    <div class="dim"></div>
    <div class="res-inner">
        <div class="res-badge" id="res-badge">MISIÓN COMPLETADA</div>
        <h2 class="res-title">Fin de partida</h2>
        <p class="res-sub" id="res-sub"></p>
        <div class="res-scores">
            <div><div class="res-val" id="res-score" style="color:#00E6BC">0</div><div class="res-label">Puntuación</div></div>
            <div><div class="res-val" id="res-record" style="color:#FFFFAB">0</div><div class="res-label">Récord</div></div>
        </div>
        <div class="res-new" id="res-new">¡NUEVO RÉCORD!</div>
        <div class="res-bot">
            <img class="res-av" id="res-av" alt="Salva">
            <button class="btn" id="res-btn">¡Otra ronda!</button>
        </div>
        <div class="res-record" id="res-rec-text"></div>
    </div>
</div>

</div>
<script>
/* ========== ASSET PATHS ========== */
const CL_S1D1='https://res.cloudinary.com/kampe/image/upload/v1771521';
const CL_ICO='https://res.cloudinary.com/kampe/image/upload/v1771531';
const A={
  bg_taller:'https://res.cloudinary.com/kampe/image/upload/v1771938582/bg_taller_pr4v4o.png',
  bg_pared:'https://res.cloudinary.com/kampe/image/upload/v1771938582/bg_pared_dsfavb.png',
  salva_base:'https://res.cloudinary.com/kampe/image/upload/v1771938594/salva_base_x8eghx.png',
  salva_happy:'https://res.cloudinary.com/kampe/image/upload/v1771938597/salva_happy_ccjemp.png',
  salva_celebrating:'https://res.cloudinary.com/kampe/image/upload/v1771938594/salva_celebrating_xki0p5.png',
  salva_worried:'https://res.cloudinary.com/kampe/image/upload/v1771938598/salva_worried_glnc2b.png',
  salva_facepalm:'https://res.cloudinary.com/kampe/image/upload/v1771938595/salva_facepalm_iz3myg.png',
  tool_crimpadora:'https://res.cloudinary.com/kampe/image/upload/v1771938599/tool_crimpadora_nzrwsh.png',
  tool_cortatubos:'https://res.cloudinary.com/kampe/image/upload/v1771938598/tool_cortatubos_wxfcco.png',
  tool_destornillador_ph:'https://res.cloudinary.com/kampe/image/upload/v1771938603/tool_destornillador_ph_yea1nm.png',
  tool_destornillador_phz:'https://res.cloudinary.com/kampe/image/upload/v1771938604/tool_destornillador_phz_johk6g.png',
  tool_destornillador_plano:'https://res.cloudinary.com/kampe/image/upload/v1771938607/tool_destornillador_plano_pduxjx.png',
  tool_cutter:'https://res.cloudinary.com/kampe/image/upload/v1771938603/tool_cuter_cfwncu.png',
  tool_metro:'https://res.cloudinary.com/kampe/image/upload/v1771938608/tool_metro_laxn2g.png',
  cinta_marron:'https://res.cloudinary.com/kampe/image/upload/v1771938583/cinta_marron_se3xzt.png',
  cinta_negra:'https://res.cloudinary.com/kampe/image/upload/v1771938587/cinta_negra_trds2n.png',
  cinta_gris:'https://res.cloudinary.com/kampe/image/upload/v1771938582/cinta_gris_kvqedl.png',
  cinta_azul:'https://res.cloudinary.com/kampe/image/upload/v1771938582/cinta_azul_gxsfda.png',
  cinta_verde_amarillo:'https://res.cloudinary.com/kampe/image/upload/v1771938588/cinta_verde_amarillo_tozehc.png',
  tornillo_ph:'https://res.cloudinary.com/kampe/image/upload/v1771938610/tornillo_ph_ddocxr.png',
  tornillo_phz:'https://res.cloudinary.com/kampe/image/upload/v1771938612/tornillo_phz_kuzlqo.png',
  fallo_destornillador_roto:'https://res.cloudinary.com/kampe/image/upload/v1771938591/fallo_destornillador_roto_kbhfll.png',
  fallo_alicate_sin_aislante:'https://res.cloudinary.com/kampe/image/upload/v1771938588/fallo_alicate_sin_aislante_czv6qb.png',
  fallo_cutter_hoja_entera:'https://res.cloudinary.com/kampe/image/upload/v1771938590/fallo_cutter_hoja_entera_kurxcc.png',
  fallo_cable_mal_pelado:'https://res.cloudinary.com/kampe/image/upload/v1771938590/fallo_cable_mal_pelado_ri26yh.png',
  // Reuse from Cloudinary s1d1
  tool_alicates:CL_S1D1+'711/kampe/game_assets/s1d1/tool_alicates.png',
  tool_pelacables:'https://res.cloudinary.com/kampe/image/upload/v1771952270/pelacables_ns59sk.png',
  tool_tijera_electricista:CL_S1D1+'757/kampe/game_assets/s1d1/tool_tijera_electricista.png',
  tool_llave_inglesa:CL_S1D1+'714/kampe/game_assets/s1d1/tool_llave_inglesa.png',
  tool_nivel_laser:CL_S1D1+'720/kampe/game_assets/s1d1/tool_nivel_laser.png',
  ico_check:CL_ICO+'177/icono_check.png',
  ico_cruz:CL_ICO+'178/icono_cruz.png',
  ico_trofeo:'https://res.cloudinary.com/kampe/image/upload/v1771531886/icono_trofeo.png',
  ico_diana:CL_ICO+'175/icono_acierto.png'
};

/* ========== ROUND DATA ========== */
const POOL_A=[
  {id:'A1',type:'A',task:'Cortar una brida que sujeta un mazo de cables',correct:{name:'Alicates de corte',img:A.tool_alicates},opts:[{name:'Destornillador PH',img:A.tool_destornillador_ph},{name:'Pelacables',img:A.tool_pelacables}],explain:'Los alicates de corte son la herramienta correcta para cortar bridas de forma limpia y segura.'},
  {id:'A2',type:'A',task:'Crimpar un terminal de punta en un cable de 2.5mm',correct:{name:'Crimpadora',img:A.tool_crimpadora},opts:[{name:'Alicates',img:A.tool_alicates},{name:'Pelacables',img:A.tool_pelacables}],explain:'La crimpadora asegura una conexión firme y fiable del terminal al cable.'},
  {id:'A3',type:'A',task:'Cortar un tubo corrugado de 20mm a medida',correct:{name:'Cortatubos',img:A.tool_cortatubos},opts:[{name:'Cutter',img:A.tool_cutter},{name:'Tijera electricista',img:A.tool_tijera_electricista}],explain:'El cortatubos da un corte limpio y perpendicular sin aplastar el tubo.'},
  {id:'A4',type:'A',task:'Apretar un tornillo con cabeza Phillips',correct:{name:'Destornillador PH',img:A.tool_destornillador_ph},opts:[{name:'Destornillador PHz',img:A.tool_destornillador_phz},{name:'Llave inglesa',img:A.tool_llave_inglesa}],explain:'Un tornillo Phillips necesita un destornillador PH. Usar PHz puede resbalar.'},
  {id:'A5',type:'A',task:'Apretar un tornillo Pozidriv en un mecanismo',correct:{name:'Destornillador PHz',img:A.tool_destornillador_phz},opts:[{name:'Destornillador PH',img:A.tool_destornillador_ph},{name:'Destornillador plano',img:A.tool_destornillador_plano}],explain:'Los tornillos Pozidriv tienen marcas extra entre los brazos. Usa siempre PHz.'},
  {id:'A6',type:'A',task:'Pelar el extremo de un cable unipolar de 2.5mm',correct:{name:'Pelacables',img:A.tool_pelacables},opts:[{name:'Cutter',img:A.tool_cutter},{name:'Alicates',img:A.tool_alicates}],explain:'El pelacables tiene muescas calibradas que pelan sin dañar el conductor.'},
  {id:'A7',type:'A',task:'Marcar el punto de taladro en la pared',correct:{name:'Metro + lápiz',img:A.tool_metro},opts:[{name:'Nivel láser',img:A.tool_nivel_laser},{name:'Destornillador',img:A.tool_destornillador_plano}],explain:'Medir con metro y marcar con lápiz: medida precisa y marca visible.'},
  {id:'A8',type:'A',task:'Sujetar un cable para fijarlo con brida',correct:{name:'Alicates universales',img:A.tool_alicates},opts:[{name:'Destornillador',img:A.tool_destornillador_ph},{name:'Llave inglesa',img:A.tool_llave_inglesa}],explain:'Los alicates universales sujetan con firme control sin dañar el cable.'},
  {id:'A9',type:'A',task:'Retirar un tornillo de cabeza plana de una tapa',correct:{name:'Destornillador plano',img:A.tool_destornillador_plano},opts:[{name:'Destornillador PH',img:A.tool_destornillador_ph},{name:'Cutter',img:A.tool_cutter}],explain:'Un tornillo de cabeza plana necesita un destornillador plano bien alineado.'},
  {id:'A10',type:'A',task:'Cortar el sobrante de una brida ya apretada',correct:{name:'Alicates de corte',img:A.tool_alicates},opts:[{name:'Cutter',img:A.tool_cutter},{name:'Tijera electricista',img:A.tool_tijera_electricista}],explain:'Los alicates de corte dan un corte limpio al ras sin dejar punta peligrosa.'}
];

const POOL_B=[
  {id:'B1',type:'B',task:'Detecta el fallo en esta herramienta',img:A.fallo_destornillador_roto,correct:'Punta desgastada — hay que cambiarla',opts:['Está bien, se puede usar','Solo necesita limpieza'],explain:'Una punta desgastada resbala, no transmite fuerza y puede dañar el tornillo o causar un accidente.',isSafety:true},
  {id:'B2',type:'B',task:'Detecta el fallo en esta herramienta',img:A.fallo_alicate_sin_aislante,correct:'Sin aislante en mangos — riesgo eléctrico',opts:['Es normal en alicates viejos','Solo afecta al agarre'],explain:'Sin aislante hay riesgo de descarga eléctrica. Nunca uses herramientas con mangos pelados.',isSafety:true},
  {id:'B3',type:'B',task:'Detecta el fallo en esta herramienta',img:A.fallo_cutter_hoja_entera,correct:'Hoja sacada de más — saca solo lo justo',opts:['Más hoja = corta mejor','Es correcto para material grueso'],explain:'La hoja del cútter se saca solo lo justo. Más hoja = más riesgo de corte y rotura.',isSafety:true},
  {id:'B4',type:'B',task:'Detecta el fallo en este cable',img:A.fallo_cable_mal_pelado,correct:'Conductor dañado — mal pelado, repetir',opts:['Se puede usar, es un rasguño','Basta con poner cinta'],explain:'Un conductor dañado reduce la sección y puede provocar calentamiento o fallo. Hay que repetir el pelado.',isSafety:true}
];

const POOL_D=[
  {id:'D1',type:'D',task:'Marcar un cable de Fase L1',correct:{name:'Cinta marrón',img:A.cinta_marron},opts:[{name:'Cinta azul',img:A.cinta_azul},{name:'Cinta verde-amarillo',img:A.cinta_verde_amarillo}],explain:'La Fase L1 se identifica con color marrón según normativa.'},
  {id:'D2',type:'D',task:'Identificar el cable de Neutro',correct:{name:'Cinta azul',img:A.cinta_azul},opts:[{name:'Cinta negra',img:A.cinta_negra},{name:'Cinta marrón',img:A.cinta_marron}],explain:'El Neutro siempre es azul. Es el único color reservado exclusivamente para el neutro.'},
  {id:'D3',type:'D',task:'Marcar el cable de Tierra',correct:{name:'Cinta verde-amarillo',img:A.cinta_verde_amarillo},opts:[{name:'Cinta gris',img:A.cinta_gris},{name:'Cinta azul',img:A.cinta_azul}],explain:'La Tierra se identifica con el bicolor verde-amarillo. Nunca uses otro color.'}
];

/* ========== GAME STATE ========== */
let score=0,roundIdx=0,rounds=[],roundStartTime=0,hits=0,record=parseInt(localStorage.getItem('salva_herramientas_record'))||0;
let taskCompleted=false;
let _cleanup=[];
let phase=0; // 0=not started, 1,2,3
let totalRounds=0;

const $=id=>document.getElementById(id);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
function addDocListener(evt,fn,opts){document.addEventListener(evt,fn,opts);_cleanup.push(()=>document.removeEventListener(evt,fn,opts))}
function cleanupListeners(){_cleanup.forEach(fn=>fn());_cleanup=[]}

/* ========== SALVA MESSAGES ========== */
const MSG_FAST=["¡Manos de pro!","¡Eso es!","¡Crack!","¡Velocidad y precisión!","¡Como un veterano!"];
const MSG_OK=["¡Correcto!","¡Bien visto!","¡Así se hace!","¡Toma ya!"];
const MSG_ERR=["¡Ojo!","Casi...","No era esa..."];
const MSG_SAFETY=["¡Para! Eso es peligroso.","¡Así no! Cuidado."];
const pick=arr=>arr[Math.floor(Math.random()*arr.length)];

/* ========== SCREENS ========== */
function showScreen(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.add('off'));
  $(id).classList.remove('off');
}

/* ========== INIT ========== */
function init(){
  $('intro-bg').src=A.bg_taller;
  $('intro-av').src=A.salva_happy;
  $('intro-msg').textContent='¡Ey! Soy Salva. ¿Tienes manos de pro o te van a temblar?';
  $('intro-btn').onclick=startGame;
  $('res-btn').onclick=startGame;
  showScreen('intro');
}

/* ========== BUILD PHASES ========== */
// Phase 1: selection (A + D), Phase 2: faults + screws (B + C2), Phase 3: measure (C1)
function buildPhases(){
  // Phase 1: pick 5 from A+D pool (shuffled)
  const selPool=[...POOL_A,...POOL_D];
  shuffle(selPool);
  const phase1=selPool.slice(0,5);

  // Phase 2: all B + C2 (screw identification + V/F)
  const phase2=[...shuffle([...POOL_B]),{id:'C2',type:'C2'}];

  // Phase 3: measure
  const phase3=[{id:'C1',type:'C1'}];

  return {phase1,phase2,phase3};
}

let phases={};

function startGame(){
  score=0;roundIdx=0;hits=0;taskCompleted=false;phase=0;
  phases=buildPhases();
  totalRounds=phases.phase1.length+phases.phase2.length+phases.phase3.length;
  rounds=[];
  $('play-bg').src=A.bg_taller;
  $('res-bg').src=A.bg_taller;
  showScreen('play');
  startPhase(1);
}

function startPhase(p){
  phase=p;
  if(p===1){
    rounds=phases.phase1;
    roundIdx=0;
    showPhaseTransition(
      'Fase 1 de 3',
      'Elige la herramienta',
      '¡A ver si sabes qué herramienta usar en cada situación. Piensa rápido!',
      'salva_happy',
      ()=>playRound()
    );
  }else if(p===2){
    rounds=phases.phase2;
    roundIdx=0;
    showPhaseTransition(
      'Fase 2 de 3',
      'Revisa tus herramientas',
      '¡Bien! Ahora analiza tus herramientas. No puedes llevarlas ni usarlas de forma errónea.',
      'salva_base',
      ()=>playRound()
    );
  }else if(p===3){
    rounds=phases.phase3;
    roundIdx=0;
    showPhaseTransition(
      'Fase 3 de 3',
      'Mide como un pro',
      '¡Última prueba! Demuestra que sabes medir con precisión.',
      'salva_celebrating',
      ()=>playRound()
    );
  }
}

function showPhaseTransition(label,title,msg,expr,onContinue){
  cleanupListeners();
  hideFeedback();hideSalva();hideSpeed();
  const content=$('round-content');
  $('play-bg').src=A.bg_taller;
  $('play-dim').style.background='rgba(0,0,0,.6)';
  content.innerHTML=`
    <div class="phase-trans anim-in">
      <div class="phase-num">${label}</div>
      <div class="phase-title">${title}</div>
      <img src="${A[expr]}" alt="Salva">
      <div class="phase-bub">${msg}</div>
      <button class="btn" id="phase-btn" style="margin-top:16px">¡Vamos!</button>
    </div>`;
  updateHUD();
  $('phase-btn').onclick=onContinue;
}

function getGlobalRoundNum(){
  if(!totalRounds)return 1;
  let n=0;
  if(phase>=2)n+=phases.phase1.length;
  if(phase>=3)n+=phases.phase2.length;
  return Math.min(n+roundIdx+1,totalRounds);
}

function updateHUD(){
  $('hud-pts').textContent=hits+' aciertos';
  $('hud-round').textContent=getGlobalRoundNum()+'/'+totalRounds;
}

/* ========== PLAY ROUND ========== */
function playRound(){
  if(roundIdx>=rounds.length){
    // Phase complete — go to next phase or results
    if(phase<3){startPhase(phase+1)}
    else{showResults()}
    return;
  }
  cleanupListeners();
  updateHUD();
  const r=rounds[roundIdx];
  const content=$('round-content');
  content.innerHTML='';
  hideFeedback();hideSalva();hideSpeed();

  // Set background per phase
  if(r.type==='C1'){$('play-bg').src=A.bg_pared;$('play-dim').style.background='rgba(0,0,0,.35)'}
  else{$('play-bg').src=A.bg_taller;$('play-dim').style.background='rgba(0,0,0,.5)'}

  roundStartTime=Date.now();

  switch(r.type){
    case 'A':case 'D':renderSelection(r,content);break;
    case 'B':renderFault(r,content);break;
    case 'C1':renderMeasure(content);break;
    case 'C2':renderScrewPhase1(content);break;
  }
}

/* ========== TYPE A/D: SELECTION ========== */
function renderSelection(r,el){
  const label=r.type==='D'?'¿Qué cinta corresponde?':'Elige la herramienta';
  const allOpts=[{...r.correct,isCorrect:true},...r.opts.map(o=>({...o,isCorrect:false}))];
  shuffle(allOpts);

  el.innerHTML=`
    <div class="task-label">${label}</div>
    <div class="task-text">${r.task}</div>
    <div class="options" id="opts"></div>`;

  const optsEl=$('opts');
  allOpts.forEach(o=>{
    const div=document.createElement('div');
    div.className='opt anim-in';
    div.innerHTML=`<img src="${o.img}" alt="${o.name}"><div class="opt-name">${o.name}</div>`;
    div.onclick=()=>handleSelection(r,o,div,optsEl);
    optsEl.appendChild(div);
  });
}

function handleSelection(r,chosen,el,container){
  const elapsed=(Date.now()-roundStartTime)/1000;
  const correct=chosen.isCorrect;
  container.querySelectorAll('.opt').forEach(o=>{o.classList.add('disabled')});

  if(correct){
    el.classList.add('correct');
    const bonus=elapsed<3?50:elapsed<5?30:elapsed<8?10:0;
    const pts=100+bonus;
    score+=pts;hits++;
    showFeedback(true,r.explain,pts);
    showSpeed(bonus);
    showSalva(bonus>=30?'celebrating':'happy',bonus>=30?pick(MSG_FAST):pick(MSG_OK));
  }else{
    el.classList.add('incorrect');
    container.querySelectorAll('.opt').forEach(o=>{if(o!==el&&o.querySelector('.opt-name').textContent===r.correct.name)o.classList.add('correct')});
    showFeedback(false,r.explain,0);
    showSalva(r.isSafety?'facepalm':'worried',r.isSafety?pick(MSG_SAFETY):pick(MSG_ERR));
  }
  waitForNext(nextRound);
}

/* ========== TYPE B: FAULT ========== */
function renderFault(r,el){
  const allOpts=[{text:r.correct,isCorrect:true},...r.opts.map(t=>({text:t,isCorrect:false}))];
  shuffle(allOpts);

  el.innerHTML=`
    <div class="task-label">Detecta el fallo</div>
    <div class="task-text">${r.task}</div>
    <div class="fault-img-wrap"><img class="fault-img" src="${r.img}" alt="Herramienta con fallo"></div>
    <div class="options" id="opts"></div>`;

  const optsEl=$('opts');
  allOpts.forEach(o=>{
    const div=document.createElement('div');
    div.className='opt-text-only anim-in';
    div.textContent=o.text;
    div.onclick=()=>handleFault(r,o,div,optsEl);
    optsEl.appendChild(div);
  });
}

function handleFault(r,chosen,el,container){
  const elapsed=(Date.now()-roundStartTime)/1000;
  const correct=chosen.isCorrect;
  container.querySelectorAll('.opt-text-only').forEach(o=>o.classList.add('disabled'));

  if(correct){
    el.classList.add('correct');
    const bonus=elapsed<3?50:elapsed<5?30:elapsed<8?10:0;
    const pts=100+bonus;
    score+=pts;hits++;
    showFeedback(true,r.explain,pts);
    showSpeed(bonus);
    showSalva(bonus>=30?'celebrating':'happy',bonus>=30?pick(MSG_FAST):pick(MSG_OK));
  }else{
    el.classList.add('incorrect');
    container.querySelectorAll('.opt-text-only').forEach(o=>{if(!o.classList.contains('incorrect')&&o.textContent===r.correct)o.classList.add('correct')});
    showFeedback(false,r.explain,0);
    showSalva('facepalm',pick(MSG_SAFETY));
  }
  waitForNext(nextRound);
}

/* ========== TYPE C1: MEASURE BETWEEN MARKS ========== */
function renderMeasure(el){
  const wallCmTotal=50;
  // Random distance between A and B: 12-38cm
  const realDistance=pick([12,15,18,20,22,25,28,30,33,35]);
  // Place A randomly so B fits
  const pinACm=Math.floor(Math.random()*(wallCmTotal-realDistance-6))+3;
  const pinBCm=pinACm+realDistance;
  let done=false;

  el.innerHTML=`
    <div class="task-label">Mide como un pro</div>
    <div class="task-text">Mide la distancia entre A y B.<br>Coloca el metro y anota la medida.</div>
    <div class="measure-area">
      <div class="wall-surface" id="wall">
        <div class="wall-pin pin-a" id="pin-a"></div>
        <div class="wall-pin pin-b" id="pin-b"></div>
        <div class="metro-tape" id="metro">
          <div class="tape-handle tape-handle-l" id="handle-l"></div>
          <div class="tape-handle tape-handle-r" id="handle-r"></div>
          <div class="metro-reading" id="metro-read">0 cm</div>
        </div>
      </div>
      <div class="measure-hint" id="m-hint">Arrastra el metro y ajusta los extremos a las marcas A y B</div>
      <div class="measure-input-area" id="input-area" style="display:none">
        <div class="measure-input-row">
          <input type="number" class="measure-input" id="m-input" placeholder="?" min="1" max="50" inputmode="numeric">
          <span class="measure-unit">cm</span>
        </div>
        <button class="btn" id="m-confirm" style="padding:10px 36px;font-size:16px">Confirmar medida</button>
      </div>
      <div id="m-result"></div>
    </div>`;

  const wall=$('wall');
  const pinA=$('pin-a');
  const pinB=$('pin-b');
  const metro=$('metro');
  const handleL=$('handle-l');
  const handleR=$('handle-r');
  const readingEl=$('metro-read');
  const inputArea=$('input-area');

  const pxPerCm=()=>wall.getBoundingClientRect().width/wallCmTotal;
  const HANDLE_PX=22; // handle width in px

  // mLeft/mRight = scale positions (where 0cm and final cm are) in cm
  let mLeft=2, mRight=12;
  let metroPlaced=false;

  function setup(){
    const pc=pxPerCm();
    pinA.style.left=(pinACm*pc)+'px';
    pinB.style.left=(pinBCm*pc)+'px';
    renderMetro();
  }
  setTimeout(setup,50);

  function renderMetro(){
    const pc=pxPerCm();
    // Metro div starts HANDLE_PX before the 0-mark
    const scalePx=(mRight-mLeft)*pc;
    const totalW=scalePx+HANDLE_PX*2;
    metro.style.left=(mLeft*pc-HANDLE_PX)+'px';
    metro.style.width=Math.max(totalW,HANDLE_PX*2+20)+'px';
    // Reading
    const reading=Math.round(mRight-mLeft);
    readingEl.textContent=reading+' cm';
    buildTapeTicks();
    checkPlacement();
  }

  function checkPlacement(){
    if(done)return;
    const tolerance=2;
    const nearA=Math.abs(mLeft-pinACm)<=tolerance;
    const nearB=Math.abs(mRight-pinBCm)<=tolerance;
    const isPlaced=nearA&&nearB;
    if(isPlaced&&!metroPlaced){
      metroPlaced=true;
      metro.classList.add('placed');
      inputArea.style.display='flex';
      $('m-hint').textContent='¡Bien colocado! Ahora escribe la medida que lees en el metro.';
      showSalva('happy','¡Metro bien puesto! Ahora lee la medida.');
    }else if(!isPlaced&&metroPlaced){
      metroPlaced=false;
      metro.classList.remove('placed');
      inputArea.style.display='none';
      $('m-hint').textContent='Arrastra el metro y ajusta los extremos a las marcas A y B';
      hideSalva();
    }
  }

  function buildTapeTicks(){
    metro.querySelectorAll('.ruler-tick,.ruler-tick-label').forEach(t=>t.remove());
    const pc=pxPerCm();
    const cmLen=Math.round(mRight-mLeft);
    for(let cm=0;cm<=cmLen;cm++){
      const x=cm*pc;
      const tick=document.createElement('div');
      tick.className='ruler-tick';
      tick.style.left=(HANDLE_PX+x)+'px';
      tick.style.height=cm%10===0?'70%':cm%5===0?'50%':'30%';
      if(cm%10===0)tick.style.background='rgba(0,0,0,.6)';
      metro.appendChild(tick);
      if(cm%5===0){
        const lbl=document.createElement('div');
        lbl.className='ruler-tick-label';
        lbl.style.left=(HANDLE_PX+x)+'px';
        lbl.textContent=cm;
        metro.appendChild(lbl);
      }
    }
  }

  // === DRAG LOGIC ===
  let dragMode=null; // 'move','left','right'
  let dragStartX=0, dragStartLeft=0, dragStartRight=0;

  function startDrag(mode,clientX){
    if(done)return;
    dragMode=mode;
    dragStartX=clientX;
    dragStartLeft=mLeft;
    dragStartRight=mRight;
    if(mode==='move')metro.classList.add('dragging');
  }

  function onDrag(clientX){
    if(!dragMode||done)return;
    const pc=pxPerCm();
    const deltaCm=(clientX-dragStartX)/pc;

    const hCm=HANDLE_PX/pc; // handle width in cm
    if(dragMode==='move'){
      let newL=dragStartLeft+deltaCm;
      let newR=dragStartRight+deltaCm;
      const len=newR-newL;
      if(newL<hCm){newL=hCm;newR=hCm+len}
      if(newR>wallCmTotal-hCm){newR=wallCmTotal-hCm;newL=newR-len}
      mLeft=newL;mRight=newR;
    }else if(dragMode==='left'){
      let newL=dragStartLeft+deltaCm;
      newL=Math.max(hCm,Math.min(newL,mRight-3));
      mLeft=newL;
    }else if(dragMode==='right'){
      let newR=dragStartRight+deltaCm;
      newR=Math.min(wallCmTotal-hCm,Math.max(newR,mLeft+3));
      mRight=newR;
    }
    renderMetro();
  }

  function endDrag(){
    dragMode=null;
    metro.classList.remove('dragging');
    // Snap to nearest cm
    mLeft=Math.round(mLeft);
    mRight=Math.round(mRight);
    renderMetro();
  }

  // Mouse events on metro body (move)
  metro.addEventListener('mousedown',e=>{
    if(e.target===handleL||e.target===handleR)return;
    e.preventDefault();startDrag('move',e.clientX);
  });
  metro.addEventListener('touchstart',e=>{
    if(e.target===handleL||e.target===handleR)return;
    e.preventDefault();startDrag('move',e.touches[0].clientX);
  },{passive:false});

  // Handle events
  handleL.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();startDrag('left',e.clientX)});
  handleL.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();startDrag('left',e.touches[0].clientX)},{passive:false});
  handleR.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();startDrag('right',e.clientX)});
  handleR.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();startDrag('right',e.touches[0].clientX)},{passive:false});

  // Document-level move/end
  addDocListener('mousemove',e=>{onDrag(e.clientX)});
  addDocListener('mouseup',()=>{if(dragMode)endDrag()});
  addDocListener('touchmove',e=>{if(dragMode){e.preventDefault();onDrag(e.touches[0].clientX)}},{passive:false});
  addDocListener('touchend',()=>{if(dragMode)endDrag()});

  // === CONFIRM MEASUREMENT ===
  $('m-confirm').onclick=()=>{
    if(done)return;
    const answer=parseInt($('m-input').value);
    if(isNaN(answer)||answer<1){
      $('m-hint').textContent='¡Escribe un número válido!';
      return;
    }
    done=true;
    const diff=Math.abs(answer-realDistance);
    const resultEl=$('m-result');

    if(diff===0){
      score+=150;hits++;
      resultEl.className='measure-result ok';
      resultEl.textContent='¡Perfecto! La distancia es '+realDistance+'cm. Mides como un profesional.';
      showFeedback(true,'¡Medida exacta! Mido 2 veces, anoto 1.',150);
      showSalva('celebrating','¡Exacto! '+realDistance+'cm!');
    }else if(diff<=1){
      score+=100;hits++;
      resultEl.className='measure-result ok';
      resultEl.textContent='¡Casi perfecto! La distancia exacta es '+realDistance+'cm. Tu medida: '+answer+'cm.';
      showFeedback(true,'¡Muy cerca! Solo '+diff+'cm de diferencia.',100);
      showSalva('happy','¡Casi! Buen ojo.');
    }else{
      resultEl.className='measure-result err';
      resultEl.textContent='La distancia correcta es '+realDistance+'cm. Tu medida: '+answer+'cm. Diferencia: '+diff+'cm.';
      showFeedback(false,'Recuerda: coloca bien el metro y lee con atención. Mido 2 veces, anoto 1.',0);
      showSalva('worried','Repasa la medición. ¡Mide dos veces!');
    }
    inputArea.style.display='none';
    $('m-hint').textContent='Mido 2 veces, anoto 1.';
    updateHUD();
    waitForNext(nextRound);
  };
}

/* ========== TYPE C2: PH vs PHz ========== */
function renderScrewPhase1(el){
  const showPH=Math.random()<0.5;
  const screwImg=showPH?A.tornillo_ph:A.tornillo_phz;
  const correctAnswer=showPH?'PH':'PHz';

  el.innerHTML=`
    <div class="task-label">Identifica el tornillo</div>
    <div class="task-text">¿Qué tipo de tornillo es este?</div>
    <div class="screw-img-wrap"><img class="screw-img" src="${screwImg}" alt="Tornillo"></div>
    <div class="btn-pair" id="screw-opts">
      <div class="btn-choice" data-val="PH">Phillips<br>(PH)</div>
      <div class="btn-choice" data-val="PHz">Pozidriv<br>(PHz)</div>
    </div>`;

  $('screw-opts').querySelectorAll('.btn-choice').forEach(btn=>{
    btn.onclick=()=>handleScrewPhase1(btn,correctAnswer,el);
  });
}

function handleScrewPhase1(btn,correct,el){
  const chosen=btn.dataset.val;
  const isCorrect=chosen===correct;
  const opts=el.querySelectorAll('.btn-choice');
  opts.forEach(o=>{o.classList.add('disabled');if(o.dataset.val===correct)o.classList.add('correct');if(o===btn&&!isCorrect)o.classList.add('incorrect')});

  if(isCorrect){score+=100;hits++;updateHUD();showSalva('happy','¡Bien visto!')}
  else{showSalva('worried','Fíjate en las marcas entre los brazos de la cruz')}

  // Hide Salva so comparison is visible
  setTimeout(()=>hideSalva(),800);
  // Show comparison
  const compare=document.createElement('div');
  compare.className='compare-wrap anim-in';
  compare.innerHTML=`
    <div class="compare-item"><img src="${A.tornillo_ph}" alt="PH"><div class="compare-label">PH (cruz simple)</div></div>
    <div class="compare-vs">vs</div>
    <div class="compare-item"><img src="${A.tornillo_phz}" alt="PHz"><div class="compare-label">PHz (cruz + marcas)</div></div>`;
  $('round-content').appendChild(compare);

  setTimeout(()=>renderScrewPhase2(el),2200);
}

function renderScrewPhase2(el){
  hideSalva();hideFeedback();
  const content=$('round-content');
  content.innerHTML=`
    <div class="task-label">Verdadero o Falso</div>
    <div class="task-text">¿Puedo usar un destornillador PH en un tornillo PHz?</div>
    <div style="display:flex;justify-content:center;align-items:center;gap:12px;margin:16px 0">
      <img src="${A.tool_destornillador_ph}" style="width:60px;height:60px;object-fit:contain" alt="PH">
      <span style="color:rgba(255,255,255,.5);font-size:24px;font-weight:800">?</span>
      <img src="${A.tornillo_phz}" style="width:60px;height:60px;object-fit:contain" alt="PHz">
    </div>
    <div class="btn-pair" id="vf-opts">
      <div class="btn-choice" data-val="true">VERDADERO</div>
      <div class="btn-choice" data-val="false">FALSO</div>
    </div>`;

  roundStartTime=Date.now();
  $('vf-opts').querySelectorAll('.btn-choice').forEach(btn=>{
    btn.onclick=()=>handleScrewPhase2(btn);
  });
}

function handleScrewPhase2(btn){
  const chosen=btn.dataset.val;
  const isCorrect=chosen==='false';
  const opts=document.querySelectorAll('#vf-opts .btn-choice');
  opts.forEach(o=>{o.classList.add('disabled');if(o.dataset.val==='false')o.classList.add('correct');if(o===btn&&!isCorrect)o.classList.add('incorrect')});

  if(isCorrect){
    score+=100;hits++;
    showFeedback(true,'Siempre usa el destornillador correcto. Un PH en un PHz resbala y puede dañar la cabeza del tornillo.',100);
    showSalva('celebrating','¡Exacto! Cada tornillo tiene su destornillador.');
  }else{
    showFeedback(false,'Siempre hay que usar el destornillador correcto. Un PH en un PHz puede resbalar, dañar la cabeza del tornillo y provocar un accidente.',0);
    showSalva('facepalm','¡Nunca! Cada tornillo tiene su destornillador. Si resbala, te puedes hacer daño.');
  }
  updateHUD();
  waitForNext(nextRound);
}

/* ========== FEEDBACK / SALVA / SPEED ========== */
function showFeedback(ok,text,pts){
  const bar=$('fb-bar');
  bar.className='feedback-bar show '+(ok?'ok':'err');
  $('fb-icon').src=ok?A.ico_check:A.ico_cruz;
  $('fb-text').textContent=text;
  $('fb-next').style.display='inline-block';
  updateHUD();
}
function hideFeedback(){$('fb-bar').className='feedback-bar';$('fb-next').style.display='none'}

function waitForNext(cb){
  let fired=false;
  const go=()=>{if(fired)return;fired=true;$('fb-next').onclick=null;document.removeEventListener('click',onDoc,true);document.removeEventListener('touchend',onDoc,true);cb()};
  const onDoc=e=>{e.stopPropagation();go()};
  $('fb-next').onclick=go;
  // Allow click anywhere after a small delay (so the answer click doesn't immediately fire)
  setTimeout(()=>{if(!fired){document.addEventListener('click',onDoc,true);document.addEventListener('touchend',onDoc,true)}},400);
}

function showSalva(expr,msg){
  const pop=$('salva-pop');
  $('salva-pop-img').src=A['salva_'+expr]||A.salva_base;
  $('salva-pop-msg').textContent=msg;
  pop.classList.add('show');
}
function hideSalva(){$('salva-pop').classList.remove('show')}

function showSpeed(bonus){
  const badge=$('speed-badge');
  if(bonus>=50){badge.textContent='RAYO +50';badge.className='speed-badge show gold'}
  else if(bonus>=30){badge.textContent='RÁPIDO +30';badge.className='speed-badge show orange'}
  else if(bonus>=10){badge.textContent='BIEN +10';badge.className='speed-badge show green'}
  else{badge.className='speed-badge';return}
  setTimeout(()=>{badge.classList.remove('show')},1200);
}
function hideSpeed(){$('speed-badge').className='speed-badge'}

/* ========== NEXT ROUND ========== */
function nextRound(){
  roundIdx++;
  playRound();
}

/* ========== RESULTS ========== */
function showResults(){
  cleanupListeners();
  const isNew=score>record;
  if(isNew){record=score;localStorage.setItem('salva_herramientas_record',record)}
  const passed=score>=700;

  if(passed&&!taskCompleted){
    taskCompleted=true;
    try{window.ReactNativeWebView.postMessage(JSON.stringify({action:'TASK_COMPLETED'}))}catch(e){}
  }

  $('res-badge').classList.toggle('show',passed);
  $('res-sub').textContent=hits+'/'+totalRounds+' aciertos — '+(passed?'¡Manos de pro!':'¡Sigue practicando!');
  $('res-score').textContent=score;
  $('res-record').textContent=record;
  $('res-new').classList.toggle('show',isNew);
  $('res-rec-text').textContent='Tu récord: '+record+' pts';

  const expr=score>=1000?'celebrating':score>=700?'happy':'worried';
  $('res-av').src=A['salva_'+expr];

  showScreen('results');
}

/* ========== START ========== */
init();
</script>
</body>
</html>
