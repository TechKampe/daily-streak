<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Maestro del Mult√≠metro</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--turq:#00E6BC;--navy:#0B214A;--lime:#04FFB4;--mint:#C5FFDF;--lemon:#FFFFAB;--fire:#E74C3C;--dk:#0B214A}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Baloo 2',cursive;background:#0B214A;touch-action:manipulation}
body{padding-top:env(safe-area-inset-top);padding-top:constant(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-bottom:constant(safe-area-inset-bottom)}
#W{position:relative;width:100%;max-width:430px;margin:0 auto;height:100%;overflow:hidden;background:linear-gradient(180deg,#0B214A 0%,#0D2D5E 40%,#0F1B2D 100%)}
.scr{position:absolute;inset:0;display:flex;flex-direction:column;transition:opacity .35s;z-index:100}
.scr.off{opacity:0;pointer-events:none;z-index:-1}
.btn{background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:19px;font-weight:700;padding:14px 48px;border-radius:50px;cursor:pointer;box-shadow:0 4px 16px rgba(0,230,188,.3);transition:transform .1s;letter-spacing:.5px}
.btn:active{transform:scale(.96)}

/* INTRO */
#intro{align-items:center;justify-content:center;padding-bottom:30px;background:linear-gradient(180deg,#0B214A 0%,#0D2D5E 40%,#0F1B2D 100%)}
.intro-card{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;padding:0 20px;width:100%}
.intro-av{width:240px;height:310px;object-fit:contain;filter:drop-shadow(0 4px 24px rgba(0,0,0,.6));margin-bottom:-36px;position:relative;z-index:1}
.intro-bub{position:relative;z-index:2;background:#fff;color:var(--navy);padding:18px 22px;border-radius:22px;box-shadow:0 4px 24px rgba(0,0,0,.35);font-size:15px;font-weight:600;line-height:1.4;text-align:center;margin-bottom:18px;width:100%}
.intro-title{font-size:22px;font-weight:800;color:#fff;text-shadow:0 3px 16px rgba(0,0,0,.5);margin-bottom:6px;z-index:10;position:relative}

/* HUD */
.hud{position:absolute;top:0;left:0;right:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;padding-right:66px;background:linear-gradient(180deg,rgba(11,33,74,.95)0%,rgba(11,33,74,.4)70%,transparent 100%);padding-bottom:28px;pointer-events:none}
.hud>*{pointer-events:auto}
.hud-left{display:flex;align-items:center;gap:8px}
.hud-phase{background:rgba(0,230,188,.2);padding:4px 10px;border-radius:16px;color:var(--turq);font-size:12px;font-weight:700}
.hud-round{background:rgba(0,0,0,.35);padding:4px 12px;border-radius:16px;color:rgba(255,255,255,.8);font-size:14px;font-weight:600}
.hud-lives{display:flex;gap:3px}
.hud-heart{font-size:20px;transition:all .3s ease}
.hud-heart.lost{opacity:.2;transform:scale(.7)}
@keyframes livesShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.hud-lives.shaking{animation:livesShake .3s ease-out}

/* FLASH */
@keyframes flashRed{0%{opacity:.35}100%{opacity:0}}
.flash-overlay{position:fixed;inset:0;background:var(--fire);z-index:999;pointer-events:none;opacity:0}
.flash-overlay.flash{animation:flashRed .4s ease-out forwards}

/* ============ FASE 1 ‚Äî ARROWS ============ */
#fase1{z-index:10}
.f1-inner{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:48px 0 0;overflow:visible}
.f1-diagram{flex:1;position:relative;display:flex;align-items:center;justify-content:center;min-height:0;padding:0 6px;overflow:visible}
.f1-img-wrap{position:relative;max-height:100%;max-width:56%}
.f1-diagram-img{display:block;max-height:100%;max-width:100%;width:auto;height:auto;border-radius:14px;filter:drop-shadow(0 4px 20px rgba(0,0,0,.4));position:relative;z-index:1}

/* Arrow markers ‚Äî anchor dot positioned inside img-wrap via top/left %, lines extend outward */
.arrow-anchor{position:absolute;z-index:10;width:0;height:0}
.arrow-marker{position:absolute;z-index:10;display:flex;align-items:center;gap:0;pointer-events:none;white-space:nowrap}
.arrow-marker.left{flex-direction:row;right:0;top:50%;transform:translateY(-50%)}
.arrow-marker.right{flex-direction:row;left:0;top:50%;transform:translateY(-50%)}
.arrow-dot{width:8px;height:8px;border-radius:50%;background:rgba(0,230,188,.6);flex-shrink:0;transition:all .3s}
.arrow-marker.filled .arrow-dot{background:var(--lime)}
.arrow-line{height:2px;background:rgba(0,230,188,.4);flex-shrink:0}
.arrow-marker.filled .arrow-line{background:var(--lime)}
.arrow-drop{min-width:28px;height:24px;border-radius:6px;border:2px dashed rgba(0,230,188,.45);background:rgba(0,230,188,.06);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:rgba(0,230,188,.5);transition:all .3s;pointer-events:auto;cursor:pointer;flex-shrink:0;white-space:nowrap;padding:0 5px}
.arrow-drop.hover{border-color:var(--turq);background:rgba(0,230,188,.2);box-shadow:0 0 10px rgba(0,230,188,.35);transform:scale(1.08)}
.arrow-drop.filled{border-color:var(--lime);border-style:solid;background:rgba(4,255,180,.15);color:var(--lime);box-shadow:0 0 8px rgba(4,255,180,.3);font-size:8px;font-weight:800}

/* Tooltip explanation */
.f1-tooltip{position:absolute;z-index:60;pointer-events:none;opacity:0;transition:opacity .3s;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
.f1-tooltip.show{opacity:1;pointer-events:auto}
.f1-tooltip-box{background:rgba(197,255,223,.97);color:var(--navy);font-size:12px;font-weight:700;padding:10px 14px;border-radius:12px;line-height:1.35;max-width:200px;position:relative}

/* Label tray */
.f1-tray{padding:8px 12px 12px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px 12px;flex-shrink:0;position:relative;z-index:40}
.tag{background:rgba(255,255,255,.12);color:#fff;font-size:12px;font-weight:700;padding:7px 12px;border-radius:12px;cursor:grab;touch-action:none;transition:transform .15s,opacity .15s,box-shadow .15s,max-width .3s;box-shadow:0 2px 8px rgba(0,0,0,.2);white-space:nowrap}
.tag:active{transform:scale(1.05)}
.tag.dragging{opacity:.6;box-shadow:0 6px 20px rgba(0,0,0,.4);z-index:100;position:fixed;pointer-events:none}
.tag.placed{opacity:0;pointer-events:none;max-width:0;padding:0;margin:0;overflow:hidden}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
.tag.shaking{animation:shake .35s ease-out}

/* Hint toast */
.f1-hint{text-align:center;padding:4px 16px;flex-shrink:0;z-index:20}
.f1-hint-text{display:inline-block;background:rgba(255,255,171,.15);color:var(--lemon);font-size:12px;font-weight:700;padding:6px 16px;border-radius:12px;opacity:0;transition:opacity .3s;line-height:1.3}
.f1-hint-text.show{opacity:1}

/* ============ TRANSITION ============ */
.phase-transition{position:absolute;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(11,33,74,.95);opacity:0;pointer-events:none;transition:opacity .35s;padding:20px}
.phase-transition.show{opacity:1;pointer-events:auto}
.phase-transition img{width:200px;height:260px;object-fit:contain;filter:drop-shadow(0 4px 20px rgba(0,0,0,.5));margin-bottom:10px}
.phase-transition .msg{color:#fff;font-size:18px;font-weight:700;text-align:center;line-height:1.3}
.phase-transition .sub{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:6px}

/* ============ FASE 2 ‚Äî Numeros en flechas ‚Üí arrastrar a explicaciones ============ */
#fase2{z-index:10}
.f2-inner{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:48px 0 0;overflow:visible}
.f2-instruction{color:#fff;font-size:13px;font-weight:700;text-align:center;padding:0 16px 2px}
.f2-diagram{flex:1;position:relative;display:flex;align-items:center;justify-content:center;min-height:0;padding:0 6px;overflow:visible}
.f2-img-wrap{position:relative;max-height:100%;max-width:56%}
.f2-diagram-img{display:block;max-height:100%;max-width:100%;width:auto;height:auto;border-radius:14px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.4));position:relative;z-index:1}
.f2-explain-list{display:flex;flex-direction:column;gap:5px;padding:6px 10px 6px;flex-shrink:0}
.f2-explain-card{display:flex;align-items:flex-start;gap:8px;background:rgba(255,255,255,.08);border-radius:12px;padding:7px 10px;transition:all .3s}
.f2-explain-card.correct{background:rgba(4,255,180,.15);border:1px solid var(--lime)}
.f2-explain-card.wrong-flash{background:rgba(231,76,60,.15)}
.f2-drop-num{width:26px;height:26px;border-radius:50%;border:2px dashed rgba(0,230,188,.45);background:rgba(0,230,188,.06);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:rgba(0,230,188,.5);flex-shrink:0;transition:all .3s}
.f2-drop-num.hover{border-color:var(--turq);background:rgba(0,230,188,.2);box-shadow:0 0 10px rgba(0,230,188,.35);transform:scale(1.1)}
.f2-drop-num.filled{border-color:var(--lime);border-style:solid;background:rgba(4,255,180,.15);color:var(--lime)}
.f2-explain-text{color:rgba(255,255,255,.85);font-size:13px;font-weight:500;line-height:1.3;flex:1}
.f2-num-tray{padding:4px 12px 8px;display:flex;justify-content:center;gap:10px;flex-shrink:0}
.f2-num-chip{width:32px;height:32px;border-radius:50%;background:var(--turq);color:var(--navy);font-size:15px;font-weight:900;display:flex;align-items:center;justify-content:center;cursor:grab;touch-action:none;box-shadow:0 2px 8px rgba(0,230,188,.3);transition:transform .15s,opacity .15s}
.f2-num-chip:active{transform:scale(1.1)}
.f2-num-chip.dragging{position:fixed;z-index:200;pointer-events:none;opacity:.8;box-shadow:0 6px 20px rgba(0,230,188,.5)}
.f2-num-chip.placed{opacity:0;pointer-events:none;width:0;margin:0;overflow:hidden}

/* ============ FASE 3 ‚Äî Cables ============ */
#fase3{z-index:10}
.f3-inner{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:48px 0 0;overflow:visible}
.f3-instruction{color:#fff;font-size:16px;font-weight:700;text-align:center;padding:0 16px 6px}
.f3-cable-zone{padding:10px 20px 4px;display:flex;justify-content:center;flex-shrink:0}
.f3-cable-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;background:rgba(255,255,255,.95);border-radius:18px;padding:14px 36px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.f3-cable-img{width:200px;height:auto;filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
.f3-cable-label{font-size:13px;font-weight:800;letter-spacing:.5px;color:var(--navy)}
.f3-area{flex:1;display:flex;align-items:flex-start;justify-content:center;position:relative;min-height:0;padding:4px 6px 0}
.f3-multi-wrap{position:relative;display:inline-block;max-height:100%;max-width:62%}
.f3-multi-img{display:block;max-height:100%;max-width:100%;width:auto;height:auto;border-radius:14px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.4))}
.f3-jack-zone{position:absolute;width:50px;height:50px;border-radius:50%;z-index:5;transform:translate(-50%,-50%);cursor:pointer}
.f3-jack-zone.correct-flash{background:rgba(4,255,180,.35);border:2px solid var(--lime);animation:f3flash .5s ease-out}
.f3-jack-zone.wrong-flash{background:rgba(231,76,60,.3);border:2px solid var(--fire);animation:f3flash .5s ease-out}
@keyframes f3flash{0%{transform:translate(-50%,-50%) scale(1.3)}100%{transform:translate(-50%,-50%) scale(1)}}

/* ============ RESULTS ============ */
#results{align-items:center;justify-content:center;padding:16px 20px;z-index:200;background:var(--navy)}
.res-inner{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;width:100%;gap:2px}
.res-label{font-size:14px;color:rgba(255,255,255,.5);font-weight:600;text-align:center}
.res-new{color:var(--lemon);font-size:18px;font-weight:800;display:none}
.res-new.show{display:block}
.res-badge{color:var(--lime);font-size:23px;font-weight:800;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase}
.res-scores{display:flex;gap:28px;margin-bottom:4px}
.res-val{font-size:44px;font-weight:800;text-align:center;color:var(--lime)}
.res-av{width:208px;height:273px;object-fit:contain;filter:drop-shadow(0 4px 22px rgba(0,0,0,.5));margin-bottom:-40px;position:relative;z-index:0}
.res-info-card{background:rgba(255,255,255,.9);border-radius:18px;padding:16px 20px;width:100%;max-width:340px;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;z-index:1}
.res-msg{color:var(--navy);font-size:14px;font-weight:600;text-align:center;line-height:1.3}
.res-hits{color:var(--navy);font-size:13px;font-weight:600;opacity:.7}
.res-bot{display:flex;flex-direction:column;align-items:center;margin-top:10px}
.res-bot .btn{position:relative;z-index:2;padding:12px 40px;font-size:17px}
</style>
</head>
<body>
<div id="W">

<!-- INTRO -->
<div class="scr" id="intro">
  <div class="intro-card">
    <h1 class="intro-title">Maestro del Mult√≠metro</h1>
    <img class="intro-av" id="intro-av" alt="Irina">
    <div class="intro-bub">Hoy vas a aprender a usar el mult√≠metro. Primero las partes, luego a medir.<br><br>Recuerda: <b>si la punta baila, la lectura miente.</b></div>
    <button class="btn" id="intro-btn">¬°Vamos!</button>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn" style="padding:8px 16px;font-size:13px;opacity:.6" onclick="score=480;f1Placed=8;lives=MAX_LIVES;renderLives('hud-f2-lives');showScreen('fase2');initFase2()">DEBUG: Fase 2</button>
      <button class="btn" style="padding:8px 16px;font-size:13px;opacity:.6" onclick="score=480;f1Placed=8;f2Placed=4;lives=MAX_LIVES;CABLES[0].img=A.punta_negra;CABLES[1].img=A.punta_roja;f3CableIdx=0;f3CableErrors={};renderLives('hud-f3-lives');showScreen('fase3');initFase3()">DEBUG: Fase 3</button>
    </div>
  </div>
</div>

<!-- FASE 1 -->
<div class="scr off" id="fase1">
  <div class="hud">
    <div class="hud-left">
      <div class="hud-phase">Fase 1</div>
      <div class="hud-round" id="hud-f1-progress">0/8</div>
    </div>
    <div class="hud-lives" id="hud-f1-lives"></div>
  </div>
  <div class="f1-inner">
    <div class="f1-diagram" id="f1-diagram">
      <div class="f1-img-wrap" id="f1-img-wrap">
        <img class="f1-diagram-img" id="f1-diagram-img" alt="Mult√≠metro">
      </div>
    </div>
    <div class="f1-tray" id="f1-tray"></div>
    <div class="f1-hint">
      <div class="f1-hint-text" id="f1-hint"></div>
    </div>
  </div>
</div>

<!-- PHASE TRANSITION -->
<div class="phase-transition" id="phase-trans">
  <img id="phase-trans-av" alt="Irina">
  <div class="msg" id="phase-trans-msg"></div>
  <div class="sub">Toca para continuar</div>
</div>

<!-- FASE 2 ‚Äî Explicaciones -->
<div class="scr off" id="fase2">
  <div class="hud">
    <div class="hud-left">
      <div class="hud-phase">Fase 2</div>
      <div class="hud-round" id="hud-f2-progress">0/4</div>
    </div>
    <div class="hud-lives" id="hud-f2-lives"></div>
  </div>
  <div class="f2-inner">
    <div class="f2-instruction">Arrastra cada n√∫mero a su explicaci√≥n</div>
    <div class="f2-num-tray" id="f2-num-tray"></div>
    <div class="f2-diagram" id="f2-diagram">
      <div class="f2-img-wrap" id="f2-img-wrap">
        <img class="f2-diagram-img" id="f2-diagram-img" alt="Mult√≠metro">
      </div>
    </div>
    <div class="f2-explain-list" id="f2-explain-list"></div>
    <div class="f1-hint">
      <div class="f1-hint-text" id="f2-hint"></div>
    </div>
  </div>
</div>

<!-- PHASE TRANSITION 2‚Üí3 -->
<div class="phase-transition" id="phase-trans2">
  <img id="phase-trans2-av" alt="Irina">
  <div class="msg" id="phase-trans2-msg"></div>
  <div class="sub">Toca para continuar</div>
</div>

<!-- FASE 3 ‚Äî Cables -->
<div class="scr off" id="fase3">
  <div class="hud">
    <div class="hud-left">
      <div class="hud-phase">Fase 3</div>
      <div class="hud-round" id="hud-f3-progress"></div>
    </div>
    <div class="hud-lives" id="hud-f3-lives"></div>
  </div>
  <div class="f3-inner">
    <div class="f3-instruction" id="f3-instruction"></div>
    <div class="f3-cable-zone" id="f3-cable-zone"></div>
    <div class="f3-area" id="f3-area">
      <div class="f3-multi-wrap" id="f3-multi-wrap">
        <img class="f3-multi-img" id="f3-multi-img" alt="Mult√≠metro">
      </div>
    </div>
    <div class="f1-hint">
      <div class="f1-hint-text" id="f3-hint"></div>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div class="scr off" id="results">
  <div class="res-inner">
    <div class="res-badge" id="res-badge" style="display:none"></div>
    <div class="res-scores">
      <div><div class="res-val" id="res-score">0</div><div class="res-label">Puntuaci√≥n</div></div>
      <div><div class="res-val" id="res-record" style="color:var(--lemon)">0</div><div class="res-label">R√©cord</div></div>
    </div>
    <div class="res-new" id="res-new">¬°NUEVO R√âCORD!</div>
    <img class="res-av" id="res-av" alt="Irina">
    <div class="res-info-card">
      <div class="res-msg" id="res-msg"></div>
      <div class="res-hits" id="res-hits"></div>
    </div>
    <div class="res-bot">
      <button class="btn" id="res-btn">¬°Otra ronda!</button>
    </div>
  </div>
</div>

<!-- Flash overlay -->
<div class="flash-overlay" id="flash-overlay"></div>

</div>
<script>
/* ========== ASSETS ========== */
const A={
  irina_happy:'https://res.cloudinary.com/kampe/image/upload/v1772110317/irina_happy_w2nu0c.png',
  irina_celebrating:'https://res.cloudinary.com/kampe/image/upload/v1772110324/irina_celebrating_nifggk.png',
  irina_worried:'https://res.cloudinary.com/kampe/image/upload/v1772110324/irina_worried_bx2nzg.png',
  multimetro:'https://res.cloudinary.com/kampe/image/upload/v1772117458/multimetro_frontal_jtf2pj.png',
  punta_roja:'https://res.cloudinary.com/kampe/image/upload/v1740700800/punta_roja_phbypc.png',
  punta_negra:'https://res.cloudinary.com/kampe/image/upload/v1772110317/punta_negra_nzrcta.png',
  escena_cable:'https://res.cloudinary.com/kampe/image/upload/v1772110316/escena_cable_ersdbw.png',
  escena_pila:'https://res.cloudinary.com/kampe/image/upload/v1772107948/escena_pila_nubvzx.png'
};

/* ========== FASE 1 DATA ========== */
/*
  Arrow markers: dot SOBRE la imagen + l√≠nea + drop zone fuera.
  side: 'left' = la drop zone queda a la izquierda, 'right' = a la derecha.
  anchorX/anchorY: posici√≥n del dot en % de la imagen.
  lineW: largo de la l√≠nea en px.
  Mapeado 1:1 con la maqueta del usuario (10 flechas).
*/
const LABELS=[
  /* === SALEN HACIA LA IZQUIERDA (3 flechas) === */
  {id:'vdc',       text:'VCD',               side:'left',  anchorX:12, anchorY:34, lineW:30, hint:'Tensi√≥n en corriente continua. Piensa en pilas.',           explain:'VCD = Voltaje Corriente Continua. Para medir pilas, bater√≠as, cargadores, paneles solares.'},
  {id:'selector',  text:'Selector de Rango', side:'left',  anchorX:50, anchorY:50, lineW:30, hint:'La rueda grande del centro. Ah√≠ eliges qu√© mides.',       explain:'El selector te permite elegir qu√© mides: tensi√≥n (V), resistencia (Œ©), continuidad, o corriente (A).'},
  {id:'adc',       text:'A‚éì (Corriente CC)', side:'left',  anchorX:12, anchorY:72, lineW:30, hint:'Corriente continua. Para medir amperios.',                explain:'A‚éì = Amperios en Corriente Continua. Para medir el consumo de un circuito. ¬°Siempre en serie!'},
  /* === SALEN HACIA LA DERECHA (5 flechas) === */
  {id:'display',   text:'Display',           side:'right', anchorX:78, anchorY:15, lineW:30, hint:'La pantalla de arriba. Donde lees el n√∫mero.',            explain:'El display muestra la lectura. Aqu√≠ ver√°s los n√∫meros, OL, o el s√≠mbolo de continuidad.'},
  {id:'vac',       text:'VAC',               side:'right', anchorX:83, anchorY:30, lineW:30, hint:'Tensi√≥n en corriente alterna. Piensa en enchufes.',       explain:'VAC = Voltaje Corriente Alterna. Para enchufes, cuadros el√©ctricos, instalaciones.'},
  {id:'ohm_der',   text:'Escala Ohmios',     side:'right', anchorX:89, anchorY:40, lineW:30, hint:'Los valores de la escala de ohmios.',                     explain:'Aqu√≠ ves los rangos de ohmios: 200, 2k, 20k, 200k, 2000k. Elige el rango adecuado al componente.'},
  {id:'vohma',     text:'VŒ©mA (roja)',       side:'right', anchorX:86, anchorY:82, lineW:30, hint:'Aqu√≠ va la punta roja. Mide tensi√≥n, resistencia y mA.', explain:'Aqu√≠ va la punta roja para medir tensi√≥n, resistencia, continuidad o corrientes peque√±as (mA). Cable ROJO siempre aqu√≠.'},
  {id:'com',       text:'COM (negra)',       side:'right', anchorX:85, anchorY:91, lineW:30, hint:'COM = com√∫n. Va siempre la punta negra.',                 explain:'COM = com√∫n. La punta negra SIEMPRE va aqu√≠. Es la referencia de todas las medidas. Cable NEGRO siempre aqu√≠.'}
];

/* ========== CONSTANTS ========== */
const MAX_LIVES=6;
const TASK_THRESHOLD=500;
const TOTAL_LABELS=LABELS.length;

/* ========== STATE ========== */
let score=0,lives=MAX_LIVES;
let f1Placed=0,f1Errors={};
let record=parseInt(localStorage.getItem('maestro_multimetro_record'))||0;
let taskCompleted=false;

const $=id=>document.getElementById(id);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

/* ========== SCREENS ========== */
function showScreen(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.add('off'));
  $(id).classList.remove('off');
}

/* ========== LIVES ========== */
function renderLives(containerId){
  const c=$(containerId);
  c.innerHTML='';
  for(let i=0;i<MAX_LIVES;i++){
    const h=document.createElement('div');
    h.className='hud-heart'+(i>=lives?' lost':'');
    h.textContent='‚ù§Ô∏è';
    c.appendChild(h);
  }
}

function loseLife(){
  if(lives<=0)return;
  lives--;
  renderLives('hud-f1-lives');
  renderLives('hud-f2-lives');
  renderLives('hud-f3-lives');
  const fl=$('flash-overlay');
  fl.classList.remove('flash');
  void fl.offsetWidth;
  fl.classList.add('flash');
}

/* ========== INIT ========== */
function init(){
  $('intro-av').src=A.irina_happy;
  $('intro-btn').onclick=startGame;
  $('res-btn').onclick=startGame;
  showScreen('intro');
}

/* ========== START GAME ========== */
function startGame(){
  score=0;lives=MAX_LIVES;
  f1Placed=0;f1Errors={};
  f2Placed=0;f2Errors={};
  f3CableIdx=0;f3CableErrors={};
  taskCompleted=false;
  renderLives('hud-f1-lives');
  showScreen('fase1');
  initFase1();
}

/* ================================================================
   FASE 1 ‚Äî ARROW MARKERS + DRAG CHIPS
   ================================================================ */

function initFase1(){
  const img=$('f1-diagram-img');
  img.src=A.multimetro;
  $('hud-f1-progress').textContent='0/'+TOTAL_LABELS;
  $('f1-hint').classList.remove('show');
  $('f1-hint').textContent='';

  // Clear old markers
  const wrap=$('f1-img-wrap');
  wrap.querySelectorAll('.arrow-anchor').forEach(el=>el.remove());
  $('f1-diagram').querySelectorAll('.f1-tooltip').forEach(el=>el.remove());

  img.onload=()=>{
    createArrowMarkers();
    createTags();
  };
  if(img.complete&&img.naturalWidth>0){
    createArrowMarkers();
    createTags();
  }
}

function createArrowMarkers(){
  const wrap=$('f1-img-wrap');
  const diagram=$('f1-diagram');
  const img=$('f1-diagram-img');
  wrap.querySelectorAll('.arrow-anchor').forEach(el=>el.remove());

  // Sync wrap size to rendered image so % anchors align perfectly
  wrap.style.width=img.offsetWidth+'px';
  wrap.style.height=img.offsetHeight+'px';

  LABELS.forEach((lab)=>{
    // Anchor: positioned at anchorX%/anchorY% inside img-wrap (over the image)
    const anchor=document.createElement('div');
    anchor.className='arrow-anchor';
    anchor.style.top=lab.anchorY+'%';
    anchor.style.left=lab.anchorX+'%';

    // Marker: flex row with dot+line+drop, extends outward from anchor
    const marker=document.createElement('div');
    marker.className='arrow-marker '+lab.side;
    marker.dataset.id=lab.id;
    marker.dataset.explain=lab.explain;

    const dot=document.createElement('div');
    dot.className='arrow-dot';

    const line=document.createElement('div');
    line.className='arrow-line';
    line.style.width=lab.lineW+'px';

    const drop=document.createElement('div');
    drop.className='arrow-drop';
    drop.textContent='?';

    if(lab.side==='left'){
      // Marker extends LEFT from anchor: [drop][line][dot] ‚Üí dot at right edge
      marker.appendChild(drop);
      marker.appendChild(line);
      marker.appendChild(dot);
    }else{
      // Marker extends RIGHT from anchor: [dot][line][drop] ‚Üí dot at left edge
      marker.appendChild(dot);
      marker.appendChild(line);
      marker.appendChild(drop);
    }

    // Tap on filled marker to re-read explanation
    drop.addEventListener('click',(e)=>{
      if(marker.classList.contains('filled')){
        e.stopPropagation();
        showTooltip(drop,marker.dataset.explain,diagram);
      }
    });

    anchor.appendChild(marker);
    wrap.appendChild(anchor);
  });
}

function createTags(){
  const tray=$('f1-tray');
  tray.innerHTML='';
  const shuffled=shuffle([...LABELS]);
  shuffled.forEach(lab=>{
    const tag=document.createElement('div');
    tag.className='tag';
    tag.textContent=lab.text;
    tag.dataset.id=lab.id;
    setupTagDrag(tag,lab);
    tray.appendChild(tag);
  });
}

let f1TooltipTimer=null;
let f1ActiveTooltip=null;

function clearHovers(){
  document.querySelectorAll('.arrow-drop').forEach(n=>n.classList.remove('hover'));
}

function checkHover(x,y){
  document.querySelectorAll('.arrow-marker').forEach(m=>{
    if(m.classList.contains('filled'))return;
    const dropEl=m.querySelector('.arrow-drop');
    const r=dropEl.getBoundingClientRect();
    const pad=10;
    if(x>=r.left-pad&&x<=r.right+pad&&y>=r.top-pad&&y<=r.bottom+pad){
      dropEl.classList.add('hover');
    }else{
      dropEl.classList.remove('hover');
    }
  });
}

function showTooltip(targetEl,text,container){
  hideTooltip();
  const containerRect=container.getBoundingClientRect();
  const elRect=targetEl.getBoundingClientRect();

  const tooltip=document.createElement('div');
  tooltip.className='f1-tooltip';
  const box=document.createElement('div');
  box.className='f1-tooltip-box';
  box.textContent=text;

  const elCenterX=elRect.left+elRect.width/2-containerRect.left;
  const elTop=elRect.top-containerRect.top;
  const elBottom=elRect.bottom-containerRect.top;

  // Show tooltip above or below (no arrow)
  tooltip.appendChild(box);
  container.appendChild(tooltip);
  const ttW=tooltip.offsetWidth;
  let left=elCenterX-ttW/2;
  left=Math.max(4,Math.min(left,containerRect.width-ttW-4));
  tooltip.style.left=left+'px';
  if(elBottom>containerRect.height*0.6){
    tooltip.style.bottom=(containerRect.height-elTop+8)+'px';
  }else{
    tooltip.style.top=(elBottom-containerRect.top+8)+'px';
  }

  requestAnimationFrame(()=>tooltip.classList.add('show'));
  f1ActiveTooltip=tooltip;
  f1TooltipTimer=setTimeout(()=>hideTooltip(),4000);
}

function hideTooltip(){
  if(f1TooltipTimer){clearTimeout(f1TooltipTimer);f1TooltipTimer=null}
  if(f1ActiveTooltip){
    f1ActiveTooltip.classList.remove('show');
    const tt=f1ActiveTooltip;
    setTimeout(()=>{if(tt.parentNode)tt.remove()},300);
    f1ActiveTooltip=null;
  }
}

function setupTagDrag(tag,lab){
  let ox,oy,clone,isDragging=false;

  const onStart=(e)=>{
    if(tag.classList.contains('placed'))return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    const r=tag.getBoundingClientRect();
    ox=t.clientX-r.left;oy=t.clientY-r.top;

    clone=tag.cloneNode(true);
    clone.className='tag dragging';
    clone.style.width=r.width+'px';
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    document.body.appendChild(clone);
    tag.style.opacity='.3';
    isDragging=true;

    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('touchend',onEnd);
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onEnd);
  };

  const onMove=(e)=>{
    if(!isDragging)return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    checkHover(t.clientX,t.clientY);
  };

  const onEnd=(e)=>{
    if(!isDragging)return;
    isDragging=false;
    document.removeEventListener('touchmove',onMove);
    document.removeEventListener('touchend',onEnd);
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onEnd);
    clearHovers();

    const t=e.changedTouches?e.changedTouches[0]:e;
    const dropX=t.clientX,dropY=t.clientY;

    if(clone.parentNode)clone.remove();
    tag.style.opacity='';

    // Check if dropped on any arrow marker's drop zone
    const markers=document.querySelectorAll('.arrow-marker');
    markers.forEach(marker=>{
      if(marker.classList.contains('filled'))return;
      const dropEl=marker.querySelector('.arrow-drop');
      const r=dropEl.getBoundingClientRect();
      const pad=10;
      if(dropX>=r.left-pad&&dropX<=r.right+pad&&dropY>=r.top-pad&&dropY<=r.bottom+pad){
        if(marker.dataset.id===lab.id){
          // CORRECT
          marker.classList.add('filled');
          dropEl.textContent=lab.text;
          tag.classList.add('placed');
          f1Placed++;
          if(!f1Errors[lab.id]){score+=60}else{score+=50}
          $('hud-f1-progress').textContent=f1Placed+'/'+TOTAL_LABELS;
          $('f1-hint').classList.remove('show');
          showTooltip(dropEl,lab.explain,$('f1-diagram'));

          if(f1Placed>=TOTAL_LABELS){
            setTimeout(()=>showPhaseTransition(),2500);
          }
        }else{
          // WRONG marker
          f1Errors[lab.id]=true;
          loseLife();
          tag.classList.add('shaking');
          setTimeout(()=>tag.classList.remove('shaking'),350);
          $('f1-hint').textContent=lab.hint;
          $('f1-hint').classList.add('show');
          setTimeout(()=>$('f1-hint').classList.remove('show'),3000);

          if(lives<=0){setTimeout(()=>showResults(),600)}
        }
      }
    });
  };

  tag.addEventListener('touchstart',onStart,{passive:false});
  tag.addEventListener('mousedown',onStart);
}

/* ========== PHASE TRANSITION ========== */
function showPhaseTransition(){
  hideTooltip();
  const pt=$('phase-trans');
  $('phase-trans-av').src=A.irina_celebrating;
  $('phase-trans-msg').textContent='¬°Ya conoces la herramienta!\nAhora demuestra que sabes para qu√© sirve cada parte.';
  pt.classList.add('show');

  const handler=()=>{
    pt.removeEventListener('click',handler);
    pt.classList.remove('show');
    startFase2();
  };
  setTimeout(()=>pt.addEventListener('click',handler),400);
  setTimeout(()=>{
    if(pt.classList.contains('show')){
      pt.removeEventListener('click',handler);
      pt.classList.remove('show');
      startFase2();
    }
  },3000);
}

/* ================================================================
   FASE 2 ‚Äî NUMBERS ON IMAGE ‚Üí DRAG TO MATCHING EXPLANATION
   ================================================================ */

const F2_COUNT=4;
let f2Placed=0, f2Errors={};
let f2PickedMap={}; // num ‚Üí lab mapping

function startFase2(){
  renderLives('hud-f2-lives');
  showScreen('fase2');
  initFase2();
}

function initFase2(){
  f2Placed=0;f2Errors={};f2PickedMap={};
  const img=$('f2-diagram-img');
  img.src=A.multimetro;
  $('hud-f2-progress').textContent='0/'+F2_COUNT;
  $('f2-hint').classList.remove('show');
  $('f2-hint').textContent='';

  const picked=shuffle([...LABELS]).slice(0,F2_COUNT);
  picked.forEach((lab,i)=>{lab._num=i+1;f2PickedMap[i+1]=lab});

  const wrap=$('f2-img-wrap');
  wrap.querySelectorAll('.arrow-anchor').forEach(el=>el.remove());

  const buildF2=()=>{
    // Sync wrap to image (same system as Fase 1)
    wrap.style.width=img.offsetWidth+'px';
    wrap.style.height=img.offsetHeight+'px';

    // Create arrow markers with numbers instead of "?"
    picked.forEach(lab=>{
      const anchor=document.createElement('div');
      anchor.className='arrow-anchor';
      anchor.style.top=lab.anchorY+'%';
      anchor.style.left=lab.anchorX+'%';

      const marker=document.createElement('div');
      marker.className='arrow-marker '+lab.side+' filled';
      marker.dataset.id=lab.id;

      const dot=document.createElement('div');
      dot.className='arrow-dot';
      const line=document.createElement('div');
      line.className='arrow-line';
      line.style.width=lab.lineW+'px';
      const drop=document.createElement('div');
      drop.className='arrow-drop filled';
      drop.textContent=lab._num;

      if(lab.side==='left'){
        marker.appendChild(drop);marker.appendChild(line);marker.appendChild(dot);
      }else{
        marker.appendChild(dot);marker.appendChild(line);marker.appendChild(drop);
      }
      anchor.appendChild(marker);
      wrap.appendChild(anchor);
    });

    // Build explanation cards in shuffled order
    const list=$('f2-explain-list');
    list.innerHTML='';
    const shuffledPicked=shuffle([...picked]);
    shuffledPicked.forEach(lab=>{
      const card=document.createElement('div');
      card.className='f2-explain-card';
      card.dataset.id=lab.id;
      card.dataset.num=lab._num;
      const dropNum=document.createElement('div');
      dropNum.className='f2-drop-num';
      dropNum.textContent='?';
      const txt=document.createElement('div');
      txt.className='f2-explain-text';
      txt.textContent=lab.explain;
      card.appendChild(dropNum);
      card.appendChild(txt);
      list.appendChild(card);
    });

    // Build number chips tray
    const tray=$('f2-num-tray');
    tray.innerHTML='';
    const nums=shuffle([...picked].map(l=>l._num));
    nums.forEach(num=>{
      const chip=document.createElement('div');
      chip.className='f2-num-chip';
      chip.textContent=num;
      chip.dataset.num=num;
      setupF2NumDrag(chip,num);
      tray.appendChild(chip);
    });
  };

  img.onload=()=>buildF2();
  if(img.complete&&img.naturalWidth>0)buildF2();
}

function setupF2NumDrag(chip,num){
  let ox,oy,clone,isDragging=false;
  const lab=f2PickedMap[num];

  const onStart=(e)=>{
    if(chip.classList.contains('placed'))return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    const r=chip.getBoundingClientRect();
    ox=t.clientX-r.left;oy=t.clientY-r.top;
    clone=chip.cloneNode(true);
    clone.className='f2-num-chip dragging';
    clone.style.width=r.width+'px';
    clone.style.height=r.height+'px';
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    document.body.appendChild(clone);
    chip.style.opacity='.3';
    isDragging=true;
    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('touchend',onEnd);
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onEnd);
  };
  const onMove=(e)=>{
    if(!isDragging)return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    // Hover on drop zones
    document.querySelectorAll('.f2-drop-num').forEach(d=>{
      if(d.classList.contains('filled'))return;
      const r=d.getBoundingClientRect();const pad=12;
      if(t.clientX>=r.left-pad&&t.clientX<=r.right+pad&&t.clientY>=r.top-pad&&t.clientY<=r.bottom+pad){
        d.classList.add('hover');
      }else{
        d.classList.remove('hover');
      }
    });
  };
  const onEnd=(e)=>{
    if(!isDragging)return;
    isDragging=false;
    document.removeEventListener('touchmove',onMove);
    document.removeEventListener('touchend',onEnd);
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onEnd);
    document.querySelectorAll('.f2-drop-num').forEach(d=>d.classList.remove('hover'));
    const t=e.changedTouches?e.changedTouches[0]:e;
    if(clone.parentNode)clone.remove();
    chip.style.opacity='';

    const cards=document.querySelectorAll('.f2-explain-card');
    cards.forEach(card=>{
      const dropEl=card.querySelector('.f2-drop-num');
      if(dropEl.classList.contains('filled'))return;
      const r=dropEl.getBoundingClientRect();const pad=12;
      // Also check against the whole card for easier drop
      const cr=card.getBoundingClientRect();
      const hitDrop=t.clientX>=r.left-pad&&t.clientX<=r.right+pad&&t.clientY>=r.top-pad&&t.clientY<=r.bottom+pad;
      const hitCard=t.clientX>=cr.left&&t.clientX<=cr.right&&t.clientY>=cr.top&&t.clientY<=cr.bottom;
      if(hitDrop||hitCard){
        if(card.dataset.num==num){
          // Correct: this explanation matches this number
          dropEl.classList.add('filled');
          dropEl.textContent=num;
          card.classList.add('correct');
          chip.classList.add('placed');
          f2Placed++;
          if(!f2Errors[num])score+=50; else score+=40;
          $('hud-f2-progress').textContent=f2Placed+'/'+F2_COUNT;
          $('f2-hint').classList.remove('show');
          if(f2Placed>=F2_COUNT){
            setTimeout(()=>showPhaseTransition2(),1500);
          }
        }else{
          // Wrong
          f2Errors[num]=true;
          loseLife();
          card.classList.add('wrong-flash');
          setTimeout(()=>card.classList.remove('wrong-flash'),600);
          $('f2-hint').textContent=lab.hint;
          $('f2-hint').classList.add('show');
          setTimeout(()=>$('f2-hint').classList.remove('show'),3000);
          if(lives<=0)setTimeout(()=>showResults(),600);
        }
      }
    });
  };
  chip.addEventListener('touchstart',onStart,{passive:false});
  chip.addEventListener('mousedown',onStart);
}

/* ========== PHASE TRANSITION 2‚Üí3 ========== */
function showPhaseTransition2(){
  hideTooltip();
  const pt=$('phase-trans2');
  $('phase-trans2-av').src=A.irina_celebrating;
  $('phase-trans2-msg').textContent='¬°Sabes para qu√© sirve cada parte!\nAhora conecta los cables.';
  pt.classList.add('show');
  const handler=()=>{
    pt.removeEventListener('click',handler);
    pt.classList.remove('show');
    startFase3();
  };
  setTimeout(()=>pt.addEventListener('click',handler),400);
  setTimeout(()=>{
    if(pt.classList.contains('show')){
      pt.removeEventListener('click',handler);
      pt.classList.remove('show');
      startFase3();
    }
  },3000);
}

/* ================================================================
   FASE 3 ‚Äî CONNECT CABLES
   ================================================================ */

const CABLES=[
  {id:'black',img:null,correct:'com', label:'Cable NEGRO',color:'#bbb',
   hint:'El cable negro SIEMPRE va en COM.',
   explain:'COM = com√∫n. Referencia de todas las medidas.'},
  {id:'red',  img:null,correct:'vohma',label:'Cable ROJO', color:'#e74c3c',
   hint:'El cable rojo va en VŒ©mA para tensi√≥n, resistencia y mA.',
   explain:'VŒ©mA: tensi√≥n, resistencia, continuidad y corrientes peque√±as.'}
];

const JACKS=[
  {id:'com',  label:'COM',  x:85, y:91},
  {id:'vohma',label:'VŒ©mA', x:86, y:82},
  {id:'10a',  label:'10A',  x:50, y:79}
];

let f3CableIdx=0;
let f3CableErrors={};

function startFase3(){
  // Set asset refs (can't do at const time)
  CABLES[0].img=A.punta_negra;
  CABLES[1].img=A.punta_roja;

  f3CableIdx=0;
  renderLives('hud-f3-lives');
  showScreen('fase3');
  initFase3();
}

function initFase3(){
  const img=$('f3-multi-img');
  img.src=A.multimetro;
  $('hud-f3-progress').textContent='0/'+CABLES.length;

  const wrap=$('f3-multi-wrap');
  wrap.querySelectorAll('.f3-jack-zone').forEach(el=>el.remove());

  const build=()=>{
    // Create invisible tap zones on casquillos
    JACKS.forEach(j=>{
      const el=document.createElement('div');
      el.className='f3-jack-zone';
      el.dataset.jack=j.id;
      el.style.top=j.y+'%';
      el.style.left=j.x+'%';
      wrap.appendChild(el);
    });
    showCable();
  };

  img.onload=()=>build();
  if(img.complete&&img.naturalWidth>0)build();
}

function showCable(){
  if(f3CableIdx>=CABLES.length){
    setTimeout(()=>showResults(),600);
    return;
  }
  if(lives<=0){showResults();return}

  const cable=CABLES[f3CableIdx];
  $('f3-instruction').textContent='¬øD√≥nde va el '+cable.label+'? Toca el casquillo correcto.';
  $('f3-hint').classList.remove('show');

  // Show cable card
  const zone=$('f3-cable-zone');
  zone.innerHTML='';
  const cWrap=document.createElement('div');
  cWrap.className='f3-cable-wrap';
  const cImg=document.createElement('img');
  cImg.className='f3-cable-img';
  cImg.src=cable.img;
  const lbl=document.createElement('div');
  lbl.className='f3-cable-label';
  lbl.textContent=cable.label;
  cWrap.appendChild(cImg);
  cWrap.appendChild(lbl);
  zone.appendChild(cWrap);

  // Tap zones on mult√≠metro ‚Äî user taps directly
  const zones=document.querySelectorAll('#fase3 .f3-jack-zone');
  let f3Handled=false;
  const handler=(e)=>{
    e.preventDefault();
    e.stopPropagation();
    if(f3Handled)return;
    const jackEl=e.currentTarget;
    if(jackEl.dataset.jack===cable.correct){
      // Correct
      f3Handled=true;
      jackEl.classList.add('correct-flash');
      score+=(!f3CableErrors[cable.id]?75:50);
      f3CableIdx++;
      $('hud-f3-progress').textContent=f3CableIdx+'/'+CABLES.length;
      // Remove all tap handlers
      zones.forEach(z=>z.replaceWith(z.cloneNode(true)));
      setTimeout(()=>{
        // Re-create zones for next cable
        const wrap=$('f3-multi-wrap');
        wrap.querySelectorAll('.f3-jack-zone').forEach(el=>el.remove());
        JACKS.forEach(j=>{
          const el=document.createElement('div');
          el.className='f3-jack-zone';
          el.dataset.jack=j.id;
          el.style.top=j.y+'%';
          el.style.left=j.x+'%';
          wrap.appendChild(el);
        });
        showCable();
      },500);
    }else{
      // Wrong
      f3CableErrors[cable.id]=true;
      loseLife();
      jackEl.classList.add('wrong-flash');
      setTimeout(()=>jackEl.classList.remove('wrong-flash'),600);
      $('f3-hint').textContent=cable.hint;
      $('f3-hint').classList.add('show');
      setTimeout(()=>$('f3-hint').classList.remove('show'),3000);
      if(lives<=0)setTimeout(()=>showResults(),600);
    }
  };
  zones.forEach(z=>{
    z.addEventListener('click',handler);
    z.addEventListener('touchend',(e)=>{e.preventDefault();handler(e)},{passive:false});
  });
}

/* ================================================================
   RESULTS
   ================================================================ */
function showResults(){
  showScreen('results');
  $('res-score').textContent=score;
  const isNew=score>record;
  if(isNew){record=score;localStorage.setItem('maestro_multimetro_record',record)}
  $('res-record').textContent=record;
  $('res-new').classList.toggle('show',isNew);

  $('res-hits').innerHTML='üè∑Ô∏è '+f1Placed+'/'+TOTAL_LABELS+' etiquetas ¬∑ üìñ '+f2Placed+'/'+F2_COUNT+' explicaciones<br>üîå '+f3CableIdx+'/'+CABLES.length+' cables';

  const badge=$('res-badge');
  if(score>=750){
    badge.textContent='¬°MAESTRO DEL MULT√çMETRO!';
    badge.style.display='block';
    $('res-av').src=A.irina_celebrating;
    $('res-msg').textContent='Dominas el mult√≠metro. Ahora a medir en real con supervisi√≥n.';
  }else if(score>=500){
    badge.textContent='¬°APROBADO!';
    badge.style.display='block';
    $('res-av').src=A.irina_happy;
    $('res-msg').textContent='Bien, pero repasa los pasos que fallaste.';
  }else{
    badge.style.display='none';
    $('res-av').src=A.irina_worried;
    $('res-msg').textContent='Necesitas practicar m√°s. Recuerda: modo, puntas, contacto, puntos.';
  }

  if(score>=TASK_THRESHOLD&&!taskCompleted){
    taskCompleted=true;
    try{window.ReactNativeWebView.postMessage(JSON.stringify({action:'TASK_COMPLETED'}))}catch(e){}
  }
}

/* ========== BOOT ========== */
init();
</script>
</body>
</html>
