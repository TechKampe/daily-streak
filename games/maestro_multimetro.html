<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Maestro del Mult√≠metro</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--turq:#00E6BC;--navy:#0B214A;--lime:#04FFB4;--mint:#C5FFDF;--lemon:#FFFFAB;--fire:#E74C3C;--dk:#0B214A}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Baloo 2',cursive;background:#0B214A;touch-action:manipulation}
body{padding-top:env(safe-area-inset-top);padding-top:constant(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-bottom:constant(safe-area-inset-bottom)}
#W{position:relative;width:100%;max-width:430px;margin:0 auto;height:100%;overflow:hidden;background:linear-gradient(180deg,#0B214A 0%,#0D2D5E 40%,#0F1B2D 100%)}
.scr{position:absolute;inset:0;display:flex;flex-direction:column;transition:opacity .35s;z-index:100}
.scr.off{opacity:0;pointer-events:none;z-index:-1}
.btn{background:var(--turq);color:var(--navy);border:none;font-family:'Baloo 2',cursive;font-size:19px;font-weight:700;padding:14px 48px;border-radius:50px;cursor:pointer;box-shadow:0 4px 16px rgba(0,230,188,.3);transition:transform .1s;letter-spacing:.5px}
.btn:active{transform:scale(.96)}

/* INTRO */
#intro{align-items:center;justify-content:flex-end;padding-bottom:40px;background:linear-gradient(180deg,#0B214A 0%,#0D2D5E 40%,#0F1B2D 100%)}
.intro-card{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;padding:0 20px;width:100%}
.intro-av{width:240px;height:310px;object-fit:contain;filter:drop-shadow(0 4px 24px rgba(0,0,0,.6));margin-bottom:-36px;position:relative;z-index:1}
.intro-bub{position:relative;z-index:2;background:#fff;color:var(--navy);padding:18px 22px;border-radius:22px;box-shadow:0 4px 24px rgba(0,0,0,.35);font-size:15px;font-weight:600;line-height:1.4;text-align:center;margin-bottom:18px;width:100%}
.intro-title{font-size:22px;font-weight:800;color:#fff;text-shadow:0 3px 16px rgba(0,0,0,.5);margin-bottom:6px;z-index:10;position:relative}

/* HUD */
.hud{position:absolute;top:0;left:0;right:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;padding-right:66px;background:linear-gradient(180deg,rgba(11,33,74,.95)0%,rgba(11,33,74,.4)70%,transparent 100%);padding-bottom:28px;pointer-events:none}
.hud>*{pointer-events:auto}
.hud-left{display:flex;align-items:center;gap:8px}
.hud-phase{background:rgba(0,230,188,.2);padding:4px 10px;border-radius:16px;color:var(--turq);font-size:12px;font-weight:700}
.hud-round{background:rgba(0,0,0,.35);padding:4px 12px;border-radius:16px;color:rgba(255,255,255,.8);font-size:14px;font-weight:600}
.hud-lives{display:flex;gap:3px}
.hud-heart{font-size:20px;transition:all .3s ease}
.hud-heart.lost{opacity:.2;transform:scale(.7)}
@keyframes livesShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.hud-lives.shaking{animation:livesShake .3s ease-out}

/* FLASH */
@keyframes flashRed{0%{opacity:.35}100%{opacity:0}}
.flash-overlay{position:fixed;inset:0;background:var(--fire);z-index:999;pointer-events:none;opacity:0}
.flash-overlay.flash{animation:flashRed .4s ease-out forwards}

/* ============ FASE 1 ‚Äî ARROWS ============ */
#fase1{z-index:10}
.f1-inner{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:48px 0 0;overflow:visible}
.f1-diagram{flex:1;position:relative;display:flex;align-items:center;justify-content:center;min-height:0;padding:0 6px;overflow:visible}
.f1-img-wrap{position:relative;max-height:100%;max-width:56%}
.f1-diagram-img{display:block;max-height:100%;max-width:100%;width:auto;height:auto;border-radius:14px;filter:drop-shadow(0 4px 20px rgba(0,0,0,.4));position:relative;z-index:1}

/* Arrow markers ‚Äî anchor dot positioned inside img-wrap via top/left %, lines extend outward */
.arrow-anchor{position:absolute;z-index:10;width:0;height:0}
.arrow-marker{position:absolute;z-index:10;display:flex;align-items:center;gap:0;pointer-events:none;white-space:nowrap}
.arrow-marker.left{flex-direction:row;right:0;top:50%;transform:translateY(-50%)}
.arrow-marker.right{flex-direction:row;left:0;top:50%;transform:translateY(-50%)}
.arrow-dot{width:8px;height:8px;border-radius:50%;background:rgba(0,230,188,.6);flex-shrink:0;transition:all .3s}
.arrow-marker.filled .arrow-dot{background:var(--lime)}
.arrow-line{height:2px;background:rgba(0,230,188,.4);flex-shrink:0}
.arrow-marker.filled .arrow-line{background:var(--lime)}
.arrow-drop{min-width:28px;height:24px;border-radius:6px;border:2px dashed rgba(0,230,188,.45);background:rgba(0,230,188,.06);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:rgba(0,230,188,.5);transition:all .3s;pointer-events:auto;cursor:pointer;flex-shrink:0;white-space:nowrap;padding:0 5px}
.arrow-drop.hover{border-color:var(--turq);background:rgba(0,230,188,.2);box-shadow:0 0 10px rgba(0,230,188,.35);transform:scale(1.08)}
.arrow-drop.filled{border-color:var(--lime);border-style:solid;background:rgba(4,255,180,.15);color:var(--lime);box-shadow:0 0 8px rgba(4,255,180,.3);font-size:8px;font-weight:800}

/* Tooltip explanation */
.f1-tooltip{position:absolute;z-index:60;pointer-events:none;opacity:0;transition:opacity .3s;filter:drop-shadow(0 4px 12px rgba(0,0,0,.3))}
.f1-tooltip.show{opacity:1;pointer-events:auto}
.f1-tooltip-box{background:rgba(197,255,223,.97);color:var(--navy);font-size:12px;font-weight:700;padding:10px 14px;border-radius:12px;line-height:1.35;max-width:200px;position:relative}

/* Label tray */
.f1-tray{padding:8px 12px 12px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px 12px;flex-shrink:0;position:relative;z-index:40}
.tag{background:rgba(255,255,255,.12);color:#fff;font-size:12px;font-weight:700;padding:7px 12px;border-radius:12px;cursor:grab;touch-action:none;transition:transform .15s,opacity .15s,box-shadow .15s,max-width .3s;box-shadow:0 2px 8px rgba(0,0,0,.2);white-space:nowrap}
.tag:active{transform:scale(1.05)}
.tag.dragging{opacity:.6;box-shadow:0 6px 20px rgba(0,0,0,.4);z-index:100;position:fixed;pointer-events:none}
.tag.placed{opacity:0;pointer-events:none;max-width:0;padding:0;margin:0;overflow:hidden}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
.tag.shaking{animation:shake .35s ease-out}

/* Hint toast */
.f1-hint{text-align:center;padding:4px 16px;flex-shrink:0;z-index:20}
.f1-hint-text{display:inline-block;background:rgba(255,255,171,.15);color:var(--lemon);font-size:12px;font-weight:700;padding:6px 16px;border-radius:12px;opacity:0;transition:opacity .3s;line-height:1.3}
.f1-hint-text.show{opacity:1}

/* ============ TRANSITION ============ */
.phase-transition{position:absolute;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(11,33,74,.95);opacity:0;pointer-events:none;transition:opacity .35s;padding:20px}
.phase-transition.show{opacity:1;pointer-events:auto}
.phase-transition img{width:200px;height:260px;object-fit:contain;filter:drop-shadow(0 4px 20px rgba(0,0,0,.5));margin-bottom:10px}
.phase-transition .msg{color:#fff;font-size:18px;font-weight:700;text-align:center;line-height:1.3}
.phase-transition .sub{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;margin-top:6px}

/* ============ FASE 2 ============ */
#fase2{z-index:10}
.f2-inner{position:relative;z-index:10;flex:1;display:flex;flex-direction:column;padding:48px 0 0;overflow:hidden}
.f2-context{padding:0 16px 4px;flex-shrink:0}
.f2-context-text{color:rgba(255,255,255,.85);font-size:13px;font-weight:600;line-height:1.35;text-align:center;font-style:italic;background:rgba(0,0,0,.25);padding:8px 14px;border-radius:14px}
.f2-scene{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:120px;padding:0 10px}
.f2-scene-img{max-width:100%;max-height:100%;object-fit:contain;border-radius:14px;filter:drop-shadow(0 4px 20px rgba(0,0,0,.4))}

/* Display (simulated LCD) */
.f2-display{background:#1a1a2e;border:2px solid #333;border-radius:10px;padding:8px 16px;margin:0 auto 6px;text-align:center;min-width:160px}
.f2-display-val{font-family:'Courier New',monospace;font-size:28px;font-weight:700;color:#33ff33;letter-spacing:2px}

/* Step instruction */
.f2-step{padding:0 16px;flex-shrink:0}
.f2-step-label{color:var(--turq);font-size:14px;font-weight:700;text-align:center;margin-bottom:6px}
.f2-options{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;padding:0 10px 12px}
.f2-opt{background:rgba(255,255,255,.1);color:#fff;font-size:14px;font-weight:700;padding:10px 18px;border-radius:14px;border:2px solid transparent;cursor:pointer;transition:all .15s;touch-action:manipulation}
.f2-opt:active{transform:scale(.96)}
.f2-opt.correct{background:rgba(4,255,180,.2);border-color:var(--lime);color:var(--lime)}
.f2-opt.wrong{background:rgba(231,76,60,.2);border-color:var(--fire);color:var(--fire)}

/* (Step 2: drag probes to jacks | Step 3: drag scene to measure zone) */

/* Touch points on scene */
.f2-touch-point{position:absolute;width:48px;height:48px;border-radius:50%;border:3px solid rgba(0,230,188,.5);background:rgba(0,230,188,.1);cursor:pointer;touch-action:manipulation;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:var(--turq)}
.f2-touch-point:active{transform:scale(.9)}
.f2-touch-point.selected{border-color:var(--lime);background:rgba(4,255,180,.3);color:var(--lime)}
.f2-touch-point.wrong-flash{border-color:var(--fire);background:rgba(231,76,60,.3)}

/* Checklist overlay */
.checklist-overlay{position:absolute;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:rgba(11,33,74,.92);opacity:0;pointer-events:none;transition:opacity .3s;padding:20px}
.checklist-overlay.show{opacity:1;pointer-events:auto}
.checklist-card{background:#fff;border-radius:20px;padding:20px;max-width:340px;width:100%;box-shadow:0 6px 24px rgba(0,0,0,.3)}
.checklist-title{color:var(--navy);font-size:16px;font-weight:800;text-align:center;margin-bottom:12px}
.checklist-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;margin-bottom:4px;font-size:13px;font-weight:600;color:var(--navy);line-height:1.3}
.checklist-item.highlight{background:rgba(231,76,60,.12);color:var(--fire);font-weight:800}
.checklist-item .num{width:22px;height:22px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}
.checklist-item.highlight .num{background:var(--fire)}
.checklist-quote{color:#8B6914;font-size:13px;font-weight:700;font-style:italic;text-align:center;padding:8px;background:rgba(255,255,171,.3);border-radius:10px;margin-top:8px;line-height:1.3}
.checklist-tap{color:rgba(11,33,74,.35);font-size:11px;font-weight:600;text-align:center;margin-top:8px}

/* Feedback card (Fase 2 success) */
.f2-feedback{position:absolute;inset:0;z-index:60;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(11,33,74,.92);opacity:0;pointer-events:none;transition:opacity .3s;padding:20px}
.f2-feedback.show{opacity:1;pointer-events:auto}
.f2-fb-card{background:var(--mint);border-radius:20px;padding:20px;max-width:340px;width:100%;box-shadow:0 6px 24px rgba(0,0,0,.25);text-align:center}
.f2-fb-display{background:#1a1a2e;border-radius:10px;padding:10px;margin-bottom:12px;display:inline-block}
.f2-fb-display span{font-family:'Courier New',monospace;font-size:32px;font-weight:700;color:#33ff33}
.f2-fb-text{color:var(--navy);font-size:15px;font-weight:700;line-height:1.4}
.f2-fb-tap{color:rgba(11,33,74,.35);font-size:11px;font-weight:600;margin-top:8px}

/* ============ RESULTS ============ */
#results{align-items:center;justify-content:center;padding:16px 20px;z-index:200;background:var(--navy)}
.res-inner{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;width:100%;gap:2px}
.res-label{font-size:11px;color:rgba(255,255,255,.5);font-weight:600;text-align:center}
.res-new{color:var(--lemon);font-size:14px;font-weight:800;display:none}
.res-new.show{display:block}
.res-badge{color:var(--lime);font-size:18px;font-weight:800;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase}
.res-scores{display:flex;gap:28px;margin-bottom:4px}
.res-val{font-size:34px;font-weight:800;text-align:center;color:var(--lime)}
.res-av{width:200px;height:262px;object-fit:contain;filter:drop-shadow(0 4px 22px rgba(0,0,0,.5));margin-bottom:-40px;position:relative;z-index:1}
.res-info-card{background:rgba(255,255,255,.1);border-radius:18px;padding:16px 20px;width:100%;max-width:340px;display:flex;flex-direction:column;align-items:center;gap:6px;position:relative;z-index:0}
.res-msg{color:#fff;font-size:14px;font-weight:600;text-align:center;line-height:1.3}
.res-hits{color:rgba(255,255,255,.6);font-size:13px;font-weight:600}
.res-bot{display:flex;flex-direction:column;align-items:center;margin-top:10px}
.res-bot .btn{position:relative;z-index:2;padding:12px 40px;font-size:17px}
</style>
</head>
<body>
<div id="W">

<!-- INTRO -->
<div class="scr" id="intro">
  <div class="intro-card">
    <h1 class="intro-title">Maestro del Mult√≠metro</h1>
    <img class="intro-av" id="intro-av" alt="Irina">
    <div class="intro-bub">Hoy vas a aprender a usar el mult√≠metro. Primero las partes, luego a medir.<br><br>Recuerda: <b>si la punta baila, la lectura miente.</b></div>
    <button class="btn" id="intro-btn">¬°Vamos!</button>
  </div>
</div>

<!-- FASE 1 -->
<div class="scr off" id="fase1">
  <div class="hud">
    <div class="hud-left">
      <div class="hud-phase">Fase 1</div>
      <div class="hud-round" id="hud-f1-progress">0/8</div>
    </div>
    <div class="hud-lives" id="hud-f1-lives"></div>
  </div>
  <div class="f1-inner">
    <div class="f1-diagram" id="f1-diagram">
      <div class="f1-img-wrap" id="f1-img-wrap">
        <img class="f1-diagram-img" id="f1-diagram-img" alt="Mult√≠metro">
      </div>
    </div>
    <div class="f1-tray" id="f1-tray"></div>
    <div class="f1-hint">
      <div class="f1-hint-text" id="f1-hint"></div>
    </div>
  </div>
</div>

<!-- PHASE TRANSITION -->
<div class="phase-transition" id="phase-trans">
  <img id="phase-trans-av" alt="Irina">
  <div class="msg" id="phase-trans-msg"></div>
  <div class="sub">Toca para continuar</div>
</div>

<!-- FASE 2 -->
<div class="scr off" id="fase2">
  <div class="hud">
    <div class="hud-left">
      <div class="hud-phase">Fase 2</div>
      <div class="hud-round" id="hud-f2-progress">1/3</div>
    </div>
    <div class="hud-lives" id="hud-f2-lives"></div>
  </div>
  <div class="f2-inner">
    <div class="f2-context">
      <div class="f2-context-text" id="f2-context"></div>
    </div>
    <div class="f2-scene" id="f2-scene">
      <img class="f2-scene-img" id="f2-scene-img" alt="Escenario" style="display:none">
      <div class="f2-display" id="f2-display" style="display:none">
        <div class="f2-display-val" id="f2-display-val">---</div>
      </div>
    </div>
    <div class="f2-step" id="f2-step-area">
      <div class="f2-step-label" id="f2-step-label"></div>
    </div>
    <div class="f2-options" id="f2-options"></div>
    <div class="f2-probes" id="f2-probes" style="display:none"></div>
    <div class="f2-jacks" id="f2-jacks" style="display:none"></div>
  </div>
  <div class="checklist-overlay" id="checklist-overlay">
    <div>
      <div class="checklist-card" id="checklist-card"></div>
    </div>
  </div>
  <div class="f2-feedback" id="f2-feedback">
    <div class="f2-fb-card" id="f2-fb-card"></div>
    <div class="f2-fb-tap">toca para continuar</div>
  </div>
</div>

<!-- RESULTS -->
<div class="scr off" id="results">
  <div class="res-inner">
    <div class="res-badge" id="res-badge" style="display:none"></div>
    <div class="res-scores">
      <div><div class="res-val" id="res-score">0</div><div class="res-label">Puntuaci√≥n</div></div>
      <div><div class="res-val" id="res-record" style="color:var(--lemon)">0</div><div class="res-label">R√©cord</div></div>
    </div>
    <div class="res-new" id="res-new">¬°NUEVO R√âCORD!</div>
    <img class="res-av" id="res-av" alt="Irina">
    <div class="res-info-card">
      <div class="res-msg" id="res-msg"></div>
      <div class="res-hits" id="res-hits"></div>
    </div>
    <div class="res-bot">
      <button class="btn" id="res-btn">¬°Otra ronda!</button>
    </div>
  </div>
</div>

<!-- Flash overlay -->
<div class="flash-overlay" id="flash-overlay"></div>

</div>
<script>
/* ========== ASSETS ========== */
const A={
  irina_happy:'https://res.cloudinary.com/kampe/image/upload/v1772110317/irina_happy_w2nu0c.png',
  irina_celebrating:'https://res.cloudinary.com/kampe/image/upload/v1772110324/irina_celebrating_nifggk.png',
  irina_worried:'https://res.cloudinary.com/kampe/image/upload/v1772110324/irina_worried_bx2nzg.png',
  multimetro:'https://res.cloudinary.com/kampe/image/upload/v1772117458/multimetro_frontal_jtf2pj.png',
  punta_roja:'https://res.cloudinary.com/kampe/image/upload/v1772110317/punta_roja_phbypc.png',
  punta_negra:'https://res.cloudinary.com/kampe/image/upload/v1772110317/punta_negra_nzrcta.png',
  escena_cable:'https://res.cloudinary.com/kampe/image/upload/v1772110316/escena_cable_ersdbw.png',
  escena_pila:'https://res.cloudinary.com/kampe/image/upload/v1772107948/escena_pila_nubvzx.png'
};

/* ========== FASE 1 DATA ========== */
/*
  Arrow markers: dot SOBRE la imagen + l√≠nea + drop zone fuera.
  side: 'left' = la drop zone queda a la izquierda, 'right' = a la derecha.
  anchorX/anchorY: posici√≥n del dot en % de la imagen.
  lineW: largo de la l√≠nea en px.
  Mapeado 1:1 con la maqueta del usuario (10 flechas).
*/
const LABELS=[
  /* === SALEN HACIA LA IZQUIERDA (3 flechas) === */
  {id:'vdc',       text:'VCD',               side:'left',  anchorX:12, anchorY:34, lineW:30, hint:'Tensi√≥n en corriente continua. Piensa en pilas.',           explain:'VCD = Voltaje Corriente Continua. Para medir pilas, bater√≠as, cargadores, paneles solares.'},
  {id:'selector',  text:'Selector de Rango', side:'left',  anchorX:50, anchorY:50, lineW:30, hint:'La rueda grande del centro. Ah√≠ eliges qu√© mides.',       explain:'El selector te permite elegir qu√© mides: tensi√≥n (V), resistencia (Œ©), continuidad, o corriente (A).'},
  {id:'adc',       text:'A‚éì (Corriente CC)', side:'left',  anchorX:12, anchorY:72, lineW:30, hint:'Corriente continua. Para medir amperios.',                explain:'A‚éì = Amperios en Corriente Continua. Para medir el consumo de un circuito. ¬°Siempre en serie!'},
  /* === SALEN HACIA LA DERECHA (5 flechas) === */
  {id:'display',   text:'Display',           side:'right', anchorX:78, anchorY:15, lineW:30, hint:'La pantalla de arriba. Donde lees el n√∫mero.',            explain:'El display muestra la lectura. Aqu√≠ ver√°s los n√∫meros, OL, o el s√≠mbolo de continuidad.'},
  {id:'vac',       text:'VAC',               side:'right', anchorX:83, anchorY:30, lineW:30, hint:'Tensi√≥n en corriente alterna. Piensa en enchufes.',       explain:'VAC = Voltaje Corriente Alterna. Para enchufes, cuadros el√©ctricos, instalaciones.'},
  {id:'ohm_der',   text:'Escala Ohmios',     side:'right', anchorX:89, anchorY:40, lineW:30, hint:'Los valores de la escala de ohmios.',                     explain:'Aqu√≠ ves los rangos de ohmios: 200, 2k, 20k, 200k, 2000k. Elige el rango adecuado al componente.'},
  {id:'vohma',     text:'VŒ©mA (roja)',       side:'right', anchorX:86, anchorY:82, lineW:30, hint:'Aqu√≠ va la punta roja. Mide tensi√≥n, resistencia y mA.', explain:'Aqu√≠ va la punta roja para medir tensi√≥n, resistencia, continuidad o corrientes peque√±as (mA). Cable ROJO siempre aqu√≠.'},
  {id:'com',       text:'COM (negra)',       side:'right', anchorX:85, anchorY:91, lineW:30, hint:'COM = com√∫n. Va siempre la punta negra.',                 explain:'COM = com√∫n. La punta negra SIEMPRE va aqu√≠. Es la referencia de todas las medidas. Cable NEGRO siempre aqu√≠.'}
];

/* ========== FASE 2 DATA ========== */
const SCENARIOS=[
  {
    id:'cont_ok',
    context:'Tienes un cable suelto. Quieres saber si conduce de punta a punta.',
    mode:'Continuidad',
    modeOptions:['Continuidad','VCD','VAC','OHM'],
    probeRed:'vohma', probeBlack:'com',
    scene:A.escena_cable,
    points:[
      {id:'A',label:'A',correct:true, pos:[8,45]},
      {id:'B',label:'B',correct:true, pos:[88,45]},
      {id:'C',label:'C',correct:false,pos:[50,45]}
    ],
    correctPoints:['A','B'],
    reading:'0.5Œ©',
    readingText:'Hay camino. El cable conduce.'
  },
  {
    id:'cont_fail',
    context:'Mismo cable. Ahora toca un punto que NO es conductor.',
    mode:'Continuidad',
    modeOptions:['Continuidad','VCD','VAC','OHM'],
    probeRed:'vohma', probeBlack:'com',
    scene:A.escena_cable,
    points:[
      {id:'A',label:'A',correct:true, pos:[8,45]},
      {id:'B',label:'B',correct:false,pos:[88,45]},
      {id:'C',label:'C',correct:true, pos:[50,45]}
    ],
    correctPoints:['A','C'],
    reading:'OL',
    readingText:'No hay camino. Normal: est√°s tocando aislante.'
  },
  {
    id:'voltage',
    context:'Una pila de 1,5V. Quieres comprobar si tiene carga.',
    mode:'VCD',
    modeOptions:['Continuidad','VCD','VAC','OHM'],
    probeRed:'vohma', probeBlack:'com',
    scene:A.escena_pila,
    points:[
      {id:'pos',label:'+',correct:true, pos:[50,10]},
      {id:'neg',label:'‚àí',correct:true, pos:[50,85]},
      {id:'body',label:'?',correct:false,pos:[50,50]}
    ],
    correctPoints:['pos','neg'],
    reading:'1.5V',
    readingText:'Pila con carga. Mides entre dos puntos y el n√∫mero tiene sentido.'
  }
];

const CHECKLIST=[
  '¬øEstoy en el MODO correcto?',
  '¬øPuntas bien puestas?',
  '¬øToco METAL, no aislante?',
  '¬øPuntos CORRECTOS?',
  'Repito con mejor contacto'
];

/* ========== CONSTANTS ========== */
const MAX_LIVES=5;
const TASK_THRESHOLD=500;
const TOTAL_LABELS=LABELS.length;
const TOTAL_SCENARIOS=SCENARIOS.length;

/* ========== STATE ========== */
let score=0,lives=MAX_LIVES;
let f1Placed=0,f1Errors={};
let f2Idx=0,f2Step=0,f2Errors=0,f2StartTime=0,f2SelectedPoints=[];
let f2ScenariosCompleted=0;
let record=parseInt(localStorage.getItem('maestro_multimetro_record'))||0;
let taskCompleted=false;

const $=id=>document.getElementById(id);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

/* ========== SCREENS ========== */
function showScreen(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.add('off'));
  $(id).classList.remove('off');
}

/* ========== LIVES ========== */
function renderLives(containerId){
  const c=$(containerId);
  c.innerHTML='';
  for(let i=0;i<MAX_LIVES;i++){
    const h=document.createElement('div');
    h.className='hud-heart'+(i>=lives?' lost':'');
    h.textContent='‚ù§Ô∏è';
    c.appendChild(h);
  }
}

function loseLife(){
  if(lives<=0)return;
  lives--;
  renderLives('hud-f1-lives');
  renderLives('hud-f2-lives');
  const fl=$('flash-overlay');
  fl.classList.remove('flash');
  void fl.offsetWidth;
  fl.classList.add('flash');
}

/* ========== INIT ========== */
function init(){
  $('intro-av').src=A.irina_happy;
  $('intro-btn').onclick=startGame;
  $('res-btn').onclick=startGame;
  showScreen('intro');
}

/* ========== START GAME ========== */
function startGame(){
  score=0;lives=MAX_LIVES;
  f1Placed=0;f1Errors={};
  f2Idx=0;f2ScenariosCompleted=0;
  taskCompleted=false;
  renderLives('hud-f1-lives');
  showScreen('fase1');
  initFase1();
}

/* ================================================================
   FASE 1 ‚Äî ARROW MARKERS + DRAG CHIPS
   ================================================================ */

function initFase1(){
  const img=$('f1-diagram-img');
  img.src=A.multimetro;
  $('hud-f1-progress').textContent='0/'+TOTAL_LABELS;
  $('f1-hint').classList.remove('show');
  $('f1-hint').textContent='';

  // Clear old markers
  const wrap=$('f1-img-wrap');
  wrap.querySelectorAll('.arrow-anchor').forEach(el=>el.remove());
  $('f1-diagram').querySelectorAll('.f1-tooltip').forEach(el=>el.remove());

  img.onload=()=>{
    createArrowMarkers();
    createTags();
  };
  if(img.complete&&img.naturalWidth>0){
    createArrowMarkers();
    createTags();
  }
}

function createArrowMarkers(){
  const wrap=$('f1-img-wrap');
  const diagram=$('f1-diagram');
  const img=$('f1-diagram-img');
  wrap.querySelectorAll('.arrow-anchor').forEach(el=>el.remove());

  // Sync wrap size to rendered image so % anchors align perfectly
  wrap.style.width=img.offsetWidth+'px';
  wrap.style.height=img.offsetHeight+'px';

  LABELS.forEach((lab)=>{
    // Anchor: positioned at anchorX%/anchorY% inside img-wrap (over the image)
    const anchor=document.createElement('div');
    anchor.className='arrow-anchor';
    anchor.style.top=lab.anchorY+'%';
    anchor.style.left=lab.anchorX+'%';

    // Marker: flex row with dot+line+drop, extends outward from anchor
    const marker=document.createElement('div');
    marker.className='arrow-marker '+lab.side;
    marker.dataset.id=lab.id;
    marker.dataset.explain=lab.explain;

    const dot=document.createElement('div');
    dot.className='arrow-dot';

    const line=document.createElement('div');
    line.className='arrow-line';
    line.style.width=lab.lineW+'px';

    const drop=document.createElement('div');
    drop.className='arrow-drop';
    drop.textContent='?';

    if(lab.side==='left'){
      // Marker extends LEFT from anchor: [drop][line][dot] ‚Üí dot at right edge
      marker.appendChild(drop);
      marker.appendChild(line);
      marker.appendChild(dot);
    }else{
      // Marker extends RIGHT from anchor: [dot][line][drop] ‚Üí dot at left edge
      marker.appendChild(dot);
      marker.appendChild(line);
      marker.appendChild(drop);
    }

    // Tap on filled marker to re-read explanation
    drop.addEventListener('click',(e)=>{
      if(marker.classList.contains('filled')){
        e.stopPropagation();
        showTooltip(drop,marker.dataset.explain,diagram);
      }
    });

    anchor.appendChild(marker);
    wrap.appendChild(anchor);
  });
}

function createTags(){
  const tray=$('f1-tray');
  tray.innerHTML='';
  const shuffled=shuffle([...LABELS]);
  shuffled.forEach(lab=>{
    const tag=document.createElement('div');
    tag.className='tag';
    tag.textContent=lab.text;
    tag.dataset.id=lab.id;
    setupTagDrag(tag,lab);
    tray.appendChild(tag);
  });
}

let f1TooltipTimer=null;
let f1ActiveTooltip=null;

function clearHovers(){
  document.querySelectorAll('.arrow-drop').forEach(n=>n.classList.remove('hover'));
}

function checkHover(x,y){
  document.querySelectorAll('.arrow-marker').forEach(m=>{
    if(m.classList.contains('filled'))return;
    const dropEl=m.querySelector('.arrow-drop');
    const r=dropEl.getBoundingClientRect();
    const pad=10;
    if(x>=r.left-pad&&x<=r.right+pad&&y>=r.top-pad&&y<=r.bottom+pad){
      dropEl.classList.add('hover');
    }else{
      dropEl.classList.remove('hover');
    }
  });
}

function showTooltip(targetEl,text,container){
  hideTooltip();
  const containerRect=container.getBoundingClientRect();
  const elRect=targetEl.getBoundingClientRect();

  const tooltip=document.createElement('div');
  tooltip.className='f1-tooltip';
  const box=document.createElement('div');
  box.className='f1-tooltip-box';
  box.textContent=text;

  const elCenterX=elRect.left+elRect.width/2-containerRect.left;
  const elTop=elRect.top-containerRect.top;
  const elBottom=elRect.bottom-containerRect.top;

  // Show tooltip above or below (no arrow)
  tooltip.appendChild(box);
  container.appendChild(tooltip);
  const ttW=tooltip.offsetWidth;
  let left=elCenterX-ttW/2;
  left=Math.max(4,Math.min(left,containerRect.width-ttW-4));
  tooltip.style.left=left+'px';
  if(elBottom>containerRect.height*0.6){
    tooltip.style.bottom=(containerRect.height-elTop+8)+'px';
  }else{
    tooltip.style.top=(elBottom-containerRect.top+8)+'px';
  }

  requestAnimationFrame(()=>tooltip.classList.add('show'));
  f1ActiveTooltip=tooltip;
  f1TooltipTimer=setTimeout(()=>hideTooltip(),4000);
}

function hideTooltip(){
  if(f1TooltipTimer){clearTimeout(f1TooltipTimer);f1TooltipTimer=null}
  if(f1ActiveTooltip){
    f1ActiveTooltip.classList.remove('show');
    const tt=f1ActiveTooltip;
    setTimeout(()=>{if(tt.parentNode)tt.remove()},300);
    f1ActiveTooltip=null;
  }
}

function setupTagDrag(tag,lab){
  let ox,oy,clone,isDragging=false;

  const onStart=(e)=>{
    if(tag.classList.contains('placed'))return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    const r=tag.getBoundingClientRect();
    ox=t.clientX-r.left;oy=t.clientY-r.top;

    clone=tag.cloneNode(true);
    clone.className='tag dragging';
    clone.style.width=r.width+'px';
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    document.body.appendChild(clone);
    tag.style.opacity='.3';
    isDragging=true;

    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('touchend',onEnd);
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onEnd);
  };

  const onMove=(e)=>{
    if(!isDragging)return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    checkHover(t.clientX,t.clientY);
  };

  const onEnd=(e)=>{
    if(!isDragging)return;
    isDragging=false;
    document.removeEventListener('touchmove',onMove);
    document.removeEventListener('touchend',onEnd);
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onEnd);
    clearHovers();

    const t=e.changedTouches?e.changedTouches[0]:e;
    const dropX=t.clientX,dropY=t.clientY;

    if(clone.parentNode)clone.remove();
    tag.style.opacity='';

    // Check if dropped on any arrow marker's drop zone
    const markers=document.querySelectorAll('.arrow-marker');
    markers.forEach(marker=>{
      if(marker.classList.contains('filled'))return;
      const dropEl=marker.querySelector('.arrow-drop');
      const r=dropEl.getBoundingClientRect();
      const pad=10;
      if(dropX>=r.left-pad&&dropX<=r.right+pad&&dropY>=r.top-pad&&dropY<=r.bottom+pad){
        if(marker.dataset.id===lab.id){
          // CORRECT
          marker.classList.add('filled');
          dropEl.textContent=lab.text;
          tag.classList.add('placed');
          f1Placed++;
          if(!f1Errors[lab.id]){score+=60}else{score+=50}
          $('hud-f1-progress').textContent=f1Placed+'/'+TOTAL_LABELS;
          $('f1-hint').classList.remove('show');
          showTooltip(dropEl,lab.explain,$('f1-diagram'));

          if(f1Placed>=TOTAL_LABELS){
            setTimeout(()=>showPhaseTransition(),2500);
          }
        }else{
          // WRONG marker
          f1Errors[lab.id]=true;
          loseLife();
          tag.classList.add('shaking');
          setTimeout(()=>tag.classList.remove('shaking'),350);
          $('f1-hint').textContent=lab.hint;
          $('f1-hint').classList.add('show');
          setTimeout(()=>$('f1-hint').classList.remove('show'),3000);

          if(lives<=0){setTimeout(()=>showResults(),600)}
        }
      }
    });
  };

  tag.addEventListener('touchstart',onStart,{passive:false});
  tag.addEventListener('mousedown',onStart);
}

/* ========== PHASE TRANSITION ========== */
function showPhaseTransition(){
  hideTooltip();
  const pt=$('phase-trans');
  $('phase-trans-av').src=A.irina_celebrating;
  $('phase-trans-msg').textContent='¬°Ya conoces la herramienta!\nAhora vamos a medir.';
  pt.classList.add('show');

  const handler=()=>{
    pt.removeEventListener('click',handler);
    pt.classList.remove('show');
    startFase2();
  };
  setTimeout(()=>pt.addEventListener('click',handler),400);
  setTimeout(()=>{
    if(pt.classList.contains('show')){
      pt.removeEventListener('click',handler);
      pt.classList.remove('show');
      startFase2();
    }
  },3000);
}

/* ================================================================
   FASE 2 ‚Äî MEASUREMENT SCENARIOS
   ================================================================ */

function startFase2(){
  f2Idx=0;
  renderLives('hud-f2-lives');
  showScreen('fase2');
  loadScenario();
}

function loadScenario(){
  if(f2Idx>=TOTAL_SCENARIOS||lives<=0){showResults();return}

  const sc=SCENARIOS[f2Idx];
  f2Step=1;
  f2Errors=0;
  f2StartTime=Date.now();
  f2SelectedPoints=[];

  $('hud-f2-progress').textContent=(f2Idx+1)+'/'+TOTAL_SCENARIOS;
  renderLives('hud-f2-lives');
  $('f2-context').textContent=sc.context;

  $('checklist-overlay').classList.remove('show');
  $('f2-feedback').classList.remove('show');
  $('f2-display').style.display='none';

  const sceneDiv=$('f2-scene');
  sceneDiv.querySelectorAll('.f2-touch-point').forEach(p=>p.remove());
  const s2=document.getElementById('f2-step2-ui');if(s2)s2.remove();
  const s3=document.getElementById('f2-step3-ui');if(s3)s3.remove();
  showStep1(sc);
}

/* ---- STEP 1: Choose mode ---- */
function showStep1(sc){
  $('f2-step-label').textContent='Paso 1: Elige el modo correcto';
  $('f2-step-area').style.display='';
  $('f2-probes').style.display='none';
  $('f2-jacks').style.display='none';
  $('f2-display').style.display='none';

  // Clean up any leftover touch points
  $('f2-scene').querySelectorAll('.f2-touch-point').forEach(p=>p.remove());

  // Show the scenario scene (cable/pila) so user sees what they'll measure
  const sceneImg=$('f2-scene-img');
  sceneImg.src=sc.scene;
  sceneImg.style.display='block';
  sceneImg.style.maxHeight='';

  const opts=$('f2-options');
  opts.innerHTML='';
  opts.style.display='flex';
  const shuffledModes=shuffle([...sc.modeOptions]);
  shuffledModes.forEach(mode=>{
    const btn=document.createElement('div');
    btn.className='f2-opt';
    btn.textContent=mode;
    btn.onclick=()=>handleStep1(btn,mode,sc);
    opts.appendChild(btn);
  });
}

function handleStep1(btn,mode,sc){
  if(f2Step!==1)return;
  if(mode===sc.mode){
    btn.classList.add('correct');
    f2Step=2;
    setTimeout(()=>showStep2(sc),500);
  }else{
    btn.classList.add('wrong');
    f2Errors++;
    loseLife();
    showChecklist(0);
    setTimeout(()=>btn.classList.remove('wrong'),600);
    if(lives<=0)setTimeout(()=>showResults(),800);
  }
}

/* ---- STEP 2: Drag probes to jacks on the multimeter ---- */

function showStep2(sc){
  $('f2-options').style.display='none';
  $('f2-options').innerHTML='';
  $('f2-step-area').style.display='';
  $('f2-step-label').textContent='Paso 2: Conecta cada punta a su casquillo';

  // Build the multimeter + probes layout inside scene area
  const sceneDiv=$('f2-scene');
  sceneDiv.querySelectorAll('.f2-touch-point').forEach(p=>p.remove());
  $('f2-scene-img').style.display='none';

  // Container
  const ct=document.createElement('div');
  ct.id='f2-step2-ui';
  ct.style.cssText='display:flex;flex-direction:column;align-items:center;gap:16px;width:100%';

  // Multimeter with drop zones
  const multiWrap=document.createElement('div');
  multiWrap.style.cssText='position:relative;display:inline-block';

  const multiImg=document.createElement('img');
  multiImg.src=A.multimetro;
  multiImg.style.cssText='display:block;height:260px;width:auto;border-radius:14px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.4))';

  // Drop zones (positioned over the casquillos on the image)
  // COM = center-right ~85%x, 91%y  |  VŒ©mA = right ~86%x, 82%y  |  10A = ~60%x, 79%y
  const drops=[
    {id:'com',  label:'COM',  x:70, y:90, correct:'black'},
    {id:'vohma',label:'VŒ©mA', x:55, y:82, correct:'red'},
    {id:'10a',  label:'10A',  x:42, y:79, correct:null}
  ];

  multiWrap.appendChild(multiImg);

  const dropEls={};
  drops.forEach(d=>{
    const el=document.createElement('div');
    el.className='f2-jack-drop';
    el.dataset.jack=d.id;
    el.dataset.correctProbe=d.correct||'';
    el.style.cssText='position:absolute;width:36px;height:36px;border-radius:50%;border:2px dashed rgba(0,230,188,.5);background:rgba(0,230,188,.08);top:'+d.y+'%;left:'+d.x+'%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:rgba(0,230,188,.6);transition:all .3s;z-index:5';
    el.textContent=d.label;
    multiWrap.appendChild(el);
    dropEls[d.id]=el;
  });

  // Probes (draggable)
  const probesRow=document.createElement('div');
  probesRow.style.cssText='display:flex;justify-content:center;gap:40px;padding:4px 0';

  const probeData=[
    {id:'black',img:A.punta_negra,correct:'com',label:'Punta NEGRA',color:'#bbb'},
    {id:'red',img:A.punta_roja,correct:'vohma',label:'Punta ROJA',color:'#e74c3c'}
  ];

  let placedCount=0;

  probeData.forEach(p=>{
    const wrap=document.createElement('div');
    wrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:4px';
    const img=document.createElement('img');
    img.style.cssText='width:80px;height:auto;cursor:grab;touch-action:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.5))';
    img.src=p.img;
    img.dataset.probeId=p.id;
    const lbl=document.createElement('div');
    lbl.style.cssText='color:'+p.color+';font-size:11px;font-weight:800';
    lbl.textContent=p.label;
    wrap.appendChild(img);
    wrap.appendChild(lbl);

    // Drag logic
    setupGenericDrag(img,{
      onDrop:(dropX,dropY)=>{
        let hit=false;
        Object.values(dropEls).forEach(dropEl=>{
          const r=dropEl.getBoundingClientRect();
          const pad=20;
          if(dropX>=r.left-pad&&dropX<=r.right+pad&&dropY>=r.top-pad&&dropY<=r.bottom+pad){
            if(dropEl.dataset.jack===p.correct){
              // Correct jack
              dropEl.style.borderColor='var(--lime)';
              dropEl.style.background='rgba(4,255,180,.25)';
              dropEl.style.borderStyle='solid';
              dropEl.textContent='';
              // Show small probe image on the jack
              const placed=document.createElement('img');
              placed.src=p.img;
              placed.style.cssText='width:28px;height:auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;filter:drop-shadow(0 1px 4px rgba(0,0,0,.4))';
              dropEl.appendChild(placed);
              img.style.opacity='.3';
              img.style.pointerEvents='none';
              placedCount++;
              hit=true;
              if(placedCount>=2){
                f2Step=3;
                setTimeout(()=>showStep3(sc),600);
              }
            }else{
              // Wrong jack
              f2Errors++;
              loseLife();
              dropEl.style.borderColor='var(--fire)';
              dropEl.style.background='rgba(231,76,60,.2)';
              setTimeout(()=>{
                dropEl.style.borderColor='rgba(0,230,188,.5)';
                dropEl.style.background='rgba(0,230,188,.08)';
              },600);
              showChecklist(1);
              hit=true;
              if(lives<=0)setTimeout(()=>showResults(),800);
            }
          }
        });
      }
    });

    probesRow.appendChild(wrap);
  });

  ct.appendChild(multiWrap);
  ct.appendChild(probesRow);
  sceneDiv.appendChild(ct);
}

/* ---- STEP 3: Drag scene to the probes (measure) ---- */

function showStep3(sc){
  $('f2-step-label').textContent='Paso 3: Arrastra el objeto a las puntas para medir';
  $('f2-options').style.display='none';

  const sceneDiv=$('f2-scene');
  // Clean step 2 UI
  const s2=document.getElementById('f2-step2-ui');
  if(s2)s2.remove();

  // Build: multimeter with probes on top, draggable scene below
  const ct=document.createElement('div');
  ct.id='f2-step3-ui';
  ct.style.cssText='display:flex;flex-direction:column;align-items:center;gap:12px;width:100%';

  // Multimeter with probes attached (composed via CSS)
  const multiWrap=document.createElement('div');
  multiWrap.style.cssText='position:relative;display:inline-block';

  const multiImg=document.createElement('img');
  multiImg.src=A.multimetro;
  multiImg.style.cssText='display:block;height:180px;width:auto;border-radius:14px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.4))';
  multiWrap.appendChild(multiImg);

  // Probes hanging from the multimeter (visual only)
  const blackProbe=document.createElement('img');
  blackProbe.src=A.punta_negra;
  blackProbe.style.cssText='position:absolute;width:50px;height:auto;bottom:-30px;left:15%;transform:rotate(15deg);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4));pointer-events:none';
  multiWrap.appendChild(blackProbe);

  const redProbe=document.createElement('img');
  redProbe.src=A.punta_roja;
  redProbe.style.cssText='position:absolute;width:50px;height:auto;bottom:-30px;right:15%;transform:rotate(-15deg);filter:drop-shadow(0 2px 6px rgba(0,0,0,.4));pointer-events:none';
  multiWrap.appendChild(redProbe);

  // Drop zone (where the scene should be dragged to = between the probe tips)
  const dropZone=document.createElement('div');
  dropZone.id='f2-measure-zone';
  dropZone.style.cssText='position:absolute;bottom:-50px;left:50%;transform:translateX(-50%);width:80px;height:50px;border:2px dashed rgba(0,230,188,.4);border-radius:12px;background:rgba(0,230,188,.05);z-index:6;display:flex;align-items:center;justify-content:center;font-size:9px;color:rgba(0,230,188,.5);font-weight:700';
  dropZone.textContent='MEDIR';
  multiWrap.appendChild(dropZone);

  // Draggable scene image
  const sceneWrap=document.createElement('div');
  sceneWrap.style.cssText='display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:20px';
  const sceneImg=document.createElement('img');
  sceneImg.src=sc.scene;
  sceneImg.style.cssText='width:140px;height:auto;border-radius:12px;cursor:grab;touch-action:none;filter:drop-shadow(0 3px 12px rgba(0,0,0,.5));border:2px solid rgba(0,230,188,.3)';
  const sceneLbl=document.createElement('div');
  sceneLbl.style.cssText='color:rgba(255,255,255,.5);font-size:11px;font-weight:700';
  sceneLbl.textContent='arrastra arriba para medir';
  sceneWrap.appendChild(sceneImg);
  sceneWrap.appendChild(sceneLbl);

  ct.appendChild(multiWrap);
  ct.appendChild(sceneWrap);
  sceneDiv.appendChild(ct);

  // Hide the default scene img
  $('f2-scene-img').style.display='none';

  f2SelectedPoints=[];

  // Drag the scene to the drop zone
  setupGenericDrag(sceneImg,{
    onDrop:(dropX,dropY)=>{
      const r=dropZone.getBoundingClientRect();
      const pad=25;
      if(dropX>=r.left-pad&&dropX<=r.right+pad&&dropY>=r.top-pad&&dropY<=r.bottom+pad){
        // Correct ‚Äî measuring!
        f2Step=0;
        sceneImg.style.opacity='.4';
        sceneImg.style.pointerEvents='none';
        dropZone.style.borderColor='var(--lime)';
        dropZone.style.background='rgba(4,255,180,.2)';
        dropZone.style.borderStyle='solid';
        dropZone.textContent='';
        // Show mini scene in drop zone
        const mini=document.createElement('img');
        mini.src=sc.scene;
        mini.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:10px;opacity:.7';
        dropZone.appendChild(mini);
        setTimeout(()=>showF2Success(sc),600);
      }
    }
  });
}

/* ---- Generic drag helper ---- */
function setupGenericDrag(el,opts){
  let ox,oy,clone,isDragging=false;

  const onStart=(e)=>{
    if(el.style.pointerEvents==='none')return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    const r=el.getBoundingClientRect();
    ox=t.clientX-r.left;oy=t.clientY-r.top;

    clone=el.cloneNode(true);
    clone.style.cssText=el.style.cssText+';position:fixed;z-index:200;pointer-events:none;opacity:.8;width:'+r.width+'px;height:'+r.height+'px';
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
    document.body.appendChild(clone);
    el.style.opacity='.3';
    isDragging=true;

    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('touchend',onEnd);
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onEnd);
  };

  const onMove=(e)=>{
    if(!isDragging)return;
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    clone.style.left=(t.clientX-ox)+'px';
    clone.style.top=(t.clientY-oy)+'px';
  };

  const onEnd=(e)=>{
    if(!isDragging)return;
    isDragging=false;
    document.removeEventListener('touchmove',onMove);
    document.removeEventListener('touchend',onEnd);
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onEnd);

    const t=e.changedTouches?e.changedTouches[0]:e;
    if(clone.parentNode)clone.remove();
    el.style.opacity='';
    if(opts.onDrop)opts.onDrop(t.clientX,t.clientY);
  };

  el.addEventListener('touchstart',onStart,{passive:false});
  el.addEventListener('mousedown',onStart);
}

/* ---- Checklist ---- */
function showChecklist(highlightIdx){
  const overlay=$('checklist-overlay');
  const card=$('checklist-card');
  card.innerHTML='<div class="checklist-title">üìã Checklist de medici√≥n</div>';
  CHECKLIST.forEach((item,i)=>{
    const row=document.createElement('div');
    row.className='checklist-item'+(i===highlightIdx?' highlight':'');
    row.innerHTML='<div class="num">'+(i+1)+'</div><span>'+item+'</span>';
    card.appendChild(row);
  });
  const quote=document.createElement('div');
  quote.className='checklist-quote';
  quote.textContent='"Si la punta baila, la lectura miente."';
  card.appendChild(quote);
  const tap=document.createElement('div');
  tap.className='checklist-tap';
  tap.textContent='toca para continuar';
  card.appendChild(tap);

  overlay.classList.add('show');
  const handler=()=>{
    overlay.removeEventListener('click',handler);
    overlay.classList.remove('show');
  };
  setTimeout(()=>overlay.addEventListener('click',handler),300);
}

/* ---- F2 Success ---- */
function showF2Success(sc){
  const elapsed=(Date.now()-f2StartTime)/1000;
  let pts=100;
  if(f2Errors===0)pts+=25;
  if(elapsed<15)pts+=25;
  score+=pts;
  f2ScenariosCompleted++;

  const fb=$('f2-feedback');
  const card=$('f2-fb-card');
  card.innerHTML='';

  const disp=document.createElement('div');
  disp.className='f2-fb-display';
  disp.innerHTML='<span>'+sc.reading+'</span>';
  card.appendChild(disp);

  const txt=document.createElement('div');
  txt.className='f2-fb-text';
  txt.textContent=sc.readingText;
  card.appendChild(txt);

  fb.classList.add('show');

  const handler=()=>{
    fb.removeEventListener('click',handler);
    fb.classList.remove('show');
    f2Idx++;
    loadScenario();
  };
  setTimeout(()=>fb.addEventListener('click',handler),400);
  setTimeout(()=>{
    if(fb.classList.contains('show')){
      fb.removeEventListener('click',handler);
      fb.classList.remove('show');
      f2Idx++;
      loadScenario();
    }
  },4000);
}

/* ================================================================
   RESULTS
   ================================================================ */
function showResults(){
  showScreen('results');
  $('res-score').textContent=score;
  const isNew=score>record;
  if(isNew){record=score;localStorage.setItem('maestro_multimetro_record',record)}
  $('res-record').textContent=record;
  $('res-new').classList.toggle('show',isNew);

  $('res-hits').textContent='üè∑Ô∏è '+f1Placed+'/'+TOTAL_LABELS+' etiquetas ¬∑ üîå '+f2ScenariosCompleted+'/'+TOTAL_SCENARIOS+' mediciones';

  const badge=$('res-badge');
  if(score>=850){
    badge.textContent='¬°MAESTRO DEL MULT√çMETRO!';
    badge.style.display='block';
    $('res-av').src=A.irina_celebrating;
    $('res-msg').textContent='Dominas el mult√≠metro. Ahora a medir en real con supervisi√≥n.';
  }else if(score>=500){
    badge.textContent='¬°APROBADO!';
    badge.style.display='block';
    $('res-av').src=A.irina_happy;
    $('res-msg').textContent='Bien, pero repasa los pasos que fallaste.';
  }else{
    badge.style.display='none';
    $('res-av').src=A.irina_worried;
    $('res-msg').textContent='Necesitas practicar m√°s. Recuerda: modo, puntas, contacto, puntos.';
  }

  if(score>=TASK_THRESHOLD&&!taskCompleted){
    taskCompleted=true;
    try{window.ReactNativeWebView.postMessage(JSON.stringify({action:'TASK_COMPLETED'}))}catch(e){}
  }
}

/* ========== BOOT ========== */
init();
</script>
</body>
</html>
